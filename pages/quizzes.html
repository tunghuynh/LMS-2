<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Management - LMS</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Configuration -->
    <script src="../config.js"></script>
</head>
<body>
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="flex-between">
                <div>
                    <h1 class="page-title" data-translate="quiz.management">Quiz Management</h1>
                    <p class="page-subtitle" data-translate="quiz.subtitle">Create, manage and track quizzes for your courses</p>
                </div>
                <div class="flex flex-gap-3">
                    <button class="btn btn--secondary" onclick="importQuiz()">
                        <i class="fas fa-upload" class="icon-mr"></i>
                        <span data-translate="quiz.import">Import Quiz</span>
                    </button>
                    <button class="btn btn--secondary" onclick="exportQuizzes()">
                        <i class="fas fa-download" class="icon-mr"></i>
                        <span data-translate="quiz.export">Export All</span>
                    </button>
                    <button class="btn btn--secondary" onclick="openImportModal()">
                        <i class="fas fa-file-excel" class="icon-mr"></i>
                        <span data-translate="quiz.importExcel">Import Excel</span>
                    </button>
                    <button class="btn btn--primary" onclick="createQuiz()">
                        <i class="fas fa-plus-circle" class="icon-mr"></i>
                        <span data-translate="quiz.create">Create Quiz</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="page-content">
            <!-- Statistics Cards -->
            <div class="grid grid--4-cols" class="mb-6">
                <div class="card">
                    <div class="card__body" class="text-center">
                        <div class="text-2xl font-bold text-primary" id="totalQuizzes">0</div>
                        <div class="text-secondary" data-translate="quiz.totalQuizzes">Total Quizzes</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card__body" class="text-center">
                        <div class="text-2xl font-bold text-success" id="activeQuizzes">0</div>
                        <div class="text-secondary" data-translate="quiz.activeQuizzes">Active Quizzes</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card__body" class="text-center">
                        <div class="text-2xl font-bold text-warning" id="draftQuizzes">0</div>
                        <div class="text-secondary" data-translate="quiz.draftQuizzes">Draft Quizzes</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card__body" class="text-center">
                        <div class="text-2xl font-bold text-info" id="totalAttempts">0</div>
                        <div class="text-secondary" data-translate="quiz.totalAttempts">Total Attempts</div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card" class="mb-6">
                <div class="card__body">
                    <div class="grid grid-2fr-1fr-1fr-auto grid-gap-4 items-end">
                        <div class="input-group">
                            <label class="input-group__label" data-translate="common.search">Search</label>
                            <input type="text" id="searchInput" class="input" 
                                   placeholder="Search quizzes by title, description..."
                                   data-translate-placeholder="quiz.searchPlaceholder"
                                   onkeyup="filterQuizzes()">
                        </div>
                        <div class="input-group">
                            <label class="input-group__label" data-translate="course.selectCourse">Course</label>
                            <div class="dropdown dropdown--block" id="courseFilterDropdown">
                                <button class="dropdown__trigger">
                                    <span data-translate="common.allCourses">All Courses</span>
                                    <span class="dropdown__arrow"></span>
                                </button>
                                <div class="dropdown__menu">
                                    <div class="dropdown__list" id="courseFilterList">
                                        <!-- Course options will be populated dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="input-group__label" data-translate="common.status">Status</label>
                            <div class="dropdown dropdown--block" id="statusFilterDropdown">
                                <button class="dropdown__trigger">
                                    <span data-translate="common.allStatuses">All Statuses</span>
                                    <span class="dropdown__arrow"></span>
                                </button>
                                <div class="dropdown__menu">
                                    <div class="dropdown__list">
                                        <div class="dropdown__item" data-value="" data-translate="common.allStatuses">All Statuses</div>
                                        <div class="dropdown__item" data-value="draft" data-translate="status.draft">Draft</div>
                                        <div class="dropdown__item" data-value="active" data-translate="status.active">Active</div>
                                        <div class="dropdown__item" data-value="archived" data-translate="status.archived">Archived</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn--secondary" onclick="refreshData()">
                            <i class="fas fa-sync-alt" class="icon-mr"></i>
                            <span data-translate="common.refresh">Refresh</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quiz Table -->
            <div class="card">
                <div class="card__header">
                    <h3 data-translate="quiz.quizList">Quiz List</h3>
                </div>
                <div class="card__body">
                    <!-- Table Container -->
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th data-translate="quiz.title">Quiz Title</th>
                                    <th data-translate="course.title">Course</th>
                                    <th data-translate="quiz.questions">Questions</th>
                                    <th data-translate="quiz.timeLimit">Time Limit</th>
                                    <th data-translate="quiz.attempts">Attempts</th>
                                    <th data-translate="common.status">Status</th>
                                    <th data-translate="quiz.createdDate">Created</th>
                                    <th width="150" data-translate="common.actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quizTableBody">
                                <!-- Dynamic quiz rows -->
                            </tbody>
                        </table>
                        
                        <!-- Empty State -->
                        <div id="emptyState" class="empty-state" class="hidden">
                            <i class="fas fa-question-circle" class="text-48 text-muted mb-3"></i>
                            <p data-translate="quiz.noQuizzes">No quizzes found</p>
                            <button class="btn btn--primary" onclick="createQuiz()">
                                <i class="fas fa-plus" class="icon-mr"></i>
                                <span data-translate="quiz.createFirst">Create Your First Quiz</span>
                            </button>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="flex flex-between mt-4">
                        <div class="text-secondary">
                            <span data-translate="pagination.showing">Showing</span>
                            <span id="startRow">1</span> - <span id="endRow">10</span>
                            <span data-translate="pagination.of">of</span>
                            <span id="totalRows">0</span>
                        </div>
                        <div id="paginationControls" class="table__pagination">
                            <!-- Dynamic pagination -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Quiz Modal -->
    <div class="modal-backdrop" id="importModalBackdrop">
        <div class="modal modal--medium" id="importModal">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.importTitle">Import Quiz</h2>
                <button class="modal__close" onclick="closeImportModal()">×</button>
            </div>
            <div class="modal__body">
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.importFile">Select Quiz File</label>
                    <input type="file" id="importFile" class="input" accept=".json,.xlsx,.csv">
                    <span class="input-group__help" data-translate="quiz.importHelp">Supported formats: JSON, Excel (.xlsx), CSV</span>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="course.selectCourse">Target Course</label>
                    <div class="dropdown dropdown--block" id="importCourseDropdown">
                        <button class="dropdown__trigger">
                            <span data-translate="common.selectOption">Select a course...</span>
                            <span class="dropdown__arrow"></span>
                        </button>
                        <div class="dropdown__menu">
                            <div class="dropdown__list" id="importCourseList">
                                <!-- Course options will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="overwriteExisting">
                        <span class="checkbox-custom"></span>
                        <span data-translate="quiz.overwriteExisting">Overwrite existing quizzes with same name</span>
                    </label>
                </div>

                <div id="importPreview" class="hidden mt-4">
                    <h4 data-translate="quiz.importPreview">Import Preview</h4>
                    <div id="importPreviewContent" class="bg-secondary p-4 rounded-md">
                        <!-- Dynamic preview content -->
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeImportModal()">
                    <i class="fas fa-times" class="icon-mr"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button class="btn btn--primary" onclick="executeImport()" id="importBtn" disabled>
                    <i class="fas fa-upload" class="icon-mr"></i>
                    <span data-translate="quiz.import">Import Quiz</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Detail Modal -->
    <div class="modal-backdrop" id="detailModalBackdrop">
        <div class="modal modal--large" id="detailModal">
            <div class="modal__header">
                <h2 class="modal__title" id="detailModalTitle">Quiz Details</h2>
                <button class="modal__close" onclick="closeDetailModal()">×</button>
            </div>
            <div class="modal__body" id="detailModalContent">
                <!-- Dynamic detail content -->
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeDetailModal()">
                    <i class="fas fa-times" class="icon-mr"></i>
                    <span data-translate="common.close">Close</span>
                </button>
                <div id="detailModalActions" class="flex flex-gap-2">
                    <!-- Dynamic action buttons -->
                </div>
            </div>
        </div>
    </div>

    <!-- Import Excel Modal -->
    <div class="modal__backdrop" id="importModalBackdrop" onclick="closeImportModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2 data-translate="quiz.importExcel">Import Quiz from Excel</h2>
                <button class="modal__close" onclick="closeImportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal__body">
                <!-- Step 1: Download Template -->
                <div class="import-step">
                    <h3>
                        <span class="step-number">1</span>
                        <span data-translate="quiz.downloadTemplate">Download Template</span>
                    </h3>
                    <p data-translate="quiz.downloadTemplateDesc">Download our Excel template with the correct format for quiz questions.</p>
                    <button class="button button--secondary" onclick="downloadTemplate()">
                        <i class="fas fa-download"></i>
                        <span data-translate="quiz.downloadExcelTemplate">Download Excel Template</span>
                    </button>
                </div>

                <!-- Step 2: Upload File -->
                <div class="import-step">
                    <h3>
                        <span class="step-number">2</span>
                        <span data-translate="quiz.uploadFile">Upload Your File</span>
                    </h3>
                    <p data-translate="quiz.uploadFileDesc">Fill the template with your questions and upload it here.</p>
                    
                    <div class="upload upload--dropzone" id="excelUploadArea">
                        <input type="file" id="excelFileInput" class="upload__input" accept=".xlsx,.xls">
                        <label for="excelFileInput" class="upload__dropzone">
                            <i class="fas fa-file-excel upload__icon"></i>
                            <span class="upload__text">
                                <span data-translate="quiz.dragDropExcel">Drag and drop Excel file here or</span>
                                <span class="upload__link" data-translate="quiz.browse">browse</span>
                            </span>
                            <span class="upload__hint" data-translate="quiz.acceptedFormats">Accepts: .xlsx, .xls</span>
                        </label>
                    </div>
                    
                    <div id="uploadedFileInfo" class="uploaded-file-info" style="display: none;">
                        <i class="fas fa-file-excel"></i>
                        <span class="filename"></span>
                        <button class="button button--ghost button--small" onclick="removeUploadedFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Preview -->
                <div class="import-step" id="previewStep" style="display: none;">
                    <h3>
                        <span class="step-number">3</span>
                        <span data-translate="quiz.preview">Preview Import</span>
                    </h3>
                    <div class="import-summary">
                        <div class="summary-item">
                            <span data-translate="quiz.quizTitle">Quiz Title:</span>
                            <strong id="previewTitle">-</strong>
                        </div>
                        <div class="summary-item">
                            <span data-translate="quiz.totalQuestions">Total Questions:</span>
                            <strong id="previewQuestionCount">0</strong>
                        </div>
                        <div class="summary-item">
                            <span data-translate="quiz.validQuestions">Valid Questions:</span>
                            <strong id="previewValidCount" class="text-success">0</strong>
                        </div>
                        <div class="summary-item">
                            <span data-translate="quiz.errors">Errors:</span>
                            <strong id="previewErrorCount" class="text-danger">0</strong>
                        </div>
                    </div>
                    
                    <div id="importErrors" class="import-errors" style="display: none;">
                        <h4 data-translate="quiz.importErrors">Import Errors:</h4>
                        <ul id="errorList"></ul>
                    </div>
                    
                    <div id="previewQuestions" class="preview-questions">
                        <!-- Questions preview will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="button button--ghost" onclick="closeImportModal()">
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button class="button button--primary" id="importButton" onclick="performImport()" disabled>
                    <i class="fas fa-upload"></i>
                    <span data-translate="quiz.import">Import Quiz</span>
                </button>
            </div>
        </div>
    </div>

    <style>
        .import-step {
            margin-bottom: var(--spacing-6);
            padding: var(--spacing-4);
            background-color: var(--bg-base);
            border-radius: var(--radius-base);
            border: 1px solid var(--border-color);
        }
        
        .import-step h3 {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-3);
        }
        
        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background-color: var(--color-primary);
            color: white;
            border-radius: 50%;
            font-size: var(--font-size-sm);
            font-weight: 600;
        }
        
        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            padding: var(--spacing-3);
            background-color: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-base);
            margin-top: var(--spacing-3);
        }
        
        .uploaded-file-info i {
            color: var(--color-success);
            font-size: 1.5rem;
        }
        
        .uploaded-file-info .filename {
            flex: 1;
            font-weight: 500;
        }
        
        .import-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-2);
            background-color: var(--bg-surface);
            border-radius: var(--radius-sm);
        }
        
        .import-errors {
            background-color: var(--color-danger-lighter);
            border: 1px solid var(--color-danger);
            border-radius: var(--radius-base);
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .import-errors h4 {
            color: var(--color-danger);
            margin-bottom: var(--spacing-2);
        }
        
        .import-errors ul {
            margin: 0;
            padding-left: var(--spacing-4);
        }
        
        .preview-questions {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-base);
            padding: var(--spacing-3);
        }
        
        .preview-question {
            padding: var(--spacing-3);
            margin-bottom: var(--spacing-3);
            background-color: var(--bg-base);
            border-radius: var(--radius-base);
        }
        
        .preview-question:last-child {
            margin-bottom: 0;
        }
        
        .preview-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-2);
        }
        
        .preview-question-number {
            font-weight: 600;
            color: var(--color-primary);
        }
        
        .preview-question-type {
            font-size: var(--font-size-sm);
            padding: var(--spacing-1) var(--spacing-2);
            background-color: var(--bg-surface);
            border-radius: var(--radius-sm);
        }
        
        .preview-question-text {
            margin-bottom: var(--spacing-2);
        }
        
        .preview-question-options {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .text-success {
            color: var(--color-success);
        }
        
        .text-danger {
            color: var(--color-danger);
        }
    </style>

    <!-- Core JavaScript -->
    <script src="../assets/js/global.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    
    <script>
        // State management
        let allQuizzes = [];
        let allCourses = [];
        let filteredQuizzes = [];
        let currentUser = null;
        let currentPage = 1;
        const rowsPerPage = 10;

        // Initialize
        async function init() {
            // Ensure auth is loaded first
            if (!LMS.Auth.currentUser) {
                LMS.Auth.loadSession();
            }
            
            // Get current user after auth is ready
            currentUser = LMS.Auth.getUser();
            
            // Check authentication - teachers and admins only
            if (!LMS.Auth.isAuthenticated() || !currentUser || 
                (currentUser.role !== 'teacher' && currentUser.role !== 'admin')) {
                window.location.href = '../index.html';
                return;
            }

            // Load translations
            await LMS.LanguageManager.init();
            LMS.LanguageManager.updateUI();
            
            // Load data
            await loadData();
            populateCourseFilters();
            updateStatistics();
            displayQuizzes();
        }

        // Load all data
        async function loadData() {
            try {
                // Load courses
                const courseResponse = await LMS.API.loadJSON('mock-courses.json');
                allCourses = courseResponse.data || [];

                // Generate mock quizzes (since we don't have quiz data yet)
                allQuizzes = generateMockQuizzes();
                
                // Filter by user role
                if (currentUser.role === 'teacher') {
                    // Teachers only see quizzes for their courses
                    const teacherCourses = allCourses.filter(c => c.teacherId === currentUser.id);
                    const teacherCourseIds = teacherCourses.map(c => c.id);
                    allQuizzes = allQuizzes.filter(q => teacherCourseIds.includes(q.courseId));
                }

                // Apply filters
                applyFilters();
                
            } catch (error) {
                console.error('Failed to load data:', error);
                LMS.showToast(LMS.t('error.loadData'), 'error');
            }
        }

        // Generate mock quiz data
        function generateMockQuizzes() {
            const quizzes = [];
            const statuses = ['draft', 'active', 'archived'];
            const quizTitles = [
                'JavaScript Fundamentals Quiz',
                'HTML & CSS Basics Test',
                'React Components Assessment',
                'Database Design Quiz',
                'Python Programming Test',
                'Web Security Assessment',
                'API Development Quiz',
                'Data Structures Test',
                'Algorithm Challenge',
                'Final Course Exam'
            ];

            for (let i = 0; i < 15; i++) {
                const courseId = allCourses[i % allCourses.length]?.id || 'course_001';
                const quiz = {
                    id: `quiz_${String(i + 1).padStart(3, '0')}`,
                    title: quizTitles[i % quizTitles.length],
                    description: `Assessment quiz for ${quizTitles[i % quizTitles.length]}`,
                    courseId: courseId,
                    questionCount: Math.floor(Math.random() * 20) + 5,
                    timeLimit: [30, 45, 60, 90, 120][Math.floor(Math.random() * 5)],
                    passingScore: 70,
                    maxAttempts: Math.floor(Math.random() * 3) + 1,
                    status: statuses[i % statuses.length],
                    attempts: Math.floor(Math.random() * 50),
                    createdAt: new Date(Date.now() - Math.random() * 90 * 24 * 60 * 60 * 1000).toISOString(),
                    createdBy: currentUser.id,
                    isActive: statuses[i % statuses.length] === 'active'
                };
                quizzes.push(quiz);
            }

            return quizzes;
        }

        // Populate course filters
        function populateCourseFilters() {
            let coursesToShow = allCourses;
            if (currentUser.role === 'teacher') {
                coursesToShow = allCourses.filter(c => c.teacherId === currentUser.id);
            }
            
            // Course filter dropdown
            const courseOptions = [{value: '', text: LMS.t('common.allCourses')}];
            coursesToShow.forEach(course => {
                courseOptions.push({value: course.id, text: course.title});
            });
            LMS.Dropdown.populate('courseFilterDropdown', courseOptions);

            // Import course dropdown
            const importOptions = [{value: '', text: LMS.t('common.selectOption')}];
            coursesToShow.forEach(course => {
                importOptions.push({value: course.id, text: course.title});
            });
            LMS.Dropdown.populate('importCourseDropdown', importOptions);
            
            // Initialize dropdowns
            LMS.Dropdown.init('courseFilterDropdown', {
                onSelect: () => filterQuizzes()
            });
            
            LMS.Dropdown.init('statusFilterDropdown', {
                onSelect: () => filterQuizzes()
            });
            
            LMS.Dropdown.init('importCourseDropdown', {
                onSelect: () => {
                    const file = document.getElementById('importFile').files[0];
                    const courseId = LMS.Dropdown.getValue('importCourseDropdown');
                    
                    if (file && courseId) {
                        document.getElementById('importBtn').disabled = false;
                        const courseText = LMS.Dropdown.getText('importCourseDropdown');
                        document.getElementById('importPreview').innerHTML = `
                            <p><strong>File:</strong> ${file.name}</p>
                            <p><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                            <p><strong>Type:</strong> ${file.type || 'Unknown'}</p>
                            <p><strong>Target Course:</strong> ${courseText}</p>
                        `;
                        document.getElementById('importPreview').style.display = 'block';
                    } else {
                        document.getElementById('importBtn').disabled = true;
                        document.getElementById('importPreview').style.display = 'none';
                    }
                }
            });
        }

        // Apply filters
        function applyFilters() {
            filteredQuizzes = [...allQuizzes];

            // Course filter
            const courseFilter = LMS.Dropdown.getValue('courseFilterDropdown');
            if (courseFilter) {
                filteredQuizzes = filteredQuizzes.filter(q => q.courseId === courseFilter);
            }

            // Status filter
            const statusFilter = LMS.Dropdown.getValue('statusFilterDropdown');
            if (statusFilter) {
                filteredQuizzes = filteredQuizzes.filter(q => q.status === statusFilter);
            }

            // Search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredQuizzes = filteredQuizzes.filter(quiz => 
                    quiz.title.toLowerCase().includes(searchTerm) ||
                    quiz.description.toLowerCase().includes(searchTerm)
                );
            }

            currentPage = 1;
        }

        // Update statistics
        function updateStatistics() {
            const total = allQuizzes.length;
            const active = allQuizzes.filter(q => q.status === 'active').length;
            const draft = allQuizzes.filter(q => q.status === 'draft').length;
            const totalAttempts = allQuizzes.reduce((sum, q) => sum + (q.attempts || 0), 0);
            
            document.getElementById('totalQuizzes').textContent = total;
            document.getElementById('activeQuizzes').textContent = active;
            document.getElementById('draftQuizzes').textContent = draft;
            document.getElementById('totalAttempts').textContent = totalAttempts;
        }

        // Display quizzes
        function displayQuizzes() {
            const tbody = document.getElementById('quizTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredQuizzes.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                updatePagination();
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Pagination
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageQuizzes = filteredQuizzes.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageQuizzes.map(quiz => {
                const course = allCourses.find(c => c.id === quiz.courseId);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <div class="font-medium">${quiz.title}</div>
                                <div class="text-sm text-secondary">${quiz.description}</div>
                            </div>
                        </td>
                        <td>
                            <div class="font-medium">${course?.title || 'Unknown Course'}</div>
                        </td>
                        <td class="table__cell--center">${quiz.questionCount}</td>
                        <td class="table__cell--center">${quiz.timeLimit} min</td>
                        <td class="table__cell--center">${quiz.attempts || 0}</td>
                        <td class="table__cell--center">${getStatusBadge(quiz.status)}</td>
                        <td class="table__cell--center">${new Date(quiz.createdAt).toLocaleDateString()}</td>
                        <td class="table__cell--center">
                            <div class="action-buttons">
                                <button class="btn btn--ghost btn--small" onclick="viewQuiz('${quiz.id}')" title="${LMS.t('common.view')}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn--ghost btn--small" onclick="editQuiz('${quiz.id}')" title="${LMS.t('common.edit')}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn--ghost btn--small" onclick="duplicateQuiz('${quiz.id}')" title="${LMS.t('quiz.duplicate')}">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn--ghost btn--small text-danger" onclick="deleteQuiz('${quiz.id}')" title="${LMS.t('common.delete')}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updatePagination();
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                draft: '<span class="badge badge--warning">Draft</span>',
                active: '<span class="badge badge--success">Active</span>',
                archived: '<span class="badge badge--secondary">Archived</span>'
            };
            return badges[status] || `<span class="badge badge--secondary">${status}</span>`;
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredQuizzes.length / rowsPerPage);
            const startRow = (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, filteredQuizzes.length);
            
            document.getElementById('startRow').textContent = filteredQuizzes.length > 0 ? startRow : 0;
            document.getElementById('endRow').textContent = endRow;
            document.getElementById('totalRows').textContent = filteredQuizzes.length;
            
            // Pagination controls
            const controls = document.getElementById('paginationControls');
            let html = '';
            
            if (totalPages > 1) {
                html += `<button class="table__pagination-button" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''}>${LMS.t('pagination.first')}</button>`;
                html += `<button class="table__pagination-button" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>${LMS.t('pagination.previous')}</button>`;
                
                for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                    html += `<button class="table__pagination-button ${i === currentPage ? 'table__pagination-button--active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                }
                
                html += `<button class="table__pagination-button" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>${LMS.t('pagination.next')}</button>`;
                html += `<button class="table__pagination-button" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>${LMS.t('pagination.last')}</button>`;
            }
            
            controls.innerHTML = html;
        }

        // Filter functions
        function filterQuizzes() {
            applyFilters();
            displayQuizzes();
        }

        function refreshData() {
            location.reload();
        }

        // Quiz actions
        function createQuiz() {
            window.location.href = 'quiz-builder.html';
        }

        function viewQuiz(quizId) {
            const quiz = allQuizzes.find(q => q.id === quizId);
            const course = allCourses.find(c => c.id === quiz.courseId);
            
            document.getElementById('detailModalTitle').textContent = quiz.title;
            document.getElementById('detailModalContent').innerHTML = `
                <div class="grid grid-1fr-1fr grid-gap-6">
                    <div>
                        <h4>${LMS.t('quiz.basicInfo')}</h4>
                        <p><strong>${LMS.t('quiz.title')}:</strong> ${quiz.title}</p>
                        <p><strong>${LMS.t('quiz.description')}:</strong> ${quiz.description}</p>
                        <p><strong>${LMS.t('course.title')}:</strong> ${course?.title || 'Unknown'}</p>
                        <p><strong>${LMS.t('common.status')}:</strong> ${getStatusBadge(quiz.status)}</p>
                        <p><strong>${LMS.t('quiz.createdDate')}:</strong> ${new Date(quiz.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div>
                        <h4>${LMS.t('quiz.settings')}</h4>
                        <p><strong>${LMS.t('quiz.questions')}:</strong> ${quiz.questionCount} questions</p>
                        <p><strong>${LMS.t('quiz.timeLimit')}:</strong> ${quiz.timeLimit} minutes</p>
                        <p><strong>${LMS.t('quiz.passingScore')}:</strong> ${quiz.passingScore}%</p>
                        <p><strong>${LMS.t('quiz.maxAttempts')}:</strong> ${quiz.maxAttempts}</p>
                        <p><strong>${LMS.t('quiz.attempts')}:</strong> ${quiz.attempts || 0} total</p>
                    </div>
                </div>
            `;
            
            document.getElementById('detailModalActions').innerHTML = `
                <button class="btn btn--primary" onclick="editQuiz('${quiz.id}'); closeDetailModal();">
                    <i class="fas fa-edit" class="icon-mr"></i>
                    ${LMS.t('common.edit')}
                </button>
                <button class="btn btn--secondary" onclick="duplicateQuiz('${quiz.id}'); closeDetailModal();">
                    <i class="fas fa-copy" class="icon-mr"></i>
                    ${LMS.t('quiz.duplicate')}
                </button>
                <button class="btn btn--secondary" onclick="exportSingleQuiz('${quiz.id}');">
                    <i class="fas fa-download" class="icon-mr"></i>
                    Export JSON
                </button>
                <button class="btn btn--danger" onclick="deleteQuiz('${quiz.id}'); closeDetailModal();">
                    <i class="fas fa-trash" class="icon-mr"></i>
                    ${LMS.t('common.delete')}
                </button>
            `;
            
            document.getElementById('detailModalBackdrop').classList.add('active');
            document.getElementById('detailModal').classList.add('active');
        }

        function editQuiz(quizId) {
            window.location.href = `quiz-builder.html?id=${quizId}`;
        }

        function duplicateQuiz(quizId) {
            if (!confirm(LMS.t('quiz.duplicateConfirm'))) return;
            
            const originalQuiz = allQuizzes.find(q => q.id === quizId);
            if (!originalQuiz) return;
            
            const newQuiz = {
                ...originalQuiz,
                id: 'quiz_' + Date.now(),
                title: originalQuiz.title + ' (Copy)',
                status: 'draft',
                attempts: 0,
                createdAt: new Date().toISOString()
            };
            
            allQuizzes.push(newQuiz);
            LMS.showToast(LMS.t('quiz.duplicated'), 'success');
            displayQuizzes();
            updateStatistics();
        }

        function deleteQuiz(quizId) {
            if (!confirm(LMS.t('quiz.deleteConfirm'))) return;
            
            const index = allQuizzes.findIndex(q => q.id === quizId);
            if (index !== -1) {
                allQuizzes.splice(index, 1);
                LMS.showToast(LMS.t('quiz.deleted'), 'success');
                applyFilters();
                displayQuizzes();
                updateStatistics();
            }
        }

        // Import/Export functions
        function importQuiz() {
            document.getElementById('importModalBackdrop').classList.add('active');
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModalBackdrop').classList.remove('active');
            document.getElementById('importModal').classList.remove('active');
            
            // Reset form
            document.getElementById('importFile').value = '';
            LMS.Dropdown.setValue('importCourseDropdown', '');
            document.getElementById('overwriteExisting').checked = false;
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
        }

        function executeImport() {
            const file = document.getElementById('importFile').files[0];
            const courseId = LMS.Dropdown.getValue('importCourseDropdown');
            
            if (!file || !courseId) {
                LMS.showToast(LMS.t('validation.required'), 'error');
                return;
            }
            
            // Simulate import process
            LMS.showToast(LMS.t('quiz.importing'), 'info');
            
            setTimeout(() => {
                LMS.showToast(LMS.t('quiz.importSuccess'), 'success');
                closeImportModal();
                refreshData();
            }, 2000);
        }

        function exportQuizzes() {
            // Show format selection dialog
            const format = confirm('Export as JSON?\n\nOK = JSON format (full quiz data)\nCancel = CSV format (summary only)') ? 'json' : 'csv';
            
            if (format === 'json') {
                exportQuizzesAsJSON();
            } else {
                exportQuizzesAsCSV();
            }
        }
        
        function exportQuizzesAsJSON() {
            // Export full quiz data including questions
            const exportData = filteredQuizzes.map(quiz => {
                const course = allCourses.find(c => c.id === quiz.courseId);
                return {
                    id: quiz.id,
                    title: quiz.title,
                    description: quiz.description,
                    course: course?.title || 'Unknown',
                    courseId: quiz.courseId,
                    teacherId: quiz.teacherId,
                    timeLimit: quiz.timeLimit,
                    passScore: quiz.passingScore,
                    maxAttempts: quiz.maxAttempts,
                    status: quiz.status,
                    questions: quiz.questions || [],
                    createdAt: quiz.createdAt,
                    updatedAt: quiz.updatedAt || quiz.createdAt
                };
            });
            
            // Download JSON
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quizzes_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function exportQuizzesAsCSV() {
            const data = filteredQuizzes.map(quiz => {
                const course = allCourses.find(c => c.id === quiz.courseId);
                return {
                    'Quiz Title': quiz.title,
                    'Description': quiz.description,
                    'Course': course?.title || 'Unknown',
                    'Questions': quiz.questionCount,
                    'Time Limit': quiz.timeLimit + ' min',
                    'Passing Score': quiz.passingScore + '%',
                    'Max Attempts': quiz.maxAttempts,
                    'Status': quiz.status,
                    'Total Attempts': quiz.attempts || 0,
                    'Created Date': new Date(quiz.createdAt).toLocaleDateString()
                };
            });
            
            // Convert to CSV
            const headers = Object.keys(data[0] || {});
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quizzes_summary_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function closeDetailModal() {
            document.getElementById('detailModalBackdrop').classList.remove('active');
            document.getElementById('detailModal').classList.remove('active');
        }

        // Pagination
        function goToPage(page) {
            currentPage = page;
            displayQuizzes();
        }

        // File input change handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const courseId = LMS.Dropdown.getValue('importCourseDropdown');
                
                if (file && courseId) {
                    document.getElementById('importBtn').disabled = false;
                    
                    // Show preview
                    document.getElementById('importPreview').style.display = 'block';
                    document.getElementById('importPreviewContent').innerHTML = `
                        <p><strong>File:</strong> ${file.name}</p>
                        <p><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                        <p><strong>Type:</strong> ${file.type || 'Unknown'}</p>
                        <p><strong>Target Course:</strong> ${LMS.Dropdown.getText('importCourseDropdown')}</p>
                    `;
                } else {
                    document.getElementById('importBtn').disabled = true;
                    document.getElementById('importPreview').style.display = 'none';
                }
            });
        });

        // Import Excel Functions
        let uploadedExcelData = null;
        
        function openImportModal() {
            document.getElementById('importModalBackdrop').classList.add('active');
            // Reset form
            document.getElementById('excelFileInput').value = '';
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('previewStep').style.display = 'none';
            document.getElementById('importButton').disabled = true;
            uploadedExcelData = null;
        }
        
        function closeImportModal(event) {
            if (!event || event.target.id === 'importModalBackdrop') {
                document.getElementById('importModalBackdrop').classList.remove('active');
            }
        }
        
        function downloadTemplate() {
            // Create sample template data
            const templateData = [
                ['Quiz Title', 'Web Development Basics Quiz'],
                ['Description', 'Test your knowledge of HTML, CSS, and JavaScript'],
                ['Time Limit (minutes)', '30'],
                ['Pass Score (%)', '70'],
                [''],
                ['Question', 'Type', 'Option A', 'Option B', 'Option C', 'Option D', 'Correct Answer', 'Points', 'Explanation'],
                ['What does HTML stand for?', 'multiple_choice', 'Hyper Text Markup Language', 'High Tech Modern Language', 'Home Tool Markup Language', 'Hyper Transfer Markup Language', 'A', '10', 'HTML is the standard markup language for creating web pages.'],
                ['CSS is used for:', 'multiple_choice', 'Structure', 'Styling', 'Behavior', 'Database', 'B', '10', 'CSS is used for styling and layout of web pages.'],
                ['Is JavaScript a programming language?', 'true_false', 'True', 'False', '', '', 'A', '5', 'JavaScript is indeed a programming language.'],
                ['What is the correct HTML tag for the largest heading?', 'text', '', '', '', '', '<h1>', '10', 'H1 is used for the main heading.'],
                ['Which HTML attribute specifies an alternate text for an image?', 'multiple_choice', 'alt', 'title', 'src', 'href', 'A', '10', 'The alt attribute provides alternative text for images.']
            ];

            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Quiz Template");
            
            // Style the worksheet
            ws['!cols'] = [
                {wch: 40}, // Question
                {wch: 15}, // Type  
                {wch: 25}, // Option A
                {wch: 25}, // Option B
                {wch: 25}, // Option C
                {wch: 25}, // Option D
                {wch: 15}, // Correct Answer
                {wch: 10}, // Points
                {wch: 40}  // Explanation
            ];
            
            // Download file
            XLSX.writeFile(wb, 'quiz_template.xlsx');
        }
        
        // File input change handler
        document.getElementById('excelFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleExcelFile(file);
            }
        });
        
        // Drag and drop handlers
        const dropZone = document.getElementById('excelUploadArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            dropZone.classList.add('upload__dropzone--hover');
        }
        
        function unhighlight(e) {
            dropZone.classList.remove('upload__dropzone--hover');
        }
        
        dropZone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleExcelFile(files[0]);
            }
        }
        
        function handleExcelFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                alert('Please upload an Excel file (.xlsx or .xls)');
                return;
            }
            
            // Show file info
            document.getElementById('uploadedFileInfo').style.display = 'flex';
            document.querySelector('#uploadedFileInfo .filename').textContent = file.name;
            
            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Parse the first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Process and validate data
                    processExcelData(jsonData);
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                    removeUploadedFile();
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function removeUploadedFile() {
            document.getElementById('excelFileInput').value = '';
            document.getElementById('uploadedFileInfo').style.display = 'none';
            document.getElementById('previewStep').style.display = 'none';
            document.getElementById('importButton').disabled = true;
            uploadedExcelData = null;
        }
        
        function processExcelData(data) {
            const quiz = {
                title: '',
                description: '',
                timeLimit: 30,
                passScore: 70,
                questions: []
            };
            
            const errors = [];
            let headerRowIndex = -1;
            
            // Find quiz metadata and header row
            for (let i = 0; i < Math.min(10, data.length); i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                if (row[0] === 'Quiz Title' && row[1]) {
                    quiz.title = row[1].toString();
                } else if (row[0] === 'Description' && row[1]) {
                    quiz.description = row[1].toString();
                } else if (row[0] === 'Time Limit (minutes)' && row[1]) {
                    quiz.timeLimit = parseInt(row[1]) || 30;
                } else if (row[0] === 'Pass Score (%)' && row[1]) {
                    quiz.passScore = parseInt(row[1]) || 70;
                } else if (row[0] === 'Question') {
                    headerRowIndex = i;
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                errors.push('Could not find question header row');
            } else {
                // Process questions
                for (let i = headerRowIndex + 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.length < 9 || !row[0]) continue;
                    
                    const question = {
                        text: row[0].toString(),
                        type: row[1] ? row[1].toString().toLowerCase() : 'multiple_choice',
                        options: [],
                        correctAnswer: row[6] ? row[6].toString().toUpperCase() : '',
                        points: parseInt(row[7]) || 10,
                        explanation: row[8] ? row[8].toString() : ''
                    };
                    
                    // Validate question type
                    const validTypes = ['multiple_choice', 'true_false', 'text'];
                    if (!validTypes.includes(question.type)) {
                        errors.push(`Row ${i + 1}: Invalid question type "${question.type}"`);
                        continue;
                    }
                    
                    // Process options based on type
                    if (question.type === 'multiple_choice') {
                        for (let j = 2; j <= 5; j++) {
                            if (row[j]) {
                                question.options.push(row[j].toString());
                            }
                        }
                        if (question.options.length < 2) {
                            errors.push(`Row ${i + 1}: Multiple choice questions need at least 2 options`);
                            continue;
                        }
                    } else if (question.type === 'true_false') {
                        question.options = ['True', 'False'];
                        // Convert T/F to A/B for consistency
                        if (question.correctAnswer === 'TRUE' || question.correctAnswer === 'T') {
                            question.correctAnswer = 'A';
                        } else if (question.correctAnswer === 'FALSE' || question.correctAnswer === 'F') {
                            question.correctAnswer = 'B';
                        }
                    }
                    
                    quiz.questions.push(question);
                }
            }
            
            // Show preview
            showImportPreview(quiz, errors);
        }
        
        function showImportPreview(quiz, errors) {
            uploadedExcelData = quiz;
            
            // Update summary
            document.getElementById('previewTitle').textContent = quiz.title || 'Untitled Quiz';
            document.getElementById('previewQuestionCount').textContent = quiz.questions.length;
            document.getElementById('previewValidCount').textContent = quiz.questions.length;
            document.getElementById('previewErrorCount').textContent = errors.length;
            
            // Show errors if any
            if (errors.length > 0) {
                document.getElementById('importErrors').style.display = 'block';
                const errorList = document.getElementById('errorList');
                errorList.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
            } else {
                document.getElementById('importErrors').style.display = 'none';
            }
            
            // Show question preview
            const previewContainer = document.getElementById('previewQuestions');
            previewContainer.innerHTML = quiz.questions.map((q, index) => `
                <div class="preview-question">
                    <div class="preview-question-header">
                        <span class="preview-question-number">Question ${index + 1}</span>
                        <span class="preview-question-type">${q.type.replace('_', ' ')}</span>
                    </div>
                    <div class="preview-question-text">${q.text}</div>
                    ${q.options.length > 0 ? `
                        <div class="preview-question-options">
                            Options: ${q.options.join(', ')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
            
            // Show preview step and enable import button
            document.getElementById('previewStep').style.display = 'block';
            document.getElementById('importButton').disabled = quiz.questions.length === 0;
        }
        
        async function performImport() {
            if (!uploadedExcelData || uploadedExcelData.questions.length === 0) {
                alert('No valid data to import');
                return;
            }
            
            try {
                // Create quiz object
                const newQuiz = {
                    id: `quiz_${Date.now()}`,
                    title: uploadedExcelData.title || 'Imported Quiz',
                    description: uploadedExcelData.description || '',
                    courseId: '',
                    teacherId: currentUser.id,
                    timeLimit: uploadedExcelData.timeLimit,
                    passScore: uploadedExcelData.passScore,
                    questions: uploadedExcelData.questions,
                    status: 'draft',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Save to localStorage (in real app, would save to server)
                let quizzes = JSON.parse(localStorage.getItem('lms_quizzes') || '[]');
                quizzes.push(newQuiz);
                localStorage.setItem('lms_quizzes', JSON.stringify(quizzes));
                
                // Close modal and refresh list
                closeImportModal();
                alert(`Successfully imported quiz: ${newQuiz.title}`);
                loadQuizzes();
            } catch (error) {
                alert('Error importing quiz: ' + error.message);
            }
        }

        // Export single quiz function
        function exportSingleQuiz(quizId) {
            const quiz = allQuizzes.find(q => q.id === quizId);
            if (!quiz) {
                alert('Quiz not found');
                return;
            }
            
            const course = allCourses.find(c => c.id === quiz.courseId);
            const exportData = {
                id: quiz.id,
                title: quiz.title,
                description: quiz.description,
                course: course?.title || 'Unknown',
                courseId: quiz.courseId,
                teacherId: quiz.teacherId,
                timeLimit: quiz.timeLimit,
                passScore: quiz.passingScore,
                maxAttempts: quiz.maxAttempts,
                status: quiz.status,
                questions: quiz.questions || [],
                createdAt: quiz.createdAt,
                updatedAt: quiz.updatedAt || quiz.createdAt
            };
            
            // Download JSON
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz_${quiz.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Delete quiz function
        function deleteQuiz(quizId) {
            if (!confirm('Are you sure you want to delete this quiz? This action cannot be undone.')) {
                return;
            }
            
            // Remove from allQuizzes array
            const index = allQuizzes.findIndex(q => q.id === quizId);
            if (index > -1) {
                allQuizzes.splice(index, 1);
                
                // Update localStorage (in real app, would delete from server)
                localStorage.setItem('lms_quizzes', JSON.stringify(allQuizzes));
                
                // Refresh display
                loadQuizzes();
                
                alert('Quiz deleted successfully');
            }
        }

        // Add script tag for XLSX library if not already loaded
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            document.head.appendChild(script);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
