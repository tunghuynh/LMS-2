<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Attempt - LMS</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Configuration -->
    <script src="../config.js"></script>
    


</head>
<body>
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="flex-between">
                <div>
                    <h1 class="page-title" id="quizTitle">Quiz Title</h1>
                    <p class="page-subtitle" id="quizDescription">Quiz description</p>
                </div>
                <div class="flex flex-gap-3">
                    <button class="btn btn--warning" onclick="submitQuiz()">
                        <i class="fas fa-paper-plane" class="icon-mr"></i>
                        <span data-translate="quiz.submitQuiz">Submit Quiz</span>
                    </button>
                    <button class="btn btn--ghost" onclick="exitQuiz()">
                        <i class="fas fa-times" class="icon-mr"></i>
                        <span data-translate="quiz.exitQuiz">Exit</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="page-content">
            <div class="two-column-layout">
                <!-- Sidebar -->
                <div class="sidebar-column">
                    <!-- Timer -->
                    <div class="card mb-4" id="timerCard">
                        <div class="card__body text-center">
                            <div class="text-2xl font-bold mb-2" id="timerDisplay">--:--</div>
                            <div class="text-sm" data-translate="quiz.timeRemaining">Time Remaining</div>
                        </div>
                    </div>

                    <!-- Progress Info -->
                    <div class="card mb-4">
                        <div class="card__body">
                            <div class="font-bold mb-2" data-translate="quiz.progress">Progress</div>
                        <div class="text-sm">
                            <div class="mb-1">
                                <span data-translate="quiz.answered">Answered:</span> 
                                <span id="answeredCount">0</span>/<span id="totalQuestions">0</span>
                            </div>
                            <div class="mb-1">
                                <span data-translate="quiz.flagged">Flagged:</span> 
                                <span id="flaggedCount">0</span>
                            </div>
                            <div>
                                <span data-translate="quiz.remaining">Remaining:</span> 
                                <span id="remainingCount">0</span>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Question Navigation -->
                    <div>
                        <h4 class="mb-3" data-translate="quiz.questionNavigation">Questions</h4>
                        <div class="question-nav" id="questionNav">
                            <!-- Dynamic question navigation items -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-4 text-sm">
                        <h5 class="mb-2" data-translate="quiz.legend">Legend</h5>
                        <div class="flex flex-col flex-gap-1">
                            <div class="flex-items-center flex-gap-2">
                                <div class="question-nav-item" class="w-5 h-5 text-10">1</div>
                                <span data-translate="quiz.notAnswered">Not Answered</span>
                            </div>
                            <div class="flex-items-center flex-gap-2">
                                <div class="question-nav-item answered" class="w-5 h-5 text-10">2</div>
                                <span data-translate="quiz.answered">Answered</span>
                            </div>
                            <div class="flex-items-center flex-gap-2">
                                <div class="question-nav-item current" class="w-5 h-5 text-10">3</div>
                                <span data-translate="quiz.current">Current</span>
                            </div>
                            <div class="flex-items-center flex-gap-2">
                                <div class="question-nav-item flagged" class="w-5 h-5 text-10">4</div>
                                <span data-translate="quiz.flaggedForReview">Flagged</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-column">
                    <!-- Question Content -->
                    <div class="card" id="questionContent">
                        <!-- Dynamic question content -->
                    </div>

                    <!-- Question Actions -->
                    <div class="question-actions">
                        <div class="question-nav-buttons">
                            <button class="btn btn--secondary" onclick="previousQuestion()" id="prevBtn" disabled>
                                <i class="fas fa-chevron-left" class="icon-mr"></i>
                                <span data-translate="quiz.previous">Previous</span>
                            </button>
                            <button class="btn btn--primary" onclick="nextQuestion()" id="nextBtn">
                                <span data-translate="quiz.next">Next</span>
                                <i class="fas fa-chevron-right" class="icon-ml"></i>
                            </button>
                        </div>

                        <div class="flex flex-gap-3">
                            <button class="btn btn--ghost" onclick="toggleFlag()" id="flagBtn">
                                <i class="fas fa-flag" class="icon-mr"></i>
                                <span data-translate="quiz.flagForReview">Flag for Review</span>
                            </button>
                            <button class="btn btn--secondary" onclick="clearAnswer()">
                                <i class="fas fa-eraser" class="icon-mr"></i>
                                <span data-translate="quiz.clearAnswer">Clear Answer</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Warning Modal -->
    <div class="submit-warning" id="submitWarning">
        <div class="submit-dialog">
            <h3 class="mb-4" data-translate="quiz.submitConfirmTitle">Submit Quiz?</h3>
            <div id="submitSummary" class="mb-6">
                <!-- Dynamic submit summary -->
            </div>
            <div class="flex-end flex-gap-3">
                <button class="btn btn--secondary" onclick="closeSubmitWarning()">
                    <i class="fas fa-times" class="icon-mr"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button class="btn btn--warning" onclick="confirmSubmit()">
                    <i class="fas fa-paper-plane" class="icon-mr"></i>
                    <span data-translate="quiz.submitFinal">Submit Final Answer</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="fas fa-check" class="icon-mr"></i>
        <span data-translate="quiz.autoSaved">Auto-saved</span>
    </div>

        <!-- Security Check Modal -->
    <div class="modal-backdrop" id="securityCheckModalBackdrop">
        <div class="modal modal--medium" id="securityCheckModal">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.securityCheck">Security Check</h2>
            </div>
            <div class="modal__body" id="securityCheckContent">
                <!-- Dynamic security check content -->
            </div>
            <div class="modal__footer" id="securityCheckFooter">
                <!-- Dynamic footer content -->
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal-backdrop" id="passwordModalBackdrop">
        <div class="modal modal--small" id="passwordModal">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.enterPassword">Enter Quiz Password</h2>
            </div>
            <div class="modal__body">
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.password">Password</label>
                    <input type="password" id="quizPasswordInput" class="input" placeholder="Enter password...">
                </div>
                <div id="passwordError" class="alert alert--danger" style="display: none; margin-top: var(--spacing-3);">
                    <i class="fas fa-exclamation-circle"></i>
                    <span data-translate="quiz.incorrectPassword">Incorrect password. Please try again.</span>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="exitQuiz()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button class="btn btn--primary" onclick="checkPassword()">
                    <i class="fas fa-check" style="margin-right: 8px;"></i>
                    <span data-translate="common.submit">Submit</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Webcam Verification Modal -->
    <div class="modal-backdrop" id="webcamModalBackdrop">
        <div class="modal modal--large" id="webcamModal">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.webcamVerification">Webcam Verification</h2>
            </div>
            <div class="modal__body">
                <div style="text-align: center;">
                    <video id="webcamPreview" width="640" height="480" autoplay style="border: 2px solid var(--border-color); border-radius: var(--radius-md);"></video>
                    <canvas id="webcamCanvas" width="640" height="480" style="display: none;"></canvas>
                    <div style="margin-top: var(--spacing-4);">
                        <button class="btn btn--primary" onclick="captureWebcamPhoto()">
                            <i class="fas fa-camera" style="margin-right: 8px;"></i>
                            <span data-translate="quiz.capturePhoto">Capture Photo</span>
                        </button>
                    </div>
                    <div id="capturedPhoto" style="margin-top: var(--spacing-4); display: none;">
                        <h4 data-translate="quiz.capturedPhoto">Captured Photo</h4>
                        <img id="capturedImage" style="max-width: 300px; border: 2px solid var(--border-color); border-radius: var(--radius-md);">
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="cancelWebcamVerification()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button class="btn btn--primary" id="proceedWithWebcam" onclick="proceedAfterWebcam()" disabled>
                    <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>
                    <span data-translate="common.proceed">Proceed</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Focus Loss Warning Modal -->
    <div class="modal-backdrop" id="focusLossModalBackdrop">
        <div class="modal modal--small" id="focusLossModal">
            <div class="modal__header">
                <h2 class="modal__title" style="color: var(--color-warning);">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span data-translate="quiz.focusLossWarning">Focus Loss Warning</span>
                </h2>
            </div>
            <div class="modal__body">
                <p data-translate="quiz.focusLossMessage">
                    You have navigated away from the quiz window. This activity has been recorded.
                </p>
                <p style="margin-top: var(--spacing-3);">
                    <strong data-translate="quiz.focusLossCount">Number of violations:</strong>
                    <span id="focusLossCount" style="color: var(--color-danger);">0</span>
                </p>
            </div>
            <div class="modal__footer">
                <button class="btn btn--primary" onclick="closeFocusLossWarning()">
                    <i class="fas fa-check" style="margin-right: 8px;"></i>
                    <span data-translate="common.understood">Understood</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="../assets/js/global.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>

    <script>
        // State management
        let quizData = null;
        let userAnswers = {};
        let flaggedQuestions = new Set();
        let currentQuestionIndex = 0;
        let timeRemaining = 0; // in seconds
        let timerInterval = null;
        let autoSaveInterval = null;
        let currentUser = null;
        let hasUnsavedChanges = false;
        
        // Security tracking
        let focusLossCount = 0;
        let securityLogs = [];
        let questionTimerInterval = null;
        let questionTimeRemaining = 0;
        let webcamStream = null;
        let screenshotInterval = null;

        // Initialize
        async function init() {
            // Ensure auth is loaded first
            if (!LMS.Auth.currentUser) {
                LMS.Auth.loadSession();
            }
            
            // Get current user after auth is ready
            currentUser = LMS.Auth.getUser();
            
            // Check authentication - students only
            if (!LMS.Auth.isAuthenticated() || !currentUser || currentUser.role !== 'student') {
                window.location.href = '../index.html';
                return;
            }

            // Load translations
            await LMS.LanguageManager.init();
            LMS.LanguageManager.updateUI();
            
            // Get quiz ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('id');
            
            if (!quizId) {
                LMS.showToast(LMS.t('error.quizNotFound'), 'error');
                window.location.href = 'courses.html';
                return;
            }
            
            // Load quiz data
            await loadQuiz(quizId);
            
            // Check security requirements before starting
            const securityPassed = await checkSecurityRequirements();
            if (!securityPassed) {
                return;
            }
            
            setupQuizAttempt();
            startTimer();
            startAutoSave();
            setupEventListeners();
            initializeSecurityFeatures();
        }

        // Load quiz data
        async function loadQuiz(quizId) {
            try {
                // In a real app, this would load from API
                // For demo, we'll create mock quiz data
                quizData = generateMockQuiz(quizId);
                
                // Load existing attempt if any
                const savedAttempt = localStorage.getItem(`quiz_attempt_${quizId}_${currentUser.id}`);
                if (savedAttempt) {
                    const attempt = JSON.parse(savedAttempt);
                    userAnswers = attempt.answers || {};
                    flaggedQuestions = new Set(attempt.flagged || []);
                    timeRemaining = attempt.timeRemaining || quizData.timeLimit * 60;
                    currentQuestionIndex = attempt.currentQuestion || 0;
                } else {
                    timeRemaining = quizData.timeLimit * 60; // Convert minutes to seconds
                }
                
            } catch (error) {
                console.error('Failed to load quiz:', error);
                LMS.showToast(LMS.t('error.loadData'), 'error');
                window.location.href = 'courses.html';
            }
        }

        // Generate mock quiz data
        function generateMockQuiz(quizId) {
            return {
                id: quizId,
                title: 'JavaScript Fundamentals Quiz',
                description: 'Test your knowledge of JavaScript fundamentals',
                timeLimit: 30, // minutes
                passingScore: 70,
                shuffleQuestions: false,
                // Security settings (mock)
                security: {
                    passwordEnabled: true,
                    password: 'quiz123',
                    timeWindowEnabled: false,
                    startTime: null,
                    endTime: null,
                    preventTabSwitch: true,
                    fullScreenMode: true,
                    disableCopyPaste: true,
                    randomizeQuestions: true,
                    randomizeOptions: true,
                    ipRestriction: false,
                    allowedIPs: [],
                    timeLimitPerQuestion: false,
                    questionTimeLimit: 60,
                    browserLockdown: false,
                    trackFocusLoss: true,
                    recordAnswerChanges: true,
                    captureScreenshots: false,
                    webcamRequired: false,
                    idVerification: false,
                    liveProctoring: false
                },
                questions: [
                    {
                        id: 'q1',
                        type: 'multiple-choice',
                        question: 'What is the correct way to declare a variable in JavaScript?',
                        points: 1,
                        options: [
                            { id: 'a', text: 'var myVariable;', correct: true },
                            { id: 'b', text: 'variable myVariable;', correct: false },
                            { id: 'c', text: 'declare myVariable;', correct: false },
                            { id: 'd', text: 'v myVariable;', correct: false }
                        ]
                    },
                    {
                        id: 'q2',
                        type: 'multiple-select',
                        question: 'Which of the following are JavaScript data types? (Select all that apply)',
                        points: 2,
                        options: [
                            { id: 'a', text: 'String', correct: true },
                            { id: 'b', text: 'Number', correct: true },
                            { id: 'c', text: 'Character', correct: false },
                            { id: 'd', text: 'Boolean', correct: true },
                            { id: 'e', text: 'Float', correct: false }
                        ]
                    },
                    {
                        id: 'q3',
                        type: 'true-false',
                        question: 'JavaScript is a case-sensitive programming language.',
                        points: 1,
                        answer: true
                    },
                    {
                        id: 'q4',
                        type: 'text-input',
                        question: 'Explain the difference between "let" and "var" in JavaScript. (Minimum 50 words)',
                        points: 3
                    },
                    {
                        id: 'q5',
                        type: 'multiple-choice',
                        question: 'What does the "typeof" operator return for an array in JavaScript?',
                        points: 1,
                        options: [
                            { id: 'a', text: 'array', correct: false },
                            { id: 'b', text: 'object', correct: true },
                            { id: 'c', text: 'list', correct: false },
                            { id: 'd', text: 'undefined', correct: false }
                        ]
                    }
                ]
            };
        }

        // Setup quiz attempt UI
        function setupQuizAttempt() {
            document.getElementById('quizTitle').textContent = quizData.title;
            document.getElementById('quizDescription').textContent = quizData.description;
            
            createQuestionNavigation();
            updateProgressInfo();
            displayCurrentQuestion();
        }

        // Create question navigation
        function createQuestionNavigation() {
            const nav = document.getElementById('questionNav');
            nav.innerHTML = quizData.questions.map((question, index) => `
                <div class="question-nav-item ${index === currentQuestionIndex ? 'current' : ''} 
                           ${userAnswers[question.id] ? 'answered' : ''}
                           ${flaggedQuestions.has(question.id) ? 'flagged' : ''}"
                     onclick="goToQuestion(${index})"
                     data-question-index="${index}">
                    ${index + 1}
                </div>
            `).join('');
            
            document.getElementById('totalQuestions').textContent = quizData.questions.length;
        }

        // Update progress information
        function updateProgressInfo() {
            const answered = Object.keys(userAnswers).length;
            const flagged = flaggedQuestions.size;
            const remaining = quizData.questions.length - answered;
            
            document.getElementById('answeredCount').textContent = answered;
            document.getElementById('flaggedCount').textContent = flagged;
            document.getElementById('remainingCount').textContent = remaining;
            
            // Update navigation items
            quizData.questions.forEach((question, index) => {
                const navItem = document.querySelector(`[data-question-index="${index}"]`);
                if (navItem) {
                    navItem.className = 'question-nav-item';
                    
                    if (index === currentQuestionIndex) {
                        navItem.classList.add('current');
                    }
                    if (userAnswers[question.id]) {
                        navItem.classList.add('answered');
                    }
                    if (flaggedQuestions.has(question.id)) {
                        navItem.classList.add('flagged');
                    }
                }
            });
        }

        // Display current question
        function displayCurrentQuestion() {
            const question = quizData.questions[currentQuestionIndex];
            const content = document.getElementById('questionContent');
            
            content.innerHTML = `
                <div class="question-header">
                    <div class="question-number">
                        <span data-translate="quiz.question">Question</span> ${currentQuestionIndex + 1} 
                        <span data-translate="common.of">of</span> ${quizData.questions.length}
                    </div>
                    <div class="question-points">${question.points} ${question.points === 1 ? 'point' : 'points'}</div>
                </div>
                
                <div class="question-text">${question.question}</div>
                
                <div class="answer-options">
                    ${renderQuestionInput(question)}
                </div>
            `;
            
            // Update navigation buttons
            updateNavigationButtons();
            updateFlagButton();
            
            // Focus on question content
            content.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Render question input based on type
        function renderQuestionInput(question) {
            switch (question.type) {
                case 'multiple-choice':
                    return question.options.map(option => `
                        <div class="answer-option ${userAnswers[question.id] === option.id ? 'selected' : ''}"
                             onclick="selectOption('${question.id}', '${option.id}')">
                            <input type="radio" name="q${question.id}" value="${option.id}" 
                                   ${userAnswers[question.id] === option.id ? 'checked' : ''}>
                            <label>${option.text}</label>
                        </div>
                    `).join('');
                    
                case 'multiple-select':
                    const selectedOptions = userAnswers[question.id] || [];
                    return question.options.map(option => `
                        <div class="answer-option ${selectedOptions.includes(option.id) ? 'selected' : ''}"
                             onclick="toggleOption('${question.id}', '${option.id}')">
                            <input type="checkbox" name="q${question.id}" value="${option.id}" 
                                   ${selectedOptions.includes(option.id) ? 'checked' : ''}>
                            <label>${option.text}</label>
                        </div>
                    `).join('');
                    
                case 'true-false':
                    return `
                        <div class="answer-option ${userAnswers[question.id] === true ? 'selected' : ''}"
                             onclick="selectOption('${question.id}', true)">
                            <input type="radio" name="q${question.id}" value="true" 
                                   ${userAnswers[question.id] === true ? 'checked' : ''}>
                            <label data-translate="quiz.true">True</label>
                        </div>
                        <div class="answer-option ${userAnswers[question.id] === false ? 'selected' : ''}"
                             onclick="selectOption('${question.id}', false)">
                            <input type="radio" name="q${question.id}" value="false" 
                                   ${userAnswers[question.id] === false ? 'checked' : ''}>
                            <label data-translate="quiz.false">False</label>
                        </div>
                    `;
                    
                case 'text-input':
                    return `
                        <textarea class="text-answer" 
                                  placeholder="${LMS.t('quiz.typeAnswer')}" 
                                  onchange="setTextAnswer('${question.id}', this.value)"
                                  oninput="hasUnsavedChanges = true">${userAnswers[question.id] || ''}</textarea>
                    `;
                    
                default:
                    return '<p>Unknown question type</p>';
            }
        }

        // Answer handling functions
        function selectOption(questionId, optionId) {
            userAnswers[questionId] = optionId;
            hasUnsavedChanges = true;
            displayCurrentQuestion();
            updateProgressInfo();
        }

        function toggleOption(questionId, optionId) {
            if (!userAnswers[questionId]) {
                userAnswers[questionId] = [];
            }
            
            const index = userAnswers[questionId].indexOf(optionId);
            if (index > -1) {
                userAnswers[questionId].splice(index, 1);
            } else {
                userAnswers[questionId].push(optionId);
            }
            
            hasUnsavedChanges = true;
            displayCurrentQuestion();
            updateProgressInfo();
        }

        function setTextAnswer(questionId, value) {
            userAnswers[questionId] = value;
            hasUnsavedChanges = true;
            updateProgressInfo();
        }

        // Navigation functions
        function goToQuestion(index) {
            if (index >= 0 && index < quizData.questions.length) {
                currentQuestionIndex = index;
                displayCurrentQuestion();
                updateProgressInfo();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                goToQuestion(currentQuestionIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < quizData.questions.length - 1) {
                goToQuestion(currentQuestionIndex + 1);
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === quizData.questions.length - 1) {
                nextBtn.innerHTML = `
                    <span data-translate="quiz.finish">Finish</span>
                    <i class="fas fa-flag-checkered" class="icon-ml"></i>
                `;
            } else {
                nextBtn.innerHTML = `
                    <span data-translate="quiz.next">Next</span>
                    <i class="fas fa-chevron-right" class="icon-ml"></i>
                `;
            }
        }

        // Flag functions
        function toggleFlag() {
            const questionId = quizData.questions[currentQuestionIndex].id;
            
            if (flaggedQuestions.has(questionId)) {
                flaggedQuestions.delete(questionId);
            } else {
                flaggedQuestions.add(questionId);
            }
            
            hasUnsavedChanges = true;
            updateProgressInfo();
            updateFlagButton();
        }

        function updateFlagButton() {
            const flagBtn = document.getElementById('flagBtn');
            const questionId = quizData.questions[currentQuestionIndex].id;
            const isFlagged = flaggedQuestions.has(questionId);
            
            if (isFlagged) {
                flagBtn.classList.add('btn--warning');
                flagBtn.innerHTML = `
                    <i class="fas fa-flag" class="icon-mr"></i>
                    <span data-translate="quiz.unflag">Remove Flag</span>
                `;
            } else {
                flagBtn.classList.remove('btn--warning');
                flagBtn.innerHTML = `
                    <i class="fas fa-flag" class="icon-mr"></i>
                    <span data-translate="quiz.flagForReview">Flag for Review</span>
                `;
            }
        }

        function clearAnswer() {
            const questionId = quizData.questions[currentQuestionIndex].id;
            delete userAnswers[questionId];
            hasUnsavedChanges = true;
            displayCurrentQuestion();
            updateProgressInfo();
        }

        // Timer functions
        function startTimer() {
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitQuiz();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            let display = '';
            if (hours > 0) {
                display = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            document.getElementById('timerDisplay').textContent = display;
            
            // Warning state for last 5 minutes
            const timerCard = document.getElementById('timerCard');
            if (timeRemaining <= 300) { // 5 minutes
                timerCard.classList.add('danger');
            } else {
                timerCard.classList.remove('danger');
            }
        }

        // Auto-save functions
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (hasUnsavedChanges) {
                    saveProgress();
                }
            }, 30000); // Save every 30 seconds
        }

        function saveProgress() {
            const attemptData = {
                quizId: quizData.id,
                userId: currentUser.id,
                answers: userAnswers,
                flagged: Array.from(flaggedQuestions),
                currentQuestion: currentQuestionIndex,
                timeRemaining: timeRemaining,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem(`quiz_attempt_${quizData.id}_${currentUser.id}`, JSON.stringify(attemptData));
            hasUnsavedChanges = false;
            
            // Show auto-save indicator
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Submit functions
        function submitQuiz() {
            const answered = Object.keys(userAnswers).length;
            const total = quizData.questions.length;
            
            document.getElementById('submitSummary').innerHTML = `
                <p class="mb-3" data-translate="quiz.submitWarning">You are about to submit your quiz. Please review your answers before submitting.</p>
                <div class="bg-secondary p-4 rounded-md">
                    <div class="mb-2"><strong>${LMS.t('quiz.answered')}:</strong> ${answered}/${total} questions</div>
                    <div class="mb-2"><strong>${LMS.t('quiz.flagged')}:</strong> ${flaggedQuestions.size} questions</div>
                    <div><strong>${LMS.t('quiz.timeUsed')}:</strong> ${formatTimeUsed()}</div>
                </div>
                ${answered < total ? `<p style="color: var(--color-warning); margin-top: var(--spacing-3);"><i class="fas fa-exclamation-triangle"></i> ${LMS.t('quiz.unansweredWarning')}</p>` : ''}
            `;
            
            document.getElementById('submitWarning').classList.add('active');
        }

        function closeSubmitWarning() {
            document.getElementById('submitWarning').classList.remove('active');
        }

        function confirmSubmit() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            
            // Calculate score (simplified)
            const score = calculateScore();
            
            // Save final submission
            const submission = {
                quizId: quizData.id,
                userId: currentUser.id,
                answers: userAnswers,
                score: score,
                timeUsed: (quizData.timeLimit * 60) - timeRemaining,
                submittedAt: new Date().toISOString()
            };
            
            localStorage.setItem(`quiz_submission_${quizData.id}_${currentUser.id}`, JSON.stringify(submission));
            
            // Clear attempt data
            localStorage.removeItem(`quiz_attempt_${quizData.id}_${currentUser.id}`);
            
            // Redirect to results
            LMS.showToast(LMS.t('quiz.submitted'), 'success');
            setTimeout(() => {
                window.location.href = `quiz-results.html?id=${quizData.id}`;
            }, 1000);
        }

        function autoSubmitQuiz() {
            LMS.showToast(LMS.t('quiz.timeUp'), 'warning');
            confirmSubmit();
        }

        function calculateScore() {
            let correctAnswers = 0;
            let totalPoints = 0;
            
            quizData.questions.forEach(question => {
                totalPoints += question.points;
                
                const userAnswer = userAnswers[question.id];
                if (!userAnswer) return;
                
                switch (question.type) {
                    case 'multiple-choice':
                    case 'true-false':
                        const correctOption = question.options ? 
                            question.options.find(o => o.correct)?.id : 
                            question.answer;
                        if (userAnswer === correctOption || userAnswer === question.answer) {
                            correctAnswers += question.points;
                        }
                        break;
                        
                    case 'multiple-select':
                        const correctOptions = question.options.filter(o => o.correct).map(o => o.id);
                        const selectedOptions = Array.isArray(userAnswer) ? userAnswer : [];
                        
                        if (correctOptions.length === selectedOptions.length &&
                            correctOptions.every(id => selectedOptions.includes(id))) {
                            correctAnswers += question.points;
                        }
                        break;
                        
                    case 'text-input':
                        // For demo, award half points for text answers
                        if (userAnswer && userAnswer.trim().length > 0) {
                            correctAnswers += question.points * 0.5;
                        }
                        break;
                }
            });
            
            return Math.round((correctAnswers / totalPoints) * 100);
        }

        function formatTimeUsed() {
            const timeUsed = (quizData.timeLimit * 60) - timeRemaining;
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function exitQuiz() {
            if (confirm(LMS.t('quiz.exitConfirm'))) {
                clearInterval(timerInterval);
                clearInterval(autoSaveInterval);
                saveProgress();
                window.location.href = 'courses.html';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Prevent accidental page leave
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveProgress();
                }
                
                if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    previousQuestion();
                }
                
                if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    nextQuestion();
                }
            });
        }

        // Security Functions
        async function checkSecurityRequirements() {
            if (!quizData.security) {
                return true; // No security settings, allow access
            }
            
            const security = quizData.security;
            
            // Check time window
            if (security.timeWindowEnabled) {
                const now = new Date();
                const startTime = new Date(security.startTime);
                const endTime = new Date(security.endTime);
                
                if (now < startTime || now > endTime) {
                    LMS.showToast(LMS.t('quiz.outsideTimeWindow'), 'error');
                    return false;
                }
            }
            
            // Check IP restriction
            if (security.ipRestriction && security.allowedIPs.length > 0) {
                // In a real app, this would check the user's IP
                // For demo, we'll just show a message
                console.log('IP restriction check would happen here');
            }
            
            // Show security requirements modal
            let checks = [];
            if (security.passwordEnabled) checks.push('password');
            if (security.webcamRequired) checks.push('webcam');
            if (security.idVerification) checks.push('id');
            if (security.fullScreenMode) checks.push('fullscreen');
            
            if (checks.length > 0) {
                return await showSecurityChecks(checks);
            }
            
            return true;
        }
        
        async function showSecurityChecks(checks) {
            const content = document.getElementById('securityCheckContent');
            const footer = document.getElementById('securityCheckFooter');
            
            let html = '<div class="security-checks">';
            html += '<p data-translate="quiz.securityRequirements">This quiz has the following security requirements:</p>';
            html += '<ul style="margin: var(--spacing-4) 0;">';
            
            if (checks.includes('password')) {
                html += '<li><i class="fas fa-lock"></i> Password protected</li>';
            }
            if (checks.includes('webcam')) {
                html += '<li><i class="fas fa-camera"></i> Webcam verification required</li>';
            }
            if (checks.includes('id')) {
                html += '<li><i class="fas fa-id-card"></i> ID verification required</li>';
            }
            if (checks.includes('fullscreen')) {
                html += '<li><i class="fas fa-expand"></i> Full-screen mode required</li>';
            }
            
            html += '</ul>';
            html += '</div>';
            
            content.innerHTML = html;
            
            footer.innerHTML = `
                <button class="btn btn--secondary" onclick="exitQuiz()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button class="btn btn--primary" onclick="proceedWithSecurityChecks()">
                    <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
                    <span data-translate="common.proceed">Proceed</span>
                </button>
            `;
            
            document.getElementById('securityCheckModalBackdrop').classList.add('active');
            document.getElementById('securityCheckModal').classList.add('active');
            
            return new Promise((resolve) => {
                window.securityCheckResolve = resolve;
            });
        }
        
        async function proceedWithSecurityChecks() {
            document.getElementById('securityCheckModalBackdrop').classList.remove('active');
            document.getElementById('securityCheckModal').classList.remove('active');
            
            const security = quizData.security;
            
            // Check password
            if (security.passwordEnabled) {
                const passwordCorrect = await checkQuizPassword();
                if (!passwordCorrect) {
                    window.securityCheckResolve(false);
                    return;
                }
            }
            
            // Check webcam
            if (security.webcamRequired) {
                const webcamReady = await setupWebcam();
                if (!webcamReady) {
                    window.securityCheckResolve(false);
                    return;
                }
            }
            
            // Enter fullscreen
            if (security.fullScreenMode) {
                await enterFullscreen();
            }
            
            window.securityCheckResolve(true);
        }
        
        function checkQuizPassword() {
            document.getElementById('passwordModalBackdrop').classList.add('active');
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('quizPasswordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            
            return new Promise((resolve) => {
                window.passwordCheckResolve = resolve;
            });
        }
        
        function checkPassword() {
            const enteredPassword = document.getElementById('quizPasswordInput').value;
            const correctPassword = quizData.security.password;
            
            if (enteredPassword === correctPassword) {
                document.getElementById('passwordModalBackdrop').classList.remove('active');
                document.getElementById('passwordModal').classList.remove('active');
                window.passwordCheckResolve(true);
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('quizPasswordInput').value = '';
                document.getElementById('quizPasswordInput').focus();
            }
        }
        
        async function setupWebcam() {
            document.getElementById('webcamModalBackdrop').classList.add('active');
            document.getElementById('webcamModal').classList.add('active');
            
            try {
                const video = document.getElementById('webcamPreview');
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = webcamStream;
                
                return new Promise((resolve) => {
                    window.webcamSetupResolve = resolve;
                });
            } catch (error) {
                console.error('Webcam error:', error);
                LMS.showToast(LMS.t('quiz.webcamError'), 'error');
                return false;
            }
        }
        
        function captureWebcamPhoto() {
            const video = document.getElementById('webcamPreview');
            const canvas = document.getElementById('webcamCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, 640, 480);
            
            const imageData = canvas.toDataURL('image/png');
            document.getElementById('capturedImage').src = imageData;
            document.getElementById('capturedPhoto').style.display = 'block';
            document.getElementById('proceedWithWebcam').disabled = false;
            
            // Store the captured image (in a real app, this would be sent to server)
            securityLogs.push({
                type: 'webcam_capture',
                timestamp: new Date().toISOString(),
                data: imageData
            });
        }
        
        function proceedAfterWebcam() {
            document.getElementById('webcamModalBackdrop').classList.remove('active');
            document.getElementById('webcamModal').classList.remove('active');
            window.webcamSetupResolve(true);
        }
        
        function cancelWebcamVerification() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('webcamModalBackdrop').classList.remove('active');
            document.getElementById('webcamModal').classList.remove('active');
            window.webcamSetupResolve(false);
        }
        
        async function enterFullscreen() {
            try {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    await elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    await elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    await elem.msRequestFullscreen();
                }
            } catch (error) {
                console.error('Fullscreen error:', error);
            }
        }
        
        function initializeSecurityFeatures() {
            const security = quizData.security;
            
            // Prevent tab switching
            if (security.preventTabSwitch || security.trackFocusLoss) {
                document.addEventListener('visibilitychange', handleVisibilityChange);
                window.addEventListener('blur', handleWindowBlur);
            }
            
            // Disable copy/paste
            if (security.disableCopyPaste) {
                document.addEventListener('copy', (e) => e.preventDefault());
                document.addEventListener('paste', (e) => e.preventDefault());
                document.addEventListener('cut', (e) => e.preventDefault());
            }
            
            // Browser lockdown
            if (security.browserLockdown) {
                // Disable right-click
                document.addEventListener('contextmenu', (e) => e.preventDefault());
                
                // Disable certain keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
                    if (e.keyCode === 123 || 
                        (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
                        (e.ctrlKey && e.keyCode === 85)) {
                        e.preventDefault();
                    }
                });
            }
            
            // Record answer changes
            if (security.recordAnswerChanges) {
                // This is handled in saveAnswer function
            }
            
            // Screenshot capture
            if (security.captureScreenshots && security.webcamRequired) {
                screenshotInterval = setInterval(captureScreenshot, 60000); // Every minute
            }
            
            // Fullscreen exit prevention
            if (security.fullScreenMode) {
                document.addEventListener('fullscreenchange', handleFullscreenChange);
            }
        }
        
        function handleVisibilityChange() {
            if (document.hidden && quizData.security.trackFocusLoss) {
                focusLossCount++;
                securityLogs.push({
                    type: 'focus_loss',
                    timestamp: new Date().toISOString(),
                    count: focusLossCount
                });
                
                document.getElementById('focusLossCount').textContent = focusLossCount;
                document.getElementById('focusLossModalBackdrop').classList.add('active');
                document.getElementById('focusLossModal').classList.add('active');
            }
        }
        
        function handleWindowBlur() {
            if (quizData.security.preventTabSwitch) {
                // Log the event
                securityLogs.push({
                    type: 'window_blur',
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        function handleFullscreenChange() {
            if (!document.fullscreenElement && quizData.security.fullScreenMode) {
                LMS.showToast(LMS.t('quiz.fullscreenRequired'), 'warning');
                enterFullscreen();
            }
        }
        
        function closeFocusLossWarning() {
            document.getElementById('focusLossModalBackdrop').classList.remove('active');
            document.getElementById('focusLossModal').classList.remove('active');
        }
        
        function captureScreenshot() {
            if (webcamStream) {
                const video = document.getElementById('webcamPreview');
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 240;
                const ctx = canvas.getContext('2d');
                
                // Create a temporary video element for screenshot
                const tempVideo = document.createElement('video');
                tempVideo.srcObject = webcamStream;
                tempVideo.play();
                
                setTimeout(() => {
                    ctx.drawImage(tempVideo, 0, 0, 320, 240);
                    const imageData = canvas.toDataURL('image/jpeg', 0.5);
                    
                    securityLogs.push({
                        type: 'periodic_screenshot',
                        timestamp: new Date().toISOString(),
                        data: imageData
                    });
                }, 100);
            }
        }
        
        // Override saveAnswer to include change tracking
        const originalSaveAnswer = saveAnswer;
        saveAnswer = function(answer) {
            if (quizData.security.recordAnswerChanges) {
                const previousAnswer = userAnswers[quizData.questions[currentQuestionIndex].id];
                if (previousAnswer !== undefined) {
                    securityLogs.push({
                        type: 'answer_change',
                        timestamp: new Date().toISOString(),
                        questionId: quizData.questions[currentQuestionIndex].id,
                        from: previousAnswer,
                        to: answer
                    });
                }
            }
            originalSaveAnswer(answer);
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
