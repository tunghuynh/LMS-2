<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Builder - LMS</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Configuration -->
    <script src="../config.js"></script>
</head>
<body>
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="flex-between">
                <div>
                    <h1 class="page-title" id="pageTitle" data-translate="quiz.createQuiz">Create Quiz</h1>
                    <p class="page-subtitle" data-translate="quiz.builderSubtitle">Build your quiz with questions and settings</p>
                </div>
                <div class="flex flex-gap-3">
                    <button class="btn btn--secondary" onclick="importFromExcel()">
                        <i class="fas fa-file-excel" class="icon-mr"></i>
                        <span data-translate="quiz.importExcel">Import Excel</span>
                    </button>
                    <button class="btn btn--secondary" onclick="exportToExcel()">
                        <i class="fas fa-download" class="icon-mr"></i>
                        <span data-translate="quiz.exportExcel">Export Excel</span>
                    </button>
                    <button class="btn btn--secondary" onclick="previewQuiz()">
                        <i class="fas fa-eye" class="icon-mr"></i>
                        <span data-translate="quiz.preview">Preview</span>
                    </button>
                    <button class="btn btn--secondary" onclick="saveAsTemplate()" id="saveTemplateBtn">
                        <i class="fas fa-file-archive" class="icon-mr"></i>
                        <span data-translate="quiz.saveAsTemplate">Save as Template</span>
                    </button>
                    <button class="btn btn--secondary" onclick="saveDraft()" id="saveDraftBtn">
                        <i class="fas fa-save" class="icon-mr"></i>
                        <span data-translate="quiz.saveDraft">Save Draft</span>
                    </button>
                    <button class="btn btn--success" onclick="publishQuiz()" id="publishBtn">
                        <i class="fas fa-rocket" class="icon-mr"></i>
                        <span data-translate="quiz.publish">Publish</span>
                    </button>
                    <button class="btn btn--ghost" onclick="goBack()">
                        <i class="fas fa-times" class="icon-mr"></i>
                        <span data-translate="common.cancel">Cancel</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="page-content">
            <!-- Two Column Layout: Sidebar + Main Content -->
            <div class="two-column-layout">
                <!-- Sidebar -->
                <div class="sidebar-column">
                    <!-- Quiz Info Section -->
                    <div class="card mb-4">
                        <div class="card__header">
                            <h3 data-translate="quiz.basicInfo">Basic Information</h3>
                        </div>
                        <div class="card__body">
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.title">Quiz Title</label>
                                <input type="text" id="quizTitle" class="input" placeholder="Enter quiz title..." 
                                       data-translate-placeholder="quiz.titlePlaceholder">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.description">Description</label>
                                <textarea id="quizDescription" class="input" rows="3" placeholder="Enter quiz description..."
                                          data-translate-placeholder="quiz.descriptionPlaceholder"></textarea>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="course.selectCourse">Course</label>
                                <div class="dropdown dropdown--block" id="quizCourseDropdown">
                                    <button class="dropdown__trigger">
                                        <span data-translate="common.selectOption">Select a course...</span>
                                        <span class="dropdown__arrow"></span>
                                    </button>
                                    <div class="dropdown__menu">
                                        <div class="dropdown__list" id="quizCourseList">
                                            <!-- Course options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Settings -->
                    <div class="card" class="mb-4">
                        <div class="card__header">
                            <h3 data-translate="quiz.settings">Quiz Settings</h3>
                        </div>
                        <div class="card__body">
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.timeLimit">Time Limit (minutes)</label>
                                <input type="number" id="quizTimeLimit" class="input" value="60" min="1" max="300">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.passingScore">Passing Score (%)</label>
                                <input type="number" id="quizPassingScore" class="input" value="70" min="0" max="100">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.maxAttempts">Max Attempts</label>
                                <div class="dropdown dropdown--block" id="quizMaxAttemptsDropdown">
                                    <button class="dropdown__trigger">
                                        <span>3 attempts</span>
                                        <span class="dropdown__arrow"></span>
                                    </button>
                                    <div class="dropdown__menu">
                                        <div class="dropdown__list">
                                            <div class="dropdown__item" data-value="1">1 attempt</div>
                                            <div class="dropdown__item" data-value="2">2 attempts</div>
                                            <div class="dropdown__item dropdown__item--selected" data-value="3">3 attempts</div>
                                            <div class="dropdown__item" data-value="5">5 attempts</div>
                                            <div class="dropdown__item" data-value="-1" data-translate="quiz.unlimited">Unlimited</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizShuffleQuestions">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.shuffleQuestions">Shuffle Questions</span>
                                </label>
                            </div>
                            
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizShowResults">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.showResults">Show Results Immediately</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Question Pools & Randomization -->
                    <div class="card mb-4">
                        <div class="card__header">
                            <h3 data-translate="quiz.questionPools">Question Pools</h3>
                        </div>
                        <div class="card__body">
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizUseRandomPools" onchange="toggleQuestionPools()">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.useQuestionPools">Use question pools for randomization</span>
                                </label>
                            </div>
                            
                            <div id="questionPoolsContainer" style="display: none; margin-top: var(--spacing-3);">
                                <div class="input-group">
                                    <label class="input-group__label" data-translate="quiz.poolStrategy">Pool Strategy</label>
                                    <div class="dropdown dropdown--block" id="poolStrategyDropdown">
                                        <button class="dropdown__trigger">
                                            <span data-translate="quiz.randomSelection">Random Selection</span>
                                            <span class="dropdown__arrow"></span>
                                        </button>
                                        <div class="dropdown__menu">
                                            <div class="dropdown__list">
                                                <div class="dropdown__item" data-value="random">Random Selection</div>
                                                <div class="dropdown__item" data-value="balanced">Balanced by Difficulty</div>
                                                <div class="dropdown__item" data-value="adaptive">Adaptive Testing</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label class="input-group__label" data-translate="quiz.questionsPerAttempt">Questions per attempt</label>
                                    <input type="number" id="questionsPerAttempt" class="input" value="10" min="1" max="50">
                                    <span class="input-group__help" data-translate="quiz.poolHelp">
                                        Number of questions to randomly select from the pool
                                    </span>
                                </div>
                                
                                <button class="btn btn--secondary btn--small" onclick="openPoolManager()">
                                    <i class="fas fa-layer-group" class="icon-mr"></i>
                                    <span data-translate="quiz.manageQuestionPools">Manage Question Pools</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Version Control -->
                    <div class="card mb-4">
                        <div class="card__header">
                            <h3 data-translate="quiz.versionControl">Version Control</h3>
                        </div>
                        <div class="card__body">
                            <div class="version-info">
                                <p class="text-sm text-secondary" data-translate="quiz.currentVersion">Current Version: v1.0</p>
                                <p class="text-sm text-secondary" data-translate="quiz.lastModified">Last Modified: Today</p>
                            </div>
                            
                            <div class="flex flex-gap-2 mt-3">
                                <button class="btn btn--secondary btn--small" onclick="viewVersionHistory()">
                                    <i class="fas fa-history" class="icon-mr"></i>
                                    <span data-translate="quiz.viewHistory">View History</span>
                                </button>
                                <button class="btn btn--secondary btn--small" onclick="createVersion()">
                                    <i class="fas fa-code-branch" class="icon-mr"></i>
                                    <span data-translate="quiz.createVersion">Create Version</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="card" style="margin-bottom: var(--spacing-4);">
                        <div class="card__header">
                            <h3 data-translate="quiz.securitySettings">Security Settings</h3>
                        </div>
                        <div class="card__body">
                            <!-- Password Protection -->
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizPasswordEnabled" onchange="togglePasswordField()">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.passwordProtection">Enable password protection</span>
                                </label>
                                <div id="passwordFieldContainer" style="display: none; margin-top: var(--spacing-2); margin-left: var(--spacing-6);">
                                    <input type="text" id="quizPassword" class="input" placeholder="Enter quiz password...">
                                </div>
                            </div>

                            <!-- Access Time Restrictions -->
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizTimeWindowEnabled" onchange="toggleTimeWindow()">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.timeWindowRestriction">Restrict access time window</span>
                                </label>
                                <div id="timeWindowContainer" style="display: none; margin-top: var(--spacing-2); margin-left: var(--spacing-6);">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-2);">
                                        <div>
                                            <label class="input-group__label" data-translate="quiz.startTime">Start Time</label>
                                            <input type="datetime-local" id="quizStartTime" class="input">
                                        </div>
                                        <div>
                                            <label class="input-group__label" data-translate="quiz.endTime">End Time</label>
                                            <input type="datetime-local" id="quizEndTime" class="input">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Anti-Cheating Features -->
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.antiCheatingFeatures">Anti-Cheating Features</label>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizPreventTabSwitch">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.preventTabSwitch">Prevent tab switching (warns on focus loss)</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizFullScreenMode">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.fullScreenMode">Require full-screen mode</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizDisableCopyPaste">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.disableCopyPaste">Disable copy/paste functionality</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizRandomizeQuestions" checked>
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.randomizeQuestions">Randomize question order</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizRandomizeOptions" checked>
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.randomizeOptions">Randomize answer options</span>
                                    </label>
                                </div>
                            </div>

                            <!-- IP Restrictions -->
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizIPRestriction" onchange="toggleIPRestriction()">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.ipRestriction">Restrict to specific IP addresses</span>
                                </label>
                                <div id="ipRestrictionContainer" style="display: none; margin-top: var(--spacing-2); margin-left: var(--spacing-6);">
                                    <textarea id="quizAllowedIPs" class="input input--textarea" rows="3" 
                                              placeholder="Enter allowed IP addresses or ranges (one per line)..."
                                              data-translate-placeholder="quiz.ipAddressesPlaceholder"></textarea>
                                    <div class="input-group__help" data-translate="quiz.ipAddressesHelp">
                                        Example: 192.168.1.0/24 or 192.168.1.100
                                    </div>
                                </div>
                            </div>

                            <!-- Time Limit Per Question -->
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizTimeLimitPerQuestion" onchange="toggleQuestionTimeLimit()">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.timeLimitPerQuestion">Set time limit per question</span>
                                </label>
                                <div id="questionTimeLimitContainer" style="display: none; margin-top: var(--spacing-2); margin-left: var(--spacing-6);">
                                    <div style="display: flex; align-items: center; gap: var(--spacing-2);">
                                        <input type="number" id="quizQuestionTimeLimit" class="input" value="60" min="10" max="300" style="width: 100px;">
                                        <span data-translate="quiz.secondsPerQuestion">seconds per question</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Browser Lockdown -->
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizBrowserLockdown">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.browserLockdown">Enable browser lockdown mode (experimental)</span>
                                </label>
                                <div class="input-group__help" data-translate="quiz.browserLockdownHelp">
                                    This will attempt to prevent right-click, dev tools, and keyboard shortcuts
                                </div>
                            </div>

                            <!-- Activity Monitoring -->
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.activityMonitoring">Activity Monitoring</label>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizTrackFocusLoss">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.trackFocusLoss">Track focus loss events</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizRecordAnswerChanges">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.recordAnswerChanges">Record answer change history</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizCaptureScreenshots">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.captureScreenshots">Capture periodic screenshots (requires permission)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Proctoring Options -->
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.proctoringOptions">Proctoring Options</label>
                                <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizWebcamRequired" onchange="toggleProctoringSettings()">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.webcamRequired">Require webcam verification</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizIdVerification">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.idVerification">Require ID verification before starting</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="quizLiveProctoring">
                                        <span class="checkbox-custom"></span>
                                        <span data-translate="quiz.liveProctoring">Enable live proctoring (requires proctor assignment)</span>
                                    </label>
                                </div>
                                <div id="proctoringSettingsContainer" style="display: none; margin-top: var(--spacing-2); margin-left: var(--spacing-6);">
                                    <div class="alert alert--info" style="margin-top: var(--spacing-2);">
                                        <i class="fas fa-info-circle"></i>
                                        <span data-translate="quiz.proctoringInfo">
                                            Webcam proctoring will capture periodic snapshots during the quiz
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Main Content Area -->
                <div class="main-column">
                    <div id="questionsContainer" style="padding: var(--spacing-4);">
                        <!-- Welcome State -->
                        <div id="welcomeState" class="card" class="text-center p-8">
                            <i class="fas fa-question-circle" class="text-64 text-muted mb-4"></i>
                            <h3 data-translate="quiz.welcomeTitle">Welcome to Quiz Builder</h3>
                            <p class="text-secondary mb-6" data-translate="quiz.welcomeMessage">
                                Start by filling in the quiz information on the left, then add your first question.
                            </p>
                            <button class="btn btn--primary" onclick="addQuestion()">
                                <i class="fas fa-plus-circle" class="icon-mr"></i>
                                <span data-translate="quiz.addFirstQuestion">Add Your First Question</span>
                            </button>
                        </div>

                        <!-- Questions will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Question Type Modal -->
    <div class="modal-backdrop" id="questionTypeModalBackdrop">
        <div class="modal modal--medium" id="questionTypeModal">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.selectQuestionType">Select Question Type</h2>
                <button class="modal__close" onclick="closeQuestionTypeModal()">×</button>
            </div>
            <div class="modal__body">
                <div class="grid grid--3-cols" class="grid-gap-4">
                    <div class="question-type-option" onclick="createQuestion('multiple-choice')">
                        <div class="question-type-card">
                            <i class="fas fa-list" class="text-2xl text-primary mb-2"></i>
                            <h4 data-translate="quiz.multipleChoice">Multiple Choice</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.multipleChoiceDesc">
                                Single correct answer from multiple options
                            </p>
                        </div>
                    </div>
                    
                    <div class="question-type-option" onclick="createQuestion('true-false')">
                        <div class="question-type-card">
                            <i class="fas fa-check-circle" class="text-2xl text-success mb-2"></i>
                            <h4 data-translate="quiz.trueFalse">True / False</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.trueFalseDesc">
                                Simple true or false question
                            </p>
                        </div>
                    </div>
                    
                    <div class="question-type-option" onclick="createQuestion('text-input')">
                        <div class="question-type-card">
                            <i class="fas fa-keyboard" class="text-2xl text-info mb-2"></i>
                            <h4 data-translate="quiz.textInput">Text Input</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.textInputDesc">
                                Open-ended text answer
                            </p>
                        </div>
                    </div>
                    
                    <div class="question-type-option" onclick="createQuestion('multiple-select')">
                        <div class="question-type-card">
                            <i class="fas fa-check-square" class="text-2xl text-warning mb-2"></i>
                            <h4 data-translate="quiz.multipleSelect">Multiple Select</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.multipleSelectDesc">
                                Multiple correct answers
                            </p>
                        </div>
                    </div>

                    <!-- Advanced Question Types -->
                    <div class="question-type-option" onclick="createQuestion('drag-drop')">
                        <div class="question-type-card">
                            <i class="fas fa-arrows-alt" class="text-2xl text-purple mb-2" style="color: #8B5CF6;"></i>
                            <h4 data-translate="quiz.dragDrop">Drag & Drop</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.dragDropDesc">
                                Match items by dragging
                            </p>
                        </div>
                    </div>

                    <div class="question-type-option" onclick="createQuestion('hotspot')">
                        <div class="question-type-card">
                            <i class="fas fa-crosshairs" class="text-2xl text-pink mb-2" style="color: #EC4899;"></i>
                            <h4 data-translate="quiz.hotspot">Hotspot</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.hotspotDesc">
                                Click on image areas
                            </p>
                        </div>
                    </div>

                    <div class="question-type-option" onclick="createQuestion('code')">
                        <div class="question-type-card">
                            <i class="fas fa-code" class="text-2xl text-indigo mb-2" style="color: #6366F1;"></i>
                            <h4 data-translate="quiz.code">Code Question</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.codeDesc">
                                Programming with syntax highlight
                            </p>
                        </div>
                    </div>

                    <div class="question-type-option" onclick="createQuestion('matching')">
                        <div class="question-type-card">
                            <i class="fas fa-project-diagram" class="text-2xl text-teal mb-2" style="color: #14B8A6;"></i>
                            <h4 data-translate="quiz.matching">Matching</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.matchingDesc">
                                Connect related items
                            </p>
                        </div>
                    </div>

                    <div class="question-type-option" onclick="createQuestion('ordering')">
                        <div class="question-type-card">
                            <i class="fas fa-sort" class="text-2xl text-orange mb-2" style="color: #F97316;"></i>
                            <h4 data-translate="quiz.ordering">Ordering</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.orderingDesc">
                                Arrange items in sequence
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Preview Modal -->
    <div class="modal-backdrop" id="quizPreview">
        <div class="modal modal--large">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.previewTitle">Quiz Preview</h2>
                <button class="modal__close" onclick="closePreview()">×</button>
            </div>
            <div class="modal__body">
                <div id="previewContent">
                    <!-- Dynamic preview content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Save as Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal__content">
            <div class="modal__header">
                <h3 data-translate="quiz.saveAsTemplate">Save as Template</h3>
                <button class="modal__close" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal__body">
                <form id="templateForm">
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateName">Template Name</label>
                        <input type="text" id="templateName" class="input" required 
                               data-translate-placeholder="quiz.templateNamePlaceholder">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateDescription">Template Description</label>
                        <textarea id="templateDescription" class="input input--textarea" rows="3" 
                                  data-translate-placeholder="quiz.templateDescPlaceholder"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateCategory">Category</label>
                        <div class="dropdown dropdown--block" id="templateCategoryDropdown">
                            <button class="dropdown__trigger">
                                <span data-translate="quiz.selectCategory">Select Category</span>
                                <span class="dropdown__arrow"></span>
                            </button>
                            <div class="dropdown__menu">
                                <div class="dropdown__list">
                                    <div class="dropdown__item" data-value="math" data-translate="quiz.math">Mathematics</div>
                                    <div class="dropdown__item" data-value="science" data-translate="quiz.science">Science</div>
                                    <div class="dropdown__item" data-value="language" data-translate="quiz.language">Language Arts</div>
                                    <div class="dropdown__item" data-value="business" data-translate="quiz.business">Business</div>
                                    <div class="dropdown__item" data-value="programming" data-translate="quiz.programming">Programming</div>
                                    <div class="dropdown__item" data-value="general" data-translate="quiz.general">General Knowledge</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateDifficulty">Difficulty Level</label>
                        <div class="dropdown dropdown--block" id="templateDifficultyDropdown">
                            <button class="dropdown__trigger">
                                <span data-translate="quiz.selectDifficulty">Select Difficulty</span>
                                <span class="dropdown__arrow"></span>
                            </button>
                            <div class="dropdown__menu">
                                <div class="dropdown__list">
                                    <div class="dropdown__item" data-value="easy" data-translate="quiz.easy">Easy</div>
                                    <div class="dropdown__item" data-value="medium" data-translate="quiz.medium">Medium</div>
                                    <div class="dropdown__item" data-value="hard" data-translate="quiz.hard">Hard</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateTags">Tags (comma-separated)</label>
                        <input type="text" id="templateTags" class="input" 
                               data-translate-placeholder="quiz.templateTagsPlaceholder">
                        <div class="input-group__help" data-translate="quiz.templateTagsHelp">
                            Add relevant tags to help others find your template
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateSharing">Sharing Settings</label>
                        <div class="flex flex-col flex-gap-2">
                            <label class="checkbox-label">
                                <input type="radio" name="sharing" value="private" checked>
                                <span class="radio-custom"></span>
                                <div>
                                    <span data-translate="quiz.privateTemplate">Private</span>
                                    <small class="block text-secondary" data-translate="quiz.privateTemplateDesc">
                                        Only you can see and use this template
                                    </small>
                                </div>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="radio" name="sharing" value="public">
                                <span class="radio-custom"></span>
                                <div>
                                    <span data-translate="quiz.publicTemplate">Public</span>
                                    <small class="block text-secondary" data-translate="quiz.publicTemplateDesc">
                                        Available to all teachers in the system
                                    </small>
                                </div>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="radio" name="sharing" value="school">
                                <span class="radio-custom"></span>
                                <div>
                                    <span data-translate="quiz.schoolTemplate">School Only</span>
                                    <small class="block text-secondary" data-translate="quiz.schoolTemplateDesc">
                                        Available to teachers in your school
                                    </small>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="template-summary" class="bg-secondary p-4 rounded-md mt-4">
                        <h4 class="mb-3" data-translate="quiz.templateSummary">Template Summary</h4>
                        <div class="grid grid-auto-fit-xs grid-gap-3">
                            <div class="text-center">
                                <div class="text-xl font-bold text-primary" id="summaryQuestions">0</div>
                                <div class="text-sm text-secondary" data-translate="quiz.questions">Questions</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-success" id="summaryPoints">0</div>
                                <div class="text-sm text-secondary" data-translate="quiz.totalPoints">Total Points</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-info" id="summaryTime">0</div>
                                <div class="text-sm text-secondary" data-translate="quiz.estimatedTime">Est. Time</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" onclick="closeTemplateModal()">
                    <i class="fas fa-times" class="icon-mr"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button type="button" class="btn btn--primary" onclick="confirmSaveTemplate()">
                    <i class="fas fa-save" class="icon-mr"></i>
                    <span data-translate="quiz.saveTemplate">Save Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Question Pool Manager Modal -->
    <div class="modal-backdrop" id="poolManagerModal">
        <div class="modal modal--large">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.questionPoolManager">Question Pool Manager</h2>
                <button class="modal__close" onclick="closePoolManager()">×</button>
            </div>
            <div class="modal__body">
                <div class="pool-manager-content">
                    <!-- Pool List -->
                    <div class="pool-list">
                        <div class="pool-header flex-between mb-3">
                            <h3 data-translate="quiz.questionPools">Question Pools</h3>
                            <button class="btn btn--primary btn--small" onclick="createNewPool()">
                                <i class="fas fa-plus" class="icon-mr"></i>
                                <span data-translate="quiz.createPool">Create Pool</span>
                            </button>
                        </div>
                        
                        <div id="poolsList">
                            <!-- Dynamic pool items -->
                            <div class="pool-item">
                                <div class="pool-item__header">
                                    <h4>Easy Questions</h4>
                                    <span class="badge badge--info">15 questions</span>
                                </div>
                                <div class="pool-item__actions">
                                    <button class="btn btn--ghost btn--small" onclick="editPool('pool1')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--ghost btn--small" onclick="deletePool('pool1')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="pool-item">
                                <div class="pool-item__header">
                                    <h4>Medium Questions</h4>
                                    <span class="badge badge--warning">20 questions</span>
                                </div>
                                <div class="pool-item__actions">
                                    <button class="btn btn--ghost btn--small" onclick="editPool('pool2')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn--ghost btn--small" onclick="deletePool('pool2')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pool Details -->
                    <div class="pool-details">
                        <h3 data-translate="quiz.poolDetails">Pool Details</h3>
                        <div class="alert alert--info">
                            <i class="fas fa-info-circle"></i>
                            <span data-translate="quiz.selectPoolToEdit">Select a pool to view and edit questions</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Modal -->
    <div class="modal-backdrop" id="versionHistoryModal">
        <div class="modal modal--large">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.versionHistory">Version History</h2>
                <button class="modal__close" onclick="closeVersionHistory()">×</button>
            </div>
            <div class="modal__body">
                <div class="version-timeline">
                    <!-- Version items -->
                    <div class="version-item">
                        <div class="version-item__marker"></div>
                        <div class="version-item__content">
                            <div class="version-item__header">
                                <h4>Version 1.2 <span class="badge badge--success">Current</span></h4>
                                <span class="text-sm text-secondary">Modified 2 hours ago by You</span>
                            </div>
                            <div class="version-item__changes">
                                <ul class="text-sm">
                                    <li>Added 3 new questions</li>
                                    <li>Updated passing score to 80%</li>
                                    <li>Enabled question shuffling</li>
                                </ul>
                            </div>
                            <div class="version-item__actions">
                                <button class="btn btn--secondary btn--small" onclick="viewVersion('v1.2')">
                                    <i class="fas fa-eye" class="icon-mr"></i>
                                    <span data-translate="quiz.view">View</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="version-item">
                        <div class="version-item__marker"></div>
                        <div class="version-item__content">
                            <div class="version-item__header">
                                <h4>Version 1.1</h4>
                                <span class="text-sm text-secondary">Modified yesterday by John Doe</span>
                            </div>
                            <div class="version-item__changes">
                                <ul class="text-sm">
                                    <li>Fixed typo in question 5</li>
                                    <li>Added time limit of 60 minutes</li>
                                </ul>
                            </div>
                            <div class="version-item__actions">
                                <button class="btn btn--secondary btn--small" onclick="viewVersion('v1.1')">
                                    <i class="fas fa-eye" class="icon-mr"></i>
                                    <span data-translate="quiz.view">View</span>
                                </button>
                                <button class="btn btn--secondary btn--small" onclick="restoreVersion('v1.1')">
                                    <i class="fas fa-undo" class="icon-mr"></i>
                                    <span data-translate="quiz.restore">Restore</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="version-item">
                        <div class="version-item__marker"></div>
                        <div class="version-item__content">
                            <div class="version-item__header">
                                <h4>Version 1.0</h4>
                                <span class="text-sm text-secondary">Created 3 days ago by You</span>
                            </div>
                            <div class="version-item__changes">
                                <ul class="text-sm">
                                    <li>Initial quiz creation</li>
                                    <li>10 questions added</li>
                                </ul>
                            </div>
                            <div class="version-item__actions">
                                <button class="btn btn--secondary btn--small" onclick="viewVersion('v1.0')">
                                    <i class="fas fa-eye" class="icon-mr"></i>
                                    <span data-translate="quiz.view">View</span>
                                </button>
                                <button class="btn btn--secondary btn--small" onclick="restoreVersion('v1.0')">
                                    <i class="fas fa-undo" class="icon-mr"></i>
                                    <span data-translate="quiz.restore">Restore</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="../assets/js/global.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    
    <script>
        // State management
        let currentQuiz = {
            id: null,
            title: '',
            description: '',
            courseId: '',
            timeLimit: 60,
            passingScore: 70,
            maxAttempts: 3,
            shuffleQuestions: false,
            showResults: false,
            questions: [],
            status: 'draft',
            // Security settings
            security: {
                passwordEnabled: false,
                password: '',
                timeWindowEnabled: false,
                startTime: null,
                endTime: null,
                preventTabSwitch: false,
                fullScreenMode: false,
                disableCopyPaste: false,
                randomizeQuestions: true,
                randomizeOptions: true,
                ipRestriction: false,
                allowedIPs: [],
                timeLimitPerQuestion: false,
                questionTimeLimit: 60,
                browserLockdown: false,
                trackFocusLoss: false,
                recordAnswerChanges: false,
                captureScreenshots: false,
                webcamRequired: false,
                idVerification: false,
                liveProctoring: false
            }
        };
        
        let allCourses = [];
        let currentUser = null;
        let activeQuestionId = null;
        let isEditMode = false;
        let questionIdCounter = 1;

        // Excel Import/Export Functions
        function importFromExcel() {
            // Create file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls,.csv';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // Show loading message
                LMS.showToast('Importing quiz from Excel...', 'info');
                
                // Simulate file processing (in real app, would use SheetJS or similar)
                setTimeout(() => {
                    // Mock import - in real implementation, would parse Excel file
                    const importedQuestions = [
                        {
                            id: 'q_' + Date.now(),
                            type: 'multiple-choice',
                            question: 'Sample imported question from Excel?',
                            points: 10,
                            options: [
                                { id: 'opt_1', text: 'Option A', correct: false },
                                { id: 'opt_2', text: 'Option B', correct: true },
                                { id: 'opt_3', text: 'Option C', correct: false },
                                { id: 'opt_4', text: 'Option D', correct: false }
                            ]
                        }
                    ];
                    
                    // Add imported questions to current quiz
                    importedQuestions.forEach(q => {
                        currentQuiz.questions.push(q);
                    });
                    
                    updateQuestionsContainer();
                    updateQuestionCount();
                    
                    LMS.showToast(`Successfully imported ${importedQuestions.length} questions!`, 'success');
                }, 1500);
            };
            
            // Show download template option
            if (confirm('Would you like to download the Excel template first?\n\nThe template shows the correct format for importing questions.')) {
                downloadExcelTemplate();
            } else {
                fileInput.click();
            }
        }
        
        function downloadExcelTemplate() {
            // Create template data
            const templateData = [
                ['Quiz Import Template - LMS'],
                [''],
                ['Instructions:'],
                ['1. Fill in the quiz information in the cells below'],
                ['2. Add questions starting from row 10'],
                ['3. For multiple choice questions, mark correct answers with "X" in the Correct column'],
                ['4. Save as Excel file and import back to the system'],
                [''],
                ['Quiz Title:', 'Your Quiz Title Here'],
                ['Description:', 'Quiz description here'],
                ['Time Limit (minutes):', '60'],
                ['Passing Score (%):', '70'],
                [''],
                ['Question Type', 'Question Text', 'Points', 'Option A', 'Option B', 'Option C', 'Option D', 'Correct A', 'Correct B', 'Correct C', 'Correct D'],
                ['multiple-choice', 'What is 2 + 2?', '10', '3', '4', '5', '6', '', 'X', '', ''],
                ['multiple-choice', 'Which is a primary color?', '10', 'Red', 'Orange', 'Purple', 'Pink', 'X', '', '', ''],
                ['true-false', 'The Earth is flat', '5', 'True', 'False', '', '', '', 'X', '', ''],
                ['text', 'Explain the theory of relativity', '20', '', '', '', '', '', '', '', '']
            ];
            
            // Convert to CSV format
            const csv = templateData.map(row => row.join(',')).join('\n');
            
            // Download CSV file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'quiz_import_template.csv';
            link.click();
            
            LMS.showToast('Template downloaded! Fill it out and import back.', 'success');
        }
        
        function exportToExcel() {
            if (currentQuiz.questions.length === 0) {
                LMS.showToast('No questions to export!', 'warning');
                return;
            }
            
            // Prepare export data
            const exportData = [
                ['Quiz Export - ' + (currentQuiz.title || 'Untitled Quiz')],
                ['Exported on: ' + new Date().toLocaleString()],
                [''],
                ['Quiz Information:'],
                ['Title:', currentQuiz.title],
                ['Description:', currentQuiz.description],
                ['Course:', document.querySelector('#quizCourseDropdown .dropdown__trigger span').textContent],
                ['Time Limit:', currentQuiz.timeLimit + ' minutes'],
                ['Passing Score:', currentQuiz.passingScore + '%'],
                ['Total Questions:', currentQuiz.questions.length],
                [''],
                ['Questions:'],
                ['#', 'Type', 'Question', 'Points', 'Options/Answer', 'Correct Answer']
            ];
            
            // Add questions to export
            currentQuiz.questions.forEach((q, index) => {
                const row = [index + 1, q.type, q.question, q.points];
                
                if (q.type === 'multiple-choice' || q.type === 'multiple-select') {
                    const options = q.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt.text}`).join(' | ');
                    const correct = q.options.filter(opt => opt.correct).map((opt, i) => {
                        const optIndex = q.options.indexOf(opt);
                        return String.fromCharCode(65 + optIndex);
                    }).join(', ');
                    row.push(options, correct);
                } else if (q.type === 'true-false') {
                    row.push('True/False', q.answer ? 'True' : 'False');
                } else if (q.type === 'text') {
                    row.push('Text Answer', 'Manual grading required');
                }
                
                exportData.push(row);
            });
            
            // Convert to CSV
            const csv = exportData.map(row => 
                row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',')
            ).join('\n');
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentQuiz.title || 'quiz'}_export_${Date.now()}.csv`;
            link.click();
            
            LMS.showToast('Quiz exported successfully!', 'success');
        }

        // Initialize
        async function init() {
            // Ensure auth is loaded first
            if (!LMS.Auth.currentUser) {
                LMS.Auth.loadSession();
            }
            
            // Get current user after auth is ready
            currentUser = LMS.Auth.getUser();
            
            // Check authentication - teachers and admins only
            if (!LMS.AccessControl.checkRole(['teacher', 'admin'])) {
                return;
            }

            // Load translations
            await LMS.LanguageManager.init();
            
            // Check if editing existing quiz
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('id');
            
            if (quizId) {
                isEditMode = true;
                document.getElementById('pageTitle').textContent = LMS.t('quiz.editQuiz');
                await loadQuiz(quizId);
            }
            
            // Load data
            await loadCourses();
            setupEventListeners();
            updateUI();
        }

        // Load courses for dropdown
        async function loadCourses() {
            try {
                const response = await LMS.API.loadJSON('mock-courses.json');
                allCourses = response.data || [];
                
                // Filter courses for teachers
                if (currentUser.role === 'teacher') {
                    allCourses = allCourses.filter(c => c.teacherId === currentUser.id);
                }
                
                populateCourseDropdown();
                
            } catch (error) {
                console.error('Failed to load courses:', error);
                LMS.showToast(LMS.t('error.loadData'), 'error');
            }
        }

        // Load existing quiz for editing
        async function loadQuiz(quizId) {
            try {
                // In a real app, this would load from API
                // For demo, we'll simulate loading
                LMS.showToast(LMS.t('quiz.loading'), 'info');
                
                // Simulate loading delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // For demo, create sample quiz data
                currentQuiz = {
                    id: quizId,
                    title: 'Sample Quiz',
                    description: 'This is a sample quiz for demonstration',
                    courseId: allCourses[0]?.id || '',
                    timeLimit: 45,
                    passingScore: 80,
                    maxAttempts: 2,
                    shuffleQuestions: true,
                    showResults: true,
                    status: 'draft',
                    questions: [
                        {
                            id: 'q1',
                            type: 'multiple-choice',
                            question: 'What is the capital of France?',
                            points: 1,
                            options: [
                                { id: 'o1', text: 'London', correct: false },
                                { id: 'o2', text: 'Paris', correct: true },
                                { id: 'o3', text: 'Berlin', correct: false },
                                { id: 'o4', text: 'Madrid', correct: false }
                            ]
                        },
                        {
                            id: 'q2',
                            type: 'true-false',
                            question: 'The Earth is flat.',
                            points: 1,
                            answer: false
                        }
                    ]
                };
                
                questionIdCounter = currentQuiz.questions.length + 1;
                
            } catch (error) {
                console.error('Failed to load quiz:', error);
                LMS.showToast(LMS.t('error.loadData'), 'error');
            }
        }

        // Populate course dropdown
        function populateCourseDropdown() {
            const courseOptions = allCourses.map(course => ({
                value: course.id,
                text: course.title
            }));
            
            LMS.Dropdown.populate('quizCourseDropdown', courseOptions, currentQuiz.courseId);
            
            // If no course selected, show default text
            if (!currentQuiz.courseId) {
                const trigger = document.querySelector('#quizCourseDropdown .dropdown__trigger span:first-child');
                trigger.textContent = LMS.t('common.selectOption');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Quiz info fields
            document.getElementById('quizTitle').addEventListener('input', (e) => {
                currentQuiz.title = e.target.value;
            });
            
            document.getElementById('quizDescription').addEventListener('input', (e) => {
                currentQuiz.description = e.target.value;
            });
            
            // Course dropdown is now handled by initDropdowns function
            
            // Quiz settings
            document.getElementById('quizTimeLimit').addEventListener('input', (e) => {
                currentQuiz.timeLimit = parseInt(e.target.value);
            });
            
            document.getElementById('quizPassingScore').addEventListener('input', (e) => {
                currentQuiz.passingScore = parseInt(e.target.value);
            });
            
            // Max attempts dropdown is now handled by initDropdowns function
            
            document.getElementById('quizShuffleQuestions').addEventListener('change', (e) => {
                currentQuiz.shuffleQuestions = e.target.checked;
            });
            
            document.getElementById('quizShowResults').addEventListener('change', (e) => {
                currentQuiz.showResults = e.target.checked;
            });

            // Security settings event listeners
            initializeSecuritySettings();

            // Question type modal styles
            document.addEventListener('click', function(e) {
                if (e.target.closest('.question-type-option')) {
                    const option = e.target.closest('.question-type-option');
                    const div = option.querySelector('div');
                    div.style.borderColor = 'var(--color-primary)';
                    div.style.backgroundColor = 'var(--color-primary-light, rgba(44, 110, 170, 0.1))';
                }
            });
        }

        // Update UI with current quiz data
        function updateUI() {
            // Update form fields
            document.getElementById('quizTitle').value = currentQuiz.title;
            document.getElementById('quizDescription').value = currentQuiz.description;
            // Course dropdown will be updated by populateCourseDropdown
            document.getElementById('quizTimeLimit').value = currentQuiz.timeLimit;
            document.getElementById('quizPassingScore').value = currentQuiz.passingScore;
            updateDropdownValue('quizMaxAttemptsDropdown', currentQuiz.maxAttempts);
            document.getElementById('quizShuffleQuestions').checked = currentQuiz.shuffleQuestions;
            document.getElementById('quizShowResults').checked = currentQuiz.showResults;
            
            // Update questions
            updateQuestionsList();
            updateQuestionsContainer();
            updateQuestionCount();
        }

        // Update questions list (removed - all operations now in main content area)
        function updateQuestionsList() {
            // This function is no longer needed as questions list has been removed
        }

        // Update main questions container
        function updateQuestionsContainer() {
            const container = document.getElementById('questionsContainer');
            
            if (currentQuiz.questions.length === 0) {
                container.innerHTML = `
                    <div id="welcomeState" class="card" class="text-center p-8">
                        <i class="fas fa-question-circle" class="text-64 text-muted mb-4"></i>
                        <h3 data-translate="quiz.welcomeTitle">Welcome to Quiz Builder</h3>
                        <p class="text-secondary mb-6" data-translate="quiz.welcomeMessage">
                            Start by filling in the quiz information on the left, then add your first question.
                        </p>
                        <button class="btn btn--primary" onclick="addQuestion()">
                            <i class="fas fa-plus-circle" class="icon-mr"></i>
                            <span data-translate="quiz.addFirstQuestion">Add Your First Question</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentQuiz.questions.map((question, index) => `
                <div class="question-container ${question.id === activeQuestionId ? 'active' : ''}" id="question-${question.id}">
                    <div class="question-toggle" onclick="selectQuestion('${question.id}')">
                        <div class="flex-items-center flex-gap-3">
                            <div class="question-counter">${index + 1}</div>
                            <div>
                                <div class="font-medium">${question.question}</div>
                                <div class="flex-items-center flex-gap-2 mt-1">
                                    <span class="question-type-badge badge badge--info">${getQuestionTypeName(question.type)}</span>
                                    <span class="text-sm text-secondary">${question.points || 1} ${question.points === 1 ? 'point' : 'points'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-gap-2">
                            <button class="btn btn--ghost btn--small" onclick="editQuestion('${question.id}'); event.stopPropagation();" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn--ghost btn--small" onclick="duplicateQuestion('${question.id}'); event.stopPropagation();" title="Duplicate">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn--ghost btn--small text-danger" onclick="deleteQuestion('${question.id}'); event.stopPropagation();" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="question-content">
                        ${renderQuestionEditor(question)}
                    </div>
                </div>
            `).join('');
            
            // Add the "Add Question" button at the end
            container.innerHTML += `
                <div class="text-center" style="margin-top: var(--spacing-6);">
                    <button class="btn btn--primary" onclick="addQuestion()">
                        <i class="fas fa-plus-circle" class="icon-mr"></i>
                        <span data-translate="quiz.addQuestion">Add Question</span>
                    </button>
                </div>
            `;
        }

        // Render question editor based on type
        function renderQuestionEditor(question) {
            switch (question.type) {
                case 'multiple-choice':
                case 'multiple-select':
                    return renderMultipleChoiceEditor(question);
                case 'true-false':
                    return renderTrueFalseEditor(question);
                case 'text-input':
                    return renderTextInputEditor(question);
                case 'drag-drop':
                    return renderDragDropEditor(question);
                case 'hotspot':
                    return renderHotspotEditor(question);
                case 'code':
                    return renderCodeEditor(question);
                case 'matching':
                    return renderMatchingEditor(question);
                case 'ordering':
                    return renderOrderingEditor(question);
                default:
                    return '<p>Unknown question type</p>';
            }
        }

        // Render multiple choice editor
        function renderMultipleChoiceEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.answerOptions">Answer Options</label>
                    <div id="options-${question.id}">
                        ${question.options.map(option => `
                            <div class="option-row ${option.correct ? 'correct' : ''}">
                                ${question.type === 'multiple-choice' ? 
                                    `<input type="radio" name="correct-${question.id}" ${option.correct ? 'checked' : ''} onchange="setCorrectOption('${question.id}', '${option.id}')">` :
                                    `<input type="checkbox" ${option.correct ? 'checked' : ''} onchange="toggleCorrectOption('${question.id}', '${option.id}')">`
                                }
                                <input type="text" class="input" value="${option.text}" onchange="updateOptionText('${question.id}', '${option.id}', this.value)" class="flex-1">
                                <button class="btn btn--ghost btn--small text-danger" onclick="removeOption('${question.id}', '${option.id}')" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn--secondary btn--small" onclick="addOption('${question.id}')" class="mt-2">
                        <i class="fas fa-plus" class="icon-mr"></i>
                        <span data-translate="quiz.addOption">Add Option</span>
                    </button>
                </div>
            `;
        }

        // Render true/false editor
        function renderTrueFalseEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.correctAnswer">Correct Answer</label>
                    <div class="flex flex-gap-4">
                        <label class="radio-label">
                            <input type="radio" name="answer-${question.id}" value="true" ${question.answer === true ? 'checked' : ''} onchange="updateTrueFalseAnswer('${question.id}', true)">
                            <span class="radio-custom"></span>
                            <span data-translate="quiz.true">True</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="answer-${question.id}" value="false" ${question.answer === false ? 'checked' : ''} onchange="updateTrueFalseAnswer('${question.id}', false)">
                            <span class="radio-custom"></span>
                            <span data-translate="quiz.false">False</span>
                        </label>
                    </div>
                </div>
            `;
        }

        // Render text input editor
        function renderTextInputEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.expectedAnswer">Expected Answer (for reference)</label>
                    <textarea class="input" rows="2" placeholder="Enter the expected answer for grading reference..." 
                              onchange="updateTextAnswer('${question.id}', this.value)">${question.expectedAnswer || ''}</textarea>
                    <span class="input-group__help" data-translate="quiz.textAnswerHelp">This answer will be used as a reference during manual grading.</span>
                </div>
            `;
        }

        // Render drag & drop editor
        function renderDragDropEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.dragDropPairs">Drag & Drop Pairs</label>
                    <div class="drag-drop-pairs">
                        ${(question.pairs || []).map((pair, index) => `
                            <div class="drag-drop-pair-row">
                                <input type="text" class="input" value="${pair.source}" 
                                       placeholder="Source item ${index + 1}" 
                                       onchange="updateDragDropPair('${question.id}', ${index}, 'source', this.value)">
                                <i class="fas fa-arrows-alt-h mx-3"></i>
                                <input type="text" class="input" value="${pair.target}" 
                                       placeholder="Target item ${index + 1}" 
                                       onchange="updateDragDropPair('${question.id}', ${index}, 'target', this.value)">
                                <button class="btn btn--ghost btn--small text-danger" onclick="removeDragDropPair('${question.id}', ${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn--secondary btn--small mt-2" onclick="addDragDropPair('${question.id}')">
                        <i class="fas fa-plus" class="icon-mr"></i>
                        <span data-translate="quiz.addPair">Add Pair</span>
                    </button>
                </div>
            `;
        }

        // Render hotspot editor
        function renderHotspotEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.uploadImage">Upload Image</label>
                    <div class="upload-area">
                        <input type="file" id="hotspot-image-${question.id}" accept="image/*" onchange="uploadHotspotImage('${question.id}', this)">
                        ${question.imageUrl ? `
                            <div class="uploaded-image mt-3">
                                <img src="${question.imageUrl}" alt="Hotspot image" style="max-width: 400px; max-height: 300px;">
                                <div class="mt-2">
                                    <button class="btn btn--secondary btn--small" onclick="defineHotspots('${question.id}')">
                                        <i class="fas fa-crosshairs" class="icon-mr"></i>
                                        <span data-translate="quiz.defineHotspots">Define Hotspots</span>
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <span class="input-group__help" data-translate="quiz.hotspotHelp">Upload an image and define clickable areas</span>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.hotspots">Defined Hotspots</label>
                    <div class="hotspot-list">
                        ${(question.hotspots || []).map((hotspot, index) => `
                            <div class="hotspot-item">
                                <span>${hotspot.label} (${hotspot.x}, ${hotspot.y})</span>
                                <button class="btn btn--ghost btn--small text-danger" onclick="removeHotspot('${question.id}', ${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Render code editor
        function renderCodeEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.programmingLanguage">Programming Language</label>
                    <div class="dropdown dropdown--block" id="codeLanguage-${question.id}">
                        <button class="dropdown__trigger">
                            <span>${question.language || 'JavaScript'}</span>
                            <span class="dropdown__arrow"></span>
                        </button>
                        <div class="dropdown__menu">
                            <div class="dropdown__list">
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'javascript')">JavaScript</div>
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'python')">Python</div>
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'java')">Java</div>
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'cpp')">C++</div>
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'csharp')">C#</div>
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'html')">HTML/CSS</div>
                                <div class="dropdown__item" onclick="setCodeLanguage('${question.id}', 'sql')">SQL</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.starterCode">Starter Code (Optional)</label>
                    <textarea class="input code-editor" rows="8" 
                              placeholder="// Provide starter code for students..."
                              onchange="updateCodeStarter('${question.id}', this.value)"
                              style="font-family: 'Courier New', monospace;">${question.starterCode || ''}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.expectedCode">Expected Solution (for reference)</label>
                    <textarea class="input code-editor" rows="8" 
                              placeholder="// Expected solution for grading reference..."
                              onchange="updateCodeSolution('${question.id}', this.value)"
                              style="font-family: 'Courier New', monospace;">${question.expectedCode || ''}</textarea>
                    <span class="input-group__help" data-translate="quiz.codeHelp">This will be used as reference during grading</span>
                </div>
                
                <div class="input-group">
                    <label class="checkbox-label">
                        <input type="checkbox" ${question.runnable ? 'checked' : ''} 
                               onchange="updateCodeRunnable('${question.id}', this.checked)">
                        <span class="checkbox-custom"></span>
                        <span data-translate="quiz.allowCodeRun">Allow students to run code</span>
                    </label>
                </div>
            `;
        }

        // Render matching editor
        function renderMatchingEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.matchingPairs">Matching Pairs</label>
                    <div class="matching-pairs">
                        <div class="matching-header">
                            <span class="flex-1" data-translate="quiz.leftColumn">Left Column</span>
                            <span class="flex-1" data-translate="quiz.rightColumn">Right Column</span>
                            <span style="width: 40px;"></span>
                        </div>
                        ${(question.matches || []).map((match, index) => `
                            <div class="matching-pair-row">
                                <input type="text" class="input" value="${match.left}" 
                                       placeholder="Left item ${index + 1}" 
                                       onchange="updateMatchingPair('${question.id}', ${index}, 'left', this.value)">
                                <input type="text" class="input" value="${match.right}" 
                                       placeholder="Right item ${index + 1}" 
                                       onchange="updateMatchingPair('${question.id}', ${index}, 'right', this.value)">
                                <button class="btn btn--ghost btn--small text-danger" onclick="removeMatchingPair('${question.id}', ${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn--secondary btn--small mt-2" onclick="addMatchingPair('${question.id}')">
                        <i class="fas fa-plus" class="icon-mr"></i>
                        <span data-translate="quiz.addMatch">Add Match</span>
                    </button>
                </div>
            `;
        }

        // Render ordering editor
        function renderOrderingEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.itemsInOrder">Items (in correct order)</label>
                    <div class="ordering-items">
                        ${(question.items || []).map((item, index) => `
                            <div class="ordering-item-row">
                                <span class="order-number">${index + 1}.</span>
                                <input type="text" class="input" value="${item}" 
                                       placeholder="Item ${index + 1}" 
                                       onchange="updateOrderingItem('${question.id}', ${index}, this.value)">
                                <div class="order-buttons">
                                    <button class="btn btn--ghost btn--small" onclick="moveOrderingItem('${question.id}', ${index}, -1)"
                                            ${index === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                    <button class="btn btn--ghost btn--small" onclick="moveOrderingItem('${question.id}', ${index}, 1)"
                                            ${index === (question.items || []).length - 1 ? 'disabled' : ''}>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <button class="btn btn--ghost btn--small text-danger" onclick="removeOrderingItem('${question.id}', ${index})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn--secondary btn--small mt-2" onclick="addOrderingItem('${question.id}')">
                        <i class="fas fa-plus" class="icon-mr"></i>
                        <span data-translate="quiz.addItem">Add Item</span>
                    </button>
                    <span class="input-group__help" data-translate="quiz.orderingHelp">Items will be shuffled when presented to students</span>
                </div>
            `;
        }

        // Get question type display name
        function getQuestionTypeName(type) {
            const names = {
                'multiple-choice': LMS.t('quiz.multipleChoice'),
                'multiple-select': LMS.t('quiz.multipleSelect'),
                'true-false': LMS.t('quiz.trueFalse'),
                'text-input': LMS.t('quiz.textInput'),
                'drag-drop': LMS.t('quiz.dragDrop'),
                'hotspot': LMS.t('quiz.hotspot'),
                'code': LMS.t('quiz.code'),
                'matching': LMS.t('quiz.matching'),
                'ordering': LMS.t('quiz.ordering')
            };
            return names[type] || type;
        }

        // Question management functions
        function addQuestion() {
            document.getElementById('questionTypeModalBackdrop').classList.add('active');
            document.getElementById('questionTypeModal').classList.add('active');
        }

        function closeQuestionTypeModal() {
            document.getElementById('questionTypeModalBackdrop').classList.remove('active');
            document.getElementById('questionTypeModal').classList.remove('active');
        }

        function createQuestion(type) {
            const questionId = 'q' + questionIdCounter++;
            
            let newQuestion = {
                id: questionId,
                type: type,
                question: 'Enter your question here...',
                points: 1
            };
            
            switch (type) {
                case 'multiple-choice':
                case 'multiple-select':
                    newQuestion.options = [
                        { id: 'o1', text: 'Option 1', correct: false },
                        { id: 'o2', text: 'Option 2', correct: false },
                        { id: 'o3', text: 'Option 3', correct: false },
                        { id: 'o4', text: 'Option 4', correct: false }
                    ];
                    break;
                case 'true-false':
                    newQuestion.answer = true;
                    break;
                case 'text-input':
                    newQuestion.expectedAnswer = '';
                    break;
                case 'drag-drop':
                    newQuestion.pairs = [
                        { source: 'Source 1', target: 'Target 1' },
                        { source: 'Source 2', target: 'Target 2' },
                        { source: 'Source 3', target: 'Target 3' }
                    ];
                    break;
                case 'hotspot':
                    newQuestion.imageUrl = '';
                    newQuestion.hotspots = [];
                    break;
                case 'code':
                    newQuestion.language = 'javascript';
                    newQuestion.starterCode = '';
                    newQuestion.expectedCode = '';
                    newQuestion.runnable = false;
                    break;
                case 'matching':
                    newQuestion.matches = [
                        { left: 'Item 1', right: 'Match 1' },
                        { left: 'Item 2', right: 'Match 2' },
                        { left: 'Item 3', right: 'Match 3' }
                    ];
                    break;
                case 'ordering':
                    newQuestion.items = [
                        'First item',
                        'Second item',
                        'Third item',
                        'Fourth item'
                    ];
                    break;
            }
            
            currentQuiz.questions.push(newQuestion);
            activeQuestionId = questionId;
            
            closeQuestionTypeModal();
            updateUI();
            
            // Scroll to new question
            setTimeout(() => {
                const element = document.getElementById(`question-${questionId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        function selectQuestion(questionId) {
            activeQuestionId = questionId;
            updateQuestionsList();
            updateQuestionsContainer();
        }

        function deleteQuestion(questionId) {
            if (!confirm(LMS.t('quiz.deleteQuestionConfirm'))) return;
            
            const index = currentQuiz.questions.findIndex(q => q.id === questionId);
            if (index !== -1) {
                currentQuiz.questions.splice(index, 1);
                
                // Reset active question if deleted
                if (activeQuestionId === questionId) {
                    activeQuestionId = null;
                }
                
                updateUI();
                LMS.showToast(LMS.t('quiz.questionDeleted'), 'success');
            }
        }

        function duplicateQuestion(questionId) {
            const originalQuestion = currentQuiz.questions.find(q => q.id === questionId);
            if (!originalQuestion) return;
            
            const newQuestion = {
                ...originalQuestion,
                id: 'q' + questionIdCounter++,
                question: originalQuestion.question + ' (Copy)'
            };
            
            // Duplicate options if they exist
            if (newQuestion.options) {
                newQuestion.options = newQuestion.options.map((option, index) => ({
                    ...option,
                    id: 'o' + (index + 1)
                }));
            }
            
            currentQuiz.questions.push(newQuestion);
            activeQuestionId = newQuestion.id;
            updateUI();
            
            LMS.showToast(LMS.t('quiz.questionDuplicated'), 'success');
        }

        // Question editing functions
        function updateQuestionText(questionId, text) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.question = text;
                updateQuestionsList();
            }
        }

        function updateQuestionPoints(questionId, points) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.points = parseInt(points) || 1;
            }
        }

        function updateTrueFalseAnswer(questionId, answer) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.answer = answer;
            }
        }

        function updateTextAnswer(questionId, answer) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.expectedAnswer = answer;
            }
        }

        function updateOptionText(questionId, optionId, text) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                const option = question.options.find(o => o.id === optionId);
                if (option) {
                    option.text = text;
                }
            }
        }

        function setCorrectOption(questionId, optionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                question.options.forEach(option => {
                    option.correct = option.id === optionId;
                });
                updateQuestionsContainer();
            }
        }

        function toggleCorrectOption(questionId, optionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                const option = question.options.find(o => o.id === optionId);
                if (option) {
                    option.correct = !option.correct;
                    updateQuestionsContainer();
                }
            }
        }

        function addOption(questionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                const newOptionId = 'o' + (question.options.length + 1);
                question.options.push({
                    id: newOptionId,
                    text: `Option ${question.options.length + 1}`,
                    correct: false
                });
                updateQuestionsContainer();
            }
        }

        function removeOption(questionId, optionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options && question.options.length > 2) {
                const index = question.options.findIndex(o => o.id === optionId);
                if (index !== -1) {
                    question.options.splice(index, 1);
                    updateQuestionsContainer();
                }
            } else {
                LMS.showToast(LMS.t('quiz.minimumOptions'), 'warning');
            }
        }

        // Advanced question type handlers
        
        // Drag & Drop handlers
        function updateDragDropPair(questionId, index, field, value) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.pairs && question.pairs[index]) {
                question.pairs[index][field] = value;
            }
        }

        function addDragDropPair(questionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.pairs) {
                question.pairs.push({
                    source: `Source ${question.pairs.length + 1}`,
                    target: `Target ${question.pairs.length + 1}`
                });
                updateQuestionsContainer();
            }
        }

        function removeDragDropPair(questionId, index) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.pairs && question.pairs.length > 1) {
                question.pairs.splice(index, 1);
                updateQuestionsContainer();
            } else {
                LMS.showToast('At least one pair is required', 'warning');
            }
        }

        // Hotspot handlers
        function uploadHotspotImage(questionId, input) {
            const file = input.files[0];
            if (file) {
                // In real implementation, upload to server
                // For demo, use local URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    const question = currentQuiz.questions.find(q => q.id === questionId);
                    if (question) {
                        question.imageUrl = e.target.result;
                        updateQuestionsContainer();
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        function defineHotspots(questionId) {
            // In real implementation, open image editor modal
            // For demo, add sample hotspot
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                if (!question.hotspots) question.hotspots = [];
                question.hotspots.push({
                    label: `Hotspot ${question.hotspots.length + 1}`,
                    x: Math.floor(Math.random() * 300),
                    y: Math.floor(Math.random() * 200),
                    radius: 20
                });
                updateQuestionsContainer();
                LMS.showToast('Hotspot added! In production, this would open an image editor.', 'info');
            }
        }

        function removeHotspot(questionId, index) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.hotspots) {
                question.hotspots.splice(index, 1);
                updateQuestionsContainer();
            }
        }

        // Code question handlers
        function setCodeLanguage(questionId, language) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.language = language;
                // Update dropdown display
                const dropdown = document.querySelector(`#codeLanguage-${questionId} .dropdown__trigger span`);
                if (dropdown) {
                    const languageNames = {
                        'javascript': 'JavaScript',
                        'python': 'Python',
                        'java': 'Java',
                        'cpp': 'C++',
                        'csharp': 'C#',
                        'html': 'HTML/CSS',
                        'sql': 'SQL'
                    };
                    dropdown.textContent = languageNames[language] || language;
                }
            }
        }

        function updateCodeStarter(questionId, code) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.starterCode = code;
            }
        }

        function updateCodeSolution(questionId, code) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.expectedCode = code;
            }
        }

        function updateCodeRunnable(questionId, runnable) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.runnable = runnable;
            }
        }

        // Matching handlers
        function updateMatchingPair(questionId, index, side, value) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.matches && question.matches[index]) {
                question.matches[index][side] = value;
            }
        }

        function addMatchingPair(questionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.matches) {
                question.matches.push({
                    left: `Item ${question.matches.length + 1}`,
                    right: `Match ${question.matches.length + 1}`
                });
                updateQuestionsContainer();
            }
        }

        function removeMatchingPair(questionId, index) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.matches && question.matches.length > 2) {
                question.matches.splice(index, 1);
                updateQuestionsContainer();
            } else {
                LMS.showToast('At least two matches are required', 'warning');
            }
        }

        // Ordering handlers
        function updateOrderingItem(questionId, index, value) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.items && question.items[index] !== undefined) {
                question.items[index] = value;
            }
        }

        function addOrderingItem(questionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.items) {
                question.items.push(`Item ${question.items.length + 1}`);
                updateQuestionsContainer();
            }
        }

        function removeOrderingItem(questionId, index) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.items && question.items.length > 2) {
                question.items.splice(index, 1);
                updateQuestionsContainer();
            } else {
                LMS.showToast('At least two items are required', 'warning');
            }
        }

        function moveOrderingItem(questionId, index, direction) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.items) {
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < question.items.length) {
                    [question.items[index], question.items[newIndex]] = 
                    [question.items[newIndex], question.items[index]];
                    updateQuestionsContainer();
                }
            }
        }

        function updateQuestionCount() {
            document.getElementById('questionCount').textContent = currentQuiz.questions.length;
        }

        // Quiz actions
        function saveDraft() {
            if (!validateQuiz()) return;
            
            currentQuiz.status = 'draft';
            saveQuiz();
        }

        function publishQuiz() {
            if (!validateQuiz(true)) return;
            
            currentQuiz.status = 'active';
            saveQuiz();
        }

        function saveQuiz() {
            // In a real app, this would save to API
            LMS.showToast(LMS.t('quiz.saving'), 'info');
            
            setTimeout(() => {
                LMS.showToast(LMS.t('quiz.saved'), 'success');
                // Redirect to quiz list
                window.location.href = 'quizzes.html';
            }, 1000);
        }

        function validateQuiz(forPublish = false) {
            if (!currentQuiz.title.trim()) {
                LMS.showToast(LMS.t('validation.titleRequired'), 'error');
                document.getElementById('quizTitle').focus();
                return false;
            }
            
            if (!currentQuiz.courseId) {
                LMS.showToast(LMS.t('validation.courseRequired'), 'error');
                document.getElementById('quizCourseDropdown').querySelector('.dropdown__trigger').focus();
                return false;
            }
            
            if (forPublish) {
                if (currentQuiz.questions.length === 0) {
                    LMS.showToast(LMS.t('validation.questionsRequired'), 'error');
                    return false;
                }
                
                // Validate each question has correct answers
                for (let question of currentQuiz.questions) {
                    if (question.type === 'multiple-choice' || question.type === 'multiple-select') {
                        const hasCorrect = question.options.some(o => o.correct);
                        if (!hasCorrect) {
                            LMS.showToast(LMS.t('validation.correctAnswerRequired'), 'error');
                            selectQuestion(question.id);
                            return false;
                        }
                    }
                }
            }
            
            return true;
        }

        function previewQuiz() {
            if (currentQuiz.questions.length === 0) {
                LMS.showToast(LMS.t('quiz.noQuestionsToPreview'), 'warning');
                return;
            }
            
            generatePreview();
            document.getElementById('quizPreview').classList.add('active');
        }

        function generatePreview() {
            const content = document.getElementById('previewContent');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h3>${currentQuiz.title}</h3>
                        <p class="text-secondary">${currentQuiz.description}</p>
                        <div class="flex flex-gap-4 mt-3 text-sm">
                            <span><i class="fas fa-clock"></i> ${currentQuiz.timeLimit} minutes</span>
                            <span><i class="fas fa-question-circle"></i> ${currentQuiz.questions.length} questions</span>
                            <span><i class="fas fa-trophy"></i> ${currentQuiz.passingScore}% to pass</span>
                        </div>
                    </div>
                    <div class="card__body">
                        ${currentQuiz.questions.map((question, index) => `
                            <div class="section-divider">
                                <h4 class="flex-items-center flex-gap-2">
                                    <span class="question-counter">${index + 1}</span>
                                    ${question.question}
                                </h4>
                                ${renderQuestionPreview(question)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderQuestionPreview(question) {
            switch (question.type) {
                case 'multiple-choice':
                    return `
                        <div class="mt-3">
                            ${question.options.map(option => `
                                <label class="radio-label" class="block mb-2">
                                    <input type="radio" name="preview-${question.id}" disabled>
                                    <span class="radio-custom"></span>
                                    <span>${option.text}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'multiple-select':
                    return `
                        <div class="mt-3">
                            ${question.options.map(option => `
                                <label class="checkbox-label" class="block mb-2">
                                    <input type="checkbox" disabled>
                                    <span class="checkbox-custom"></span>
                                    <span>${option.text}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'true-false':
                    return `
                        <div class="mt-3 flex flex-gap-4">
                            <label class="radio-label">
                                <input type="radio" name="preview-${question.id}" disabled>
                                <span class="radio-custom"></span>
                                <span>True</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="preview-${question.id}" disabled>
                                <span class="radio-custom"></span>
                                <span>False</span>
                            </label>
                        </div>
                    `;
                case 'text-input':
                    return `
                        <div class="mt-3">
                            <textarea class="input" rows="3" placeholder="Type your answer here..." disabled></textarea>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function closePreview() {
            document.getElementById('quizPreview').classList.remove('active');
        }

        function goBack() {
            if (confirm(LMS.t('quiz.unsavedChanges'))) {
                window.location.href = 'quizzes.html';
            }
        }

        // Template Creation Functions
        function saveAsTemplate() {
            // Validate quiz has questions
            if (questions.length === 0) {
                LMS.showToast(LMS.t('quiz.noQuestionsToSave'), 'error');
                return;
            }

            // Pre-fill template name with quiz title
            const quizTitle = document.getElementById('quizTitle').value;
            if (quizTitle) {
                document.getElementById('templateName').value = `${quizTitle} Template`;
            }

            // Update template summary
            updateTemplateSummary();

            // Show modal
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            // Reset form
            document.getElementById('templateForm').reset();
        }

        function updateTemplateSummary() {
            const questionCount = questions.length;
            const totalPoints = questions.reduce((sum, q) => sum + (parseInt(q.points) || 1), 0);
            const estimatedTime = Math.ceil(questionCount * 1.5); // 1.5 minutes per question

            document.getElementById('summaryQuestions').textContent = questionCount;
            document.getElementById('summaryPoints').textContent = totalPoints;
            document.getElementById('summaryTime').textContent = `${estimatedTime}m`;
        }

        function confirmSaveTemplate() {
            const form = document.getElementById('templateForm');
            
            // Validate required fields
            const templateName = document.getElementById('templateName').value.trim();
            const templateCategory = getDropdownValue('templateCategoryDropdown');
            const templateDifficulty = getDropdownValue('templateDifficultyDropdown');

            if (!templateName) {
                LMS.showToast(LMS.t('validation.templateNameRequired'), 'error');
                document.getElementById('templateName').focus();
                return;
            }

            if (!templateCategory) {
                LMS.showToast(LMS.t('validation.categoryRequired'), 'error');
                document.getElementById('templateCategoryDropdown').querySelector('.dropdown__trigger').focus();
                return;
            }

            if (!templateDifficulty) {
                LMS.showToast(LMS.t('validation.difficultyRequired'), 'error');
                document.getElementById('templateDifficultyDropdown').querySelector('.dropdown__trigger').focus();
                return;
            }

            // Gather template data
            const templateData = {
                id: `template_${Date.now()}`,
                name: templateName,
                description: document.getElementById('templateDescription').value.trim(),
                category: templateCategory,
                difficulty: templateDifficulty,
                tags: document.getElementById('templateTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                sharing: document.querySelector('input[name="sharing"]:checked').value,
                quiz: {
                    title: document.getElementById('quizTitle').value || templateName,
                    description: document.getElementById('quizDescription').value,
                    courseId: currentQuiz.courseId,
                    timeLimit: parseInt(document.getElementById('quizTimeLimit').value) || 30,
                    passingScore: parseInt(document.getElementById('quizPassingScore').value) || 70,
                    maxAttempts: currentQuiz.maxAttempts || 3,
                    shuffleQuestions: document.getElementById('quizShuffleQuestions').checked,
                    showResults: document.getElementById('quizShowResults').checked,
                    questions: questions
                },
                stats: {
                    questionCount: questions.length,
                    totalPoints: questions.reduce((sum, q) => sum + (parseInt(q.points) || 1), 0),
                    estimatedTime: Math.ceil(questions.length * 1.5)
                },
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                usageCount: 0
            };

            // Save template (in real implementation, this would be an API call)
            saveTemplateToStorage(templateData);

            // Close modal and show success
            closeTemplateModal();
            LMS.showToast(LMS.t('quiz.templateSaved').replace('{name}', templateName), 'success');

            // Optionally redirect to templates page
            setTimeout(() => {
                if (confirm(LMS.t('quiz.viewTemplateLibrary'))) {
                    window.location.href = 'quiz-templates.html';
                }
            }, 2000);
        }

        function saveTemplateToStorage(templateData) {
            // In real implementation, this would be an API call to save to database
            // For demo, we'll save to localStorage
            try {
                let savedTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
                savedTemplates.push(templateData);
                localStorage.setItem('userTemplates', JSON.stringify(savedTemplates));
                
                // Also update template usage tracking
                let templateStats = JSON.parse(localStorage.getItem('templateStats') || '{}');
                templateStats.totalCreated = (templateStats.totalCreated || 0) + 1;
                templateStats.byCategory = templateStats.byCategory || {};
                templateStats.byCategory[templateData.category] = (templateStats.byCategory[templateData.category] || 0) + 1;
                localStorage.setItem('templateStats', JSON.stringify(templateStats));
                
                console.log('Template saved:', templateData);
            } catch (error) {
                console.error('Failed to save template:', error);
                LMS.showToast(LMS.t('error.templateSaveFailed'), 'error');
            }
        }

        // Close template modal on outside click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('templateModal');
            if (e.target === modal) {
                closeTemplateModal();
            }
        });

        // Close template modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('templateModal').classList.contains('active')) {
                closeTemplateModal();
            }
        });

        // Initialize dropdown components
        function initDropdowns() {
            // Initialize course dropdown
            LMS.Dropdown.init('quizCourseDropdown', {
                onSelect: (value, text) => {
                    currentQuiz.courseId = value;
                }
            });
            
            // Initialize max attempts dropdown
            LMS.Dropdown.init('quizMaxAttemptsDropdown', {
                onSelect: (value, text) => {
                    currentQuiz.maxAttempts = parseInt(value);
                }
            });
            
            // Initialize template category dropdown
            LMS.Dropdown.init('templateCategoryDropdown');
            
            // Initialize template difficulty dropdown
            LMS.Dropdown.init('templateDifficultyDropdown');
        }
        
        // Wrapper functions for backward compatibility
        function updateDropdownValue(dropdownId, value) {
            LMS.Dropdown.setValue(dropdownId, value);
        }
        
        function getDropdownValue(dropdownId) {
            return LMS.Dropdown.getValue(dropdownId);
        }

        // Security settings functions
        function initializeSecuritySettings() {
            // Password protection
            document.getElementById('quizPasswordEnabled').addEventListener('change', (e) => {
                currentQuiz.security.passwordEnabled = e.target.checked;
                togglePasswordField();
            });
            
            document.getElementById('quizPassword').addEventListener('input', (e) => {
                currentQuiz.security.password = e.target.value;
            });
            
            // Time window
            document.getElementById('quizTimeWindowEnabled').addEventListener('change', (e) => {
                currentQuiz.security.timeWindowEnabled = e.target.checked;
                toggleTimeWindow();
            });
            
            document.getElementById('quizStartTime').addEventListener('change', (e) => {
                currentQuiz.security.startTime = e.target.value;
            });
            
            document.getElementById('quizEndTime').addEventListener('change', (e) => {
                currentQuiz.security.endTime = e.target.value;
            });
            
            // Anti-cheating features
            document.getElementById('quizPreventTabSwitch').addEventListener('change', (e) => {
                currentQuiz.security.preventTabSwitch = e.target.checked;
            });
            
            document.getElementById('quizFullScreenMode').addEventListener('change', (e) => {
                currentQuiz.security.fullScreenMode = e.target.checked;
            });
            
            document.getElementById('quizDisableCopyPaste').addEventListener('change', (e) => {
                currentQuiz.security.disableCopyPaste = e.target.checked;
            });
            
            document.getElementById('quizRandomizeQuestions').addEventListener('change', (e) => {
                currentQuiz.security.randomizeQuestions = e.target.checked;
            });
            
            document.getElementById('quizRandomizeOptions').addEventListener('change', (e) => {
                currentQuiz.security.randomizeOptions = e.target.checked;
            });
            
            // IP restriction
            document.getElementById('quizIPRestriction').addEventListener('change', (e) => {
                currentQuiz.security.ipRestriction = e.target.checked;
                toggleIPRestriction();
            });
            
            document.getElementById('quizAllowedIPs').addEventListener('input', (e) => {
                currentQuiz.security.allowedIPs = e.target.value.split('\n').map(ip => ip.trim()).filter(ip => ip);
            });
            
            // Time limit per question
            document.getElementById('quizTimeLimitPerQuestion').addEventListener('change', (e) => {
                currentQuiz.security.timeLimitPerQuestion = e.target.checked;
                toggleQuestionTimeLimit();
            });
            
            document.getElementById('quizQuestionTimeLimit').addEventListener('input', (e) => {
                currentQuiz.security.questionTimeLimit = parseInt(e.target.value) || 60;
            });
            
            // Browser lockdown
            document.getElementById('quizBrowserLockdown').addEventListener('change', (e) => {
                currentQuiz.security.browserLockdown = e.target.checked;
            });
            
            // Activity monitoring
            document.getElementById('quizTrackFocusLoss').addEventListener('change', (e) => {
                currentQuiz.security.trackFocusLoss = e.target.checked;
            });
            
            document.getElementById('quizRecordAnswerChanges').addEventListener('change', (e) => {
                currentQuiz.security.recordAnswerChanges = e.target.checked;
            });
            
            document.getElementById('quizCaptureScreenshots').addEventListener('change', (e) => {
                currentQuiz.security.captureScreenshots = e.target.checked;
            });
            
            // Proctoring options
            document.getElementById('quizWebcamRequired').addEventListener('change', (e) => {
                currentQuiz.security.webcamRequired = e.target.checked;
                toggleProctoringSettings();
            });
            
            document.getElementById('quizIdVerification').addEventListener('change', (e) => {
                currentQuiz.security.idVerification = e.target.checked;
            });
            
            document.getElementById('quizLiveProctoring').addEventListener('change', (e) => {
                currentQuiz.security.liveProctoring = e.target.checked;
            });
        }

        // Toggle functions for security settings
        function togglePasswordField() {
            const container = document.getElementById('passwordFieldContainer');
            container.style.display = document.getElementById('quizPasswordEnabled').checked ? 'block' : 'none';
        }

        function toggleTimeWindow() {
            const container = document.getElementById('timeWindowContainer');
            container.style.display = document.getElementById('quizTimeWindowEnabled').checked ? 'block' : 'none';
        }

        function toggleIPRestriction() {
            const container = document.getElementById('ipRestrictionContainer');
            container.style.display = document.getElementById('quizIPRestriction').checked ? 'block' : 'none';
        }

        function toggleQuestionTimeLimit() {
            const container = document.getElementById('questionTimeLimitContainer');
            container.style.display = document.getElementById('quizTimeLimitPerQuestion').checked ? 'block' : 'none';
        }

        function toggleProctoringSettings() {
            const container = document.getElementById('proctoringSettingsContainer');
            container.style.display = document.getElementById('quizWebcamRequired').checked ? 'block' : 'none';
        }

        // Question Pool Management Functions
        function toggleQuestionPools() {
            const enabled = document.getElementById('quizUseRandomPools').checked;
            document.getElementById('questionPoolsContainer').style.display = enabled ? 'block' : 'none';
            currentQuiz.useQuestionPools = enabled;
        }

        function openPoolManager() {
            document.getElementById('poolManagerModal').classList.add('active');
            loadQuestionPools();
        }

        function closePoolManager() {
            document.getElementById('poolManagerModal').classList.remove('active');
        }

        function loadQuestionPools() {
            // In real implementation, load from API
            // For demo, show sample pools
            const pools = [
                { id: 'pool1', name: 'Easy Questions', count: 15, difficulty: 'easy' },
                { id: 'pool2', name: 'Medium Questions', count: 20, difficulty: 'medium' },
                { id: 'pool3', name: 'Hard Questions', count: 10, difficulty: 'hard' }
            ];
            
            const poolsList = document.getElementById('poolsList');
            poolsList.innerHTML = pools.map(pool => `
                <div class="pool-item">
                    <div class="pool-item__header">
                        <h4>${pool.name}</h4>
                        <span class="badge badge--${getDifficultyColor(pool.difficulty)}">${pool.count} questions</span>
                    </div>
                    <div class="pool-item__actions">
                        <button class="btn btn--ghost btn--small" onclick="editPool('${pool.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn--ghost btn--small text-danger" onclick="deletePool('${pool.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                easy: 'success',
                medium: 'warning',
                hard: 'danger'
            };
            return colors[difficulty] || 'info';
        }

        function createNewPool() {
            const poolName = prompt('Enter pool name:');
            if (poolName) {
                LMS.showToast(`Pool "${poolName}" created!`, 'success');
                loadQuestionPools();
            }
        }

        function editPool(poolId) {
            // In real implementation, open pool editor
            LMS.showToast(`Editing pool ${poolId}...`, 'info');
        }

        function deletePool(poolId) {
            if (confirm('Are you sure you want to delete this pool?')) {
                LMS.showToast('Pool deleted!', 'success');
                loadQuestionPools();
            }
        }

        // Version Control Functions
        function viewVersionHistory() {
            document.getElementById('versionHistoryModal').classList.add('active');
            loadVersionHistory();
        }

        function closeVersionHistory() {
            document.getElementById('versionHistoryModal').classList.remove('active');
        }

        function loadVersionHistory() {
            // In real implementation, load from API
            // Demo data is already in the modal
        }

        function createVersion() {
            const versionNote = prompt('Enter version note:');
            if (versionNote) {
                // Save current state as new version
                const newVersion = {
                    id: `v${Date.now()}`,
                    number: '1.3',
                    note: versionNote,
                    quiz: JSON.parse(JSON.stringify(currentQuiz)),
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                // In real implementation, save to API
                LMS.showToast(`Version ${newVersion.number} created!`, 'success');
                
                // Update version info
                document.querySelector('.version-info p:first-child').textContent = `Current Version: v${newVersion.number}`;
            }
        }

        function viewVersion(versionId) {
            // In real implementation, load version data
            LMS.showToast(`Viewing version ${versionId}...`, 'info');
        }

        function restoreVersion(versionId) {
            if (confirm(`Are you sure you want to restore version ${versionId}? Current changes will be saved as a new version.`)) {
                // Create new version with current state
                // Then restore selected version
                LMS.showToast(`Version ${versionId} restored!`, 'success');
            }
        }

        // Collaborative Features (Mock)
        function initCollaboration() {
            // In real implementation, setup WebSocket for real-time collaboration
            // For demo, show occasional notifications
            if (currentUser.role === 'teacher') {
                setTimeout(() => {
                    if (Math.random() > 0.7) {
                        LMS.showToast('John Doe is also editing this quiz', 'info');
                    }
                }, 5000);
            }
        }

        // Advanced Preview with new question types
        function renderQuestionPreview(question) {
            switch (question.type) {
                case 'multiple-choice':
                    return `
                        <div class="mt-3">
                            ${question.options.map(option => `
                                <label class="radio-label" class="block mb-2">
                                    <input type="radio" name="preview-${question.id}" disabled>
                                    <span class="radio-custom"></span>
                                    <span>${option.text}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'multiple-select':
                    return `
                        <div class="mt-3">
                            ${question.options.map(option => `
                                <label class="checkbox-label" class="block mb-2">
                                    <input type="checkbox" disabled>
                                    <span class="checkbox-custom"></span>
                                    <span>${option.text}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'true-false':
                    return `
                        <div class="mt-3 flex flex-gap-4">
                            <label class="radio-label">
                                <input type="radio" name="preview-${question.id}" disabled>
                                <span class="radio-custom"></span>
                                <span>True</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="preview-${question.id}" disabled>
                                <span class="radio-custom"></span>
                                <span>False</span>
                            </label>
                        </div>
                    `;
                case 'text-input':
                    return `
                        <div class="mt-3">
                            <textarea class="input" rows="3" placeholder="Type your answer here..." disabled></textarea>
                        </div>
                    `;
                case 'drag-drop':
                    return `
                        <div class="mt-3">
                            <div class="drag-drop-preview">
                                <div class="drag-sources">
                                    ${question.pairs.map(pair => `
                                        <div class="drag-item">${pair.source}</div>
                                    `).join('')}
                                </div>
                                <div class="drop-targets">
                                    ${question.pairs.map(pair => `
                                        <div class="drop-zone">Drop here for: ${pair.target}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                case 'hotspot':
                    return `
                        <div class="mt-3">
                            ${question.imageUrl ? 
                                `<img src="${question.imageUrl}" alt="Click on the correct areas" style="max-width: 100%; border: 1px solid var(--border-color);">` :
                                '<p class="text-secondary">Image will be displayed here</p>'
                            }
                        </div>
                    `;
                case 'code':
                    return `
                        <div class="mt-3">
                            <div class="code-editor-preview">
                                <div class="code-header">
                                    <span>${question.language || 'JavaScript'}</span>
                                    ${question.runnable ? '<button class="btn btn--small btn--primary">Run Code</button>' : ''}
                                </div>
                                <textarea class="input code-editor" rows="10" placeholder="Write your code here..." disabled>${question.starterCode || ''}</textarea>
                            </div>
                        </div>
                    `;
                case 'matching':
                    return `
                        <div class="mt-3">
                            <div class="matching-preview">
                                <div class="matching-column">
                                    ${question.matches.map((match, i) => `
                                        <div class="match-item">${i + 1}. ${match.left}</div>
                                    `).join('')}
                                </div>
                                <div class="matching-column">
                                    ${question.matches.map((match, i) => `
                                        <div class="match-item">A. ${match.right}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                case 'ordering':
                    return `
                        <div class="mt-3">
                            <div class="ordering-preview">
                                ${question.items.map(() => `
                                    <div class="order-item">
                                        <i class="fas fa-grip-vertical"></i>
                                        <span>[Drag to reorder]</span>
                                    </div>
                                `).join('')}
                            </div>
                            <p class="text-sm text-secondary mt-2">Items will be shuffled for students</p>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            init();
            initDropdowns();
            initCollaboration();
        });
    </script>
</body>
</html>
