<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Builder - LMS</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Configuration -->
    <script src="../config.js"></script>
</head>
<body>
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="flex-between">
                <div>
                    <h1 class="page-title" id="pageTitle" data-translate="quiz.createQuiz">Create Quiz</h1>
                    <p class="page-subtitle" data-translate="quiz.builderSubtitle">Build your quiz with questions and settings</p>
                </div>
                <div class="flex flex-gap-3">
                    <button class="btn btn--secondary" onclick="previewQuiz()">
                        <i class="fas fa-eye" class="icon-mr"></i>
                        <span data-translate="quiz.preview">Preview</span>
                    </button>
                    <button class="btn btn--secondary" onclick="saveAsTemplate()" id="saveTemplateBtn">
                        <i class="fas fa-file-archive" class="icon-mr"></i>
                        <span data-translate="quiz.saveAsTemplate">Save as Template</span>
                    </button>
                    <button class="btn btn--secondary" onclick="saveDraft()" id="saveDraftBtn">
                        <i class="fas fa-save" class="icon-mr"></i>
                        <span data-translate="quiz.saveDraft">Save Draft</span>
                    </button>
                    <button class="btn btn--success" onclick="publishQuiz()" id="publishBtn">
                        <i class="fas fa-rocket" class="icon-mr"></i>
                        <span data-translate="quiz.publish">Publish</span>
                    </button>
                    <button class="btn btn--ghost" onclick="goBack()">
                        <i class="fas fa-times" class="icon-mr"></i>
                        <span data-translate="common.cancel">Cancel</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="page-content">
            <!-- Two Column Layout: Sidebar + Main Content -->
            <div class="two-column-layout">
                <!-- Sidebar -->
                <div class="sidebar-column">
                    <!-- Quiz Info Section -->
                    <div class="card mb-4">
                        <div class="card__header">
                            <h3 data-translate="quiz.basicInfo">Basic Information</h3>
                        </div>
                        <div class="card__body">
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.title">Quiz Title</label>
                                <input type="text" id="quizTitle" class="input" placeholder="Enter quiz title..." 
                                       data-translate-placeholder="quiz.titlePlaceholder">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.description">Description</label>
                                <textarea id="quizDescription" class="input" rows="3" placeholder="Enter quiz description..."
                                          data-translate-placeholder="quiz.descriptionPlaceholder"></textarea>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="course.selectCourse">Course</label>
                                <div class="dropdown dropdown--block" id="quizCourseDropdown">
                                    <button class="dropdown__trigger">
                                        <span data-translate="common.selectOption">Select a course...</span>
                                        <span class="dropdown__arrow"></span>
                                    </button>
                                    <div class="dropdown__menu">
                                        <div class="dropdown__list" id="quizCourseList">
                                            <!-- Course options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Settings -->
                    <div class="card" class="mb-4">
                        <div class="card__header">
                            <h3 data-translate="quiz.settings">Quiz Settings</h3>
                        </div>
                        <div class="card__body">
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.timeLimit">Time Limit (minutes)</label>
                                <input type="number" id="quizTimeLimit" class="input" value="60" min="1" max="300">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.passingScore">Passing Score (%)</label>
                                <input type="number" id="quizPassingScore" class="input" value="70" min="0" max="100">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-group__label" data-translate="quiz.maxAttempts">Max Attempts</label>
                                <div class="dropdown dropdown--block" id="quizMaxAttemptsDropdown">
                                    <button class="dropdown__trigger">
                                        <span>3 attempts</span>
                                        <span class="dropdown__arrow"></span>
                                    </button>
                                    <div class="dropdown__menu">
                                        <div class="dropdown__list">
                                            <div class="dropdown__item" data-value="1">1 attempt</div>
                                            <div class="dropdown__item" data-value="2">2 attempts</div>
                                            <div class="dropdown__item dropdown__item--selected" data-value="3">3 attempts</div>
                                            <div class="dropdown__item" data-value="5">5 attempts</div>
                                            <div class="dropdown__item" data-value="-1" data-translate="quiz.unlimited">Unlimited</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizShuffleQuestions">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.shuffleQuestions">Shuffle Questions</span>
                                </label>
                            </div>
                            
                            <div class="input-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="quizShowResults">
                                    <span class="checkbox-custom"></span>
                                    <span data-translate="quiz.showResults">Show Results Immediately</span>
                                </label>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- Main Content Area -->
                <div class="main-column">
                    <div id="questionsContainer" style="padding: var(--spacing-4);">
                        <!-- Welcome State -->
                        <div id="welcomeState" class="card" class="text-center p-8">
                            <i class="fas fa-question-circle" class="text-64 text-muted mb-4"></i>
                            <h3 data-translate="quiz.welcomeTitle">Welcome to Quiz Builder</h3>
                            <p class="text-secondary mb-6" data-translate="quiz.welcomeMessage">
                                Start by filling in the quiz information on the left, then add your first question.
                            </p>
                            <button class="btn btn--primary" onclick="addQuestion()">
                                <i class="fas fa-plus-circle" class="icon-mr"></i>
                                <span data-translate="quiz.addFirstQuestion">Add Your First Question</span>
                            </button>
                        </div>

                        <!-- Questions will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Question Type Modal -->
    <div class="modal-backdrop" id="questionTypeModalBackdrop">
        <div class="modal modal--medium" id="questionTypeModal">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.selectQuestionType">Select Question Type</h2>
                <button class="modal__close" onclick="closeQuestionTypeModal()">×</button>
            </div>
            <div class="modal__body">
                <div class="grid grid--2-cols" class="grid-gap-4">
                    <div class="question-type-option" onclick="createQuestion('multiple-choice')">
                        <div class="question-type-card">
                            <i class="fas fa-list" class="text-2xl text-primary mb-2"></i>
                            <h4 data-translate="quiz.multipleChoice">Multiple Choice</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.multipleChoiceDesc">
                                Single correct answer from multiple options
                            </p>
                        </div>
                    </div>
                    
                    <div class="question-type-option" onclick="createQuestion('true-false')">
                        <div class="question-type-card">
                            <i class="fas fa-check-circle" class="text-2xl text-success mb-2"></i>
                            <h4 data-translate="quiz.trueFalse">True / False</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.trueFalseDesc">
                                Simple true or false question
                            </p>
                        </div>
                    </div>
                    
                    <div class="question-type-option" onclick="createQuestion('text-input')">
                        <div class="question-type-card">
                            <i class="fas fa-keyboard" class="text-2xl text-info mb-2"></i>
                            <h4 data-translate="quiz.textInput">Text Input</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.textInputDesc">
                                Open-ended text answer
                            </p>
                        </div>
                    </div>
                    
                    <div class="question-type-option" onclick="createQuestion('multiple-select')">
                        <div class="question-type-card">
                            <i class="fas fa-check-square" class="text-2xl text-warning mb-2"></i>
                            <h4 data-translate="quiz.multipleSelect">Multiple Select</h4>
                            <p class="text-sm text-secondary" data-translate="quiz.multipleSelectDesc">
                                Multiple correct answers
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Preview Modal -->
    <div class="modal-backdrop" id="quizPreview">
        <div class="modal modal--large">
            <div class="modal__header">
                <h2 class="modal__title" data-translate="quiz.previewTitle">Quiz Preview</h2>
                <button class="modal__close" onclick="closePreview()">×</button>
            </div>
            <div class="modal__body">
                <div id="previewContent">
                    <!-- Dynamic preview content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Save as Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal__content">
            <div class="modal__header">
                <h3 data-translate="quiz.saveAsTemplate">Save as Template</h3>
                <button class="modal__close" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal__body">
                <form id="templateForm">
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateName">Template Name</label>
                        <input type="text" id="templateName" class="input" required 
                               data-translate-placeholder="quiz.templateNamePlaceholder">
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateDescription">Template Description</label>
                        <textarea id="templateDescription" class="input input--textarea" rows="3" 
                                  data-translate-placeholder="quiz.templateDescPlaceholder"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateCategory">Category</label>
                        <div class="dropdown dropdown--block" id="templateCategoryDropdown">
                            <button class="dropdown__trigger">
                                <span data-translate="quiz.selectCategory">Select Category</span>
                                <span class="dropdown__arrow"></span>
                            </button>
                            <div class="dropdown__menu">
                                <div class="dropdown__list">
                                    <div class="dropdown__item" data-value="math" data-translate="quiz.math">Mathematics</div>
                                    <div class="dropdown__item" data-value="science" data-translate="quiz.science">Science</div>
                                    <div class="dropdown__item" data-value="language" data-translate="quiz.language">Language Arts</div>
                                    <div class="dropdown__item" data-value="business" data-translate="quiz.business">Business</div>
                                    <div class="dropdown__item" data-value="programming" data-translate="quiz.programming">Programming</div>
                                    <div class="dropdown__item" data-value="general" data-translate="quiz.general">General Knowledge</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateDifficulty">Difficulty Level</label>
                        <div class="dropdown dropdown--block" id="templateDifficultyDropdown">
                            <button class="dropdown__trigger">
                                <span data-translate="quiz.selectDifficulty">Select Difficulty</span>
                                <span class="dropdown__arrow"></span>
                            </button>
                            <div class="dropdown__menu">
                                <div class="dropdown__list">
                                    <div class="dropdown__item" data-value="easy" data-translate="quiz.easy">Easy</div>
                                    <div class="dropdown__item" data-value="medium" data-translate="quiz.medium">Medium</div>
                                    <div class="dropdown__item" data-value="hard" data-translate="quiz.hard">Hard</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateTags">Tags (comma-separated)</label>
                        <input type="text" id="templateTags" class="input" 
                               data-translate-placeholder="quiz.templateTagsPlaceholder">
                        <div class="input-group__help" data-translate="quiz.templateTagsHelp">
                            Add relevant tags to help others find your template
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-group__label" data-translate="quiz.templateSharing">Sharing Settings</label>
                        <div class="flex flex-col flex-gap-2">
                            <label class="checkbox-label">
                                <input type="radio" name="sharing" value="private" checked>
                                <span class="radio-custom"></span>
                                <div>
                                    <span data-translate="quiz.privateTemplate">Private</span>
                                    <small class="block text-secondary" data-translate="quiz.privateTemplateDesc">
                                        Only you can see and use this template
                                    </small>
                                </div>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="radio" name="sharing" value="public">
                                <span class="radio-custom"></span>
                                <div>
                                    <span data-translate="quiz.publicTemplate">Public</span>
                                    <small class="block text-secondary" data-translate="quiz.publicTemplateDesc">
                                        Available to all teachers in the system
                                    </small>
                                </div>
                            </label>
                            
                            <label class="checkbox-label">
                                <input type="radio" name="sharing" value="school">
                                <span class="radio-custom"></span>
                                <div>
                                    <span data-translate="quiz.schoolTemplate">School Only</span>
                                    <small class="block text-secondary" data-translate="quiz.schoolTemplateDesc">
                                        Available to teachers in your school
                                    </small>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="template-summary" class="bg-secondary p-4 rounded-md mt-4">
                        <h4 class="mb-3" data-translate="quiz.templateSummary">Template Summary</h4>
                        <div class="grid grid-auto-fit-xs grid-gap-3">
                            <div class="text-center">
                                <div class="text-xl font-bold text-primary" id="summaryQuestions">0</div>
                                <div class="text-sm text-secondary" data-translate="quiz.questions">Questions</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-success" id="summaryPoints">0</div>
                                <div class="text-sm text-secondary" data-translate="quiz.totalPoints">Total Points</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold text-info" id="summaryTime">0</div>
                                <div class="text-sm text-secondary" data-translate="quiz.estimatedTime">Est. Time</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" onclick="closeTemplateModal()">
                    <i class="fas fa-times" class="icon-mr"></i>
                    <span data-translate="common.cancel">Cancel</span>
                </button>
                <button type="button" class="btn btn--primary" onclick="confirmSaveTemplate()">
                    <i class="fas fa-save" class="icon-mr"></i>
                    <span data-translate="quiz.saveTemplate">Save Template</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Core JavaScript -->
    <script src="../assets/js/global.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    
    <script>
        // State management
        let currentQuiz = {
            id: null,
            title: '',
            description: '',
            courseId: '',
            timeLimit: 60,
            passingScore: 70,
            maxAttempts: 3,
            shuffleQuestions: false,
            showResults: false,
            questions: [],
            status: 'draft'
        };
        
        let allCourses = [];
        let currentUser = null;
        let activeQuestionId = null;
        let isEditMode = false;
        let questionIdCounter = 1;

        // Initialize
        async function init() {
            // Ensure auth is loaded first
            if (!LMS.Auth.currentUser) {
                LMS.Auth.loadSession();
            }
            
            // Get current user after auth is ready
            currentUser = LMS.Auth.getUser();
            
            // Check authentication - teachers and admins only
            if (!LMS.AccessControl.checkRole(['teacher', 'admin'])) {
                return;
            }

            // Load translations
            await LMS.LanguageManager.init();
            
            // Check if editing existing quiz
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('id');
            
            if (quizId) {
                isEditMode = true;
                document.getElementById('pageTitle').textContent = LMS.t('quiz.editQuiz');
                await loadQuiz(quizId);
            }
            
            // Load data
            await loadCourses();
            setupEventListeners();
            updateUI();
        }

        // Load courses for dropdown
        async function loadCourses() {
            try {
                const response = await LMS.API.loadJSON('mock-courses.json');
                allCourses = response.data || [];
                
                // Filter courses for teachers
                if (currentUser.role === 'teacher') {
                    allCourses = allCourses.filter(c => c.teacherId === currentUser.id);
                }
                
                populateCourseDropdown();
                
            } catch (error) {
                console.error('Failed to load courses:', error);
                LMS.showToast(LMS.t('error.loadData'), 'error');
            }
        }

        // Load existing quiz for editing
        async function loadQuiz(quizId) {
            try {
                // In a real app, this would load from API
                // For demo, we'll simulate loading
                LMS.showToast(LMS.t('quiz.loading'), 'info');
                
                // Simulate loading delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // For demo, create sample quiz data
                currentQuiz = {
                    id: quizId,
                    title: 'Sample Quiz',
                    description: 'This is a sample quiz for demonstration',
                    courseId: allCourses[0]?.id || '',
                    timeLimit: 45,
                    passingScore: 80,
                    maxAttempts: 2,
                    shuffleQuestions: true,
                    showResults: true,
                    status: 'draft',
                    questions: [
                        {
                            id: 'q1',
                            type: 'multiple-choice',
                            question: 'What is the capital of France?',
                            points: 1,
                            options: [
                                { id: 'o1', text: 'London', correct: false },
                                { id: 'o2', text: 'Paris', correct: true },
                                { id: 'o3', text: 'Berlin', correct: false },
                                { id: 'o4', text: 'Madrid', correct: false }
                            ]
                        },
                        {
                            id: 'q2',
                            type: 'true-false',
                            question: 'The Earth is flat.',
                            points: 1,
                            answer: false
                        }
                    ]
                };
                
                questionIdCounter = currentQuiz.questions.length + 1;
                
            } catch (error) {
                console.error('Failed to load quiz:', error);
                LMS.showToast(LMS.t('error.loadData'), 'error');
            }
        }

        // Populate course dropdown
        function populateCourseDropdown() {
            const courseOptions = allCourses.map(course => ({
                value: course.id,
                text: course.title
            }));
            
            LMS.Dropdown.populate('quizCourseDropdown', courseOptions, currentQuiz.courseId);
            
            // If no course selected, show default text
            if (!currentQuiz.courseId) {
                const trigger = document.querySelector('#quizCourseDropdown .dropdown__trigger span:first-child');
                trigger.textContent = LMS.t('common.selectOption');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Quiz info fields
            document.getElementById('quizTitle').addEventListener('input', (e) => {
                currentQuiz.title = e.target.value;
            });
            
            document.getElementById('quizDescription').addEventListener('input', (e) => {
                currentQuiz.description = e.target.value;
            });
            
            // Course dropdown is now handled by initDropdowns function
            
            // Quiz settings
            document.getElementById('quizTimeLimit').addEventListener('input', (e) => {
                currentQuiz.timeLimit = parseInt(e.target.value);
            });
            
            document.getElementById('quizPassingScore').addEventListener('input', (e) => {
                currentQuiz.passingScore = parseInt(e.target.value);
            });
            
            // Max attempts dropdown is now handled by initDropdowns function
            
            document.getElementById('quizShuffleQuestions').addEventListener('change', (e) => {
                currentQuiz.shuffleQuestions = e.target.checked;
            });
            
            document.getElementById('quizShowResults').addEventListener('change', (e) => {
                currentQuiz.showResults = e.target.checked;
            });

            // Question type modal styles
            document.addEventListener('click', function(e) {
                if (e.target.closest('.question-type-option')) {
                    const option = e.target.closest('.question-type-option');
                    const div = option.querySelector('div');
                    div.style.borderColor = 'var(--color-primary)';
                    div.style.backgroundColor = 'var(--color-primary-light, rgba(44, 110, 170, 0.1))';
                }
            });
        }

        // Update UI with current quiz data
        function updateUI() {
            // Update form fields
            document.getElementById('quizTitle').value = currentQuiz.title;
            document.getElementById('quizDescription').value = currentQuiz.description;
            // Course dropdown will be updated by populateCourseDropdown
            document.getElementById('quizTimeLimit').value = currentQuiz.timeLimit;
            document.getElementById('quizPassingScore').value = currentQuiz.passingScore;
            updateDropdownValue('quizMaxAttemptsDropdown', currentQuiz.maxAttempts);
            document.getElementById('quizShuffleQuestions').checked = currentQuiz.shuffleQuestions;
            document.getElementById('quizShowResults').checked = currentQuiz.showResults;
            
            // Update questions
            updateQuestionsList();
            updateQuestionsContainer();
            updateQuestionCount();
        }

        // Update questions list (removed - all operations now in main content area)
        function updateQuestionsList() {
            // This function is no longer needed as questions list has been removed
        }

        // Update main questions container
        function updateQuestionsContainer() {
            const container = document.getElementById('questionsContainer');
            
            if (currentQuiz.questions.length === 0) {
                container.innerHTML = `
                    <div id="welcomeState" class="card" class="text-center p-8">
                        <i class="fas fa-question-circle" class="text-64 text-muted mb-4"></i>
                        <h3 data-translate="quiz.welcomeTitle">Welcome to Quiz Builder</h3>
                        <p class="text-secondary mb-6" data-translate="quiz.welcomeMessage">
                            Start by filling in the quiz information on the left, then add your first question.
                        </p>
                        <button class="btn btn--primary" onclick="addQuestion()">
                            <i class="fas fa-plus-circle" class="icon-mr"></i>
                            <span data-translate="quiz.addFirstQuestion">Add Your First Question</span>
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentQuiz.questions.map((question, index) => `
                <div class="question-container ${question.id === activeQuestionId ? 'active' : ''}" id="question-${question.id}">
                    <div class="question-toggle" onclick="selectQuestion('${question.id}')">
                        <div class="flex-items-center flex-gap-3">
                            <div class="question-counter">${index + 1}</div>
                            <div>
                                <div class="font-medium">${question.question}</div>
                                <div class="flex-items-center flex-gap-2 mt-1">
                                    <span class="question-type-badge badge badge--info">${getQuestionTypeName(question.type)}</span>
                                    <span class="text-sm text-secondary">${question.points || 1} ${question.points === 1 ? 'point' : 'points'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-gap-2">
                            <button class="btn btn--ghost btn--small" onclick="editQuestion('${question.id}'); event.stopPropagation();" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn--ghost btn--small" onclick="duplicateQuestion('${question.id}'); event.stopPropagation();" title="Duplicate">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn--ghost btn--small text-danger" onclick="deleteQuestion('${question.id}'); event.stopPropagation();" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="question-content">
                        ${renderQuestionEditor(question)}
                    </div>
                </div>
            `).join('');
            
            // Add the "Add Question" button at the end
            container.innerHTML += `
                <div class="text-center" style="margin-top: var(--spacing-6);">
                    <button class="btn btn--primary" onclick="addQuestion()">
                        <i class="fas fa-plus-circle" class="icon-mr"></i>
                        <span data-translate="quiz.addQuestion">Add Question</span>
                    </button>
                </div>
            `;
        }

        // Render question editor based on type
        function renderQuestionEditor(question) {
            switch (question.type) {
                case 'multiple-choice':
                case 'multiple-select':
                    return renderMultipleChoiceEditor(question);
                case 'true-false':
                    return renderTrueFalseEditor(question);
                case 'text-input':
                    return renderTextInputEditor(question);
                default:
                    return '<p>Unknown question type</p>';
            }
        }

        // Render multiple choice editor
        function renderMultipleChoiceEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.answerOptions">Answer Options</label>
                    <div id="options-${question.id}">
                        ${question.options.map(option => `
                            <div class="option-row ${option.correct ? 'correct' : ''}">
                                ${question.type === 'multiple-choice' ? 
                                    `<input type="radio" name="correct-${question.id}" ${option.correct ? 'checked' : ''} onchange="setCorrectOption('${question.id}', '${option.id}')">` :
                                    `<input type="checkbox" ${option.correct ? 'checked' : ''} onchange="toggleCorrectOption('${question.id}', '${option.id}')">`
                                }
                                <input type="text" class="input" value="${option.text}" onchange="updateOptionText('${question.id}', '${option.id}', this.value)" class="flex-1">
                                <button class="btn btn--ghost btn--small text-danger" onclick="removeOption('${question.id}', '${option.id}')" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn btn--secondary btn--small" onclick="addOption('${question.id}')" class="mt-2">
                        <i class="fas fa-plus" class="icon-mr"></i>
                        <span data-translate="quiz.addOption">Add Option</span>
                    </button>
                </div>
            `;
        }

        // Render true/false editor
        function renderTrueFalseEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.correctAnswer">Correct Answer</label>
                    <div class="flex flex-gap-4">
                        <label class="radio-label">
                            <input type="radio" name="answer-${question.id}" value="true" ${question.answer === true ? 'checked' : ''} onchange="updateTrueFalseAnswer('${question.id}', true)">
                            <span class="radio-custom"></span>
                            <span data-translate="quiz.true">True</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="answer-${question.id}" value="false" ${question.answer === false ? 'checked' : ''} onchange="updateTrueFalseAnswer('${question.id}', false)">
                            <span class="radio-custom"></span>
                            <span data-translate="quiz.false">False</span>
                        </label>
                    </div>
                </div>
            `;
        }

        // Render text input editor
        function renderTextInputEditor(question) {
            return `
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.questionText">Question Text</label>
                    <textarea class="input" rows="3" onchange="updateQuestionText('${question.id}', this.value)">${question.question}</textarea>
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.points">Points</label>
                    <input type="number" class="input" value="${question.points || 1}" min="0" max="10" onchange="updateQuestionPoints('${question.id}', this.value)" class="w-25">
                </div>
                
                <div class="input-group">
                    <label class="input-group__label" data-translate="quiz.expectedAnswer">Expected Answer (for reference)</label>
                    <textarea class="input" rows="2" placeholder="Enter the expected answer for grading reference..." 
                              onchange="updateTextAnswer('${question.id}', this.value)">${question.expectedAnswer || ''}</textarea>
                    <span class="input-group__help" data-translate="quiz.textAnswerHelp">This answer will be used as a reference during manual grading.</span>
                </div>
            `;
        }

        // Get question type display name
        function getQuestionTypeName(type) {
            const names = {
                'multiple-choice': LMS.t('quiz.multipleChoice'),
                'multiple-select': LMS.t('quiz.multipleSelect'),
                'true-false': LMS.t('quiz.trueFalse'),
                'text-input': LMS.t('quiz.textInput')
            };
            return names[type] || type;
        }

        // Question management functions
        function addQuestion() {
            document.getElementById('questionTypeModalBackdrop').classList.add('active');
            document.getElementById('questionTypeModal').classList.add('active');
        }

        function closeQuestionTypeModal() {
            document.getElementById('questionTypeModalBackdrop').classList.remove('active');
            document.getElementById('questionTypeModal').classList.remove('active');
        }

        function createQuestion(type) {
            const questionId = 'q' + questionIdCounter++;
            
            let newQuestion = {
                id: questionId,
                type: type,
                question: 'Enter your question here...',
                points: 1
            };
            
            switch (type) {
                case 'multiple-choice':
                case 'multiple-select':
                    newQuestion.options = [
                        { id: 'o1', text: 'Option 1', correct: false },
                        { id: 'o2', text: 'Option 2', correct: false },
                        { id: 'o3', text: 'Option 3', correct: false },
                        { id: 'o4', text: 'Option 4', correct: false }
                    ];
                    break;
                case 'true-false':
                    newQuestion.answer = true;
                    break;
                case 'text-input':
                    newQuestion.expectedAnswer = '';
                    break;
            }
            
            currentQuiz.questions.push(newQuestion);
            activeQuestionId = questionId;
            
            closeQuestionTypeModal();
            updateUI();
            
            // Scroll to new question
            setTimeout(() => {
                const element = document.getElementById(`question-${questionId}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        function selectQuestion(questionId) {
            activeQuestionId = questionId;
            updateQuestionsList();
            updateQuestionsContainer();
        }

        function deleteQuestion(questionId) {
            if (!confirm(LMS.t('quiz.deleteQuestionConfirm'))) return;
            
            const index = currentQuiz.questions.findIndex(q => q.id === questionId);
            if (index !== -1) {
                currentQuiz.questions.splice(index, 1);
                
                // Reset active question if deleted
                if (activeQuestionId === questionId) {
                    activeQuestionId = null;
                }
                
                updateUI();
                LMS.showToast(LMS.t('quiz.questionDeleted'), 'success');
            }
        }

        function duplicateQuestion(questionId) {
            const originalQuestion = currentQuiz.questions.find(q => q.id === questionId);
            if (!originalQuestion) return;
            
            const newQuestion = {
                ...originalQuestion,
                id: 'q' + questionIdCounter++,
                question: originalQuestion.question + ' (Copy)'
            };
            
            // Duplicate options if they exist
            if (newQuestion.options) {
                newQuestion.options = newQuestion.options.map((option, index) => ({
                    ...option,
                    id: 'o' + (index + 1)
                }));
            }
            
            currentQuiz.questions.push(newQuestion);
            activeQuestionId = newQuestion.id;
            updateUI();
            
            LMS.showToast(LMS.t('quiz.questionDuplicated'), 'success');
        }

        // Question editing functions
        function updateQuestionText(questionId, text) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.question = text;
                updateQuestionsList();
            }
        }

        function updateQuestionPoints(questionId, points) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.points = parseInt(points) || 1;
            }
        }

        function updateTrueFalseAnswer(questionId, answer) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.answer = answer;
            }
        }

        function updateTextAnswer(questionId, answer) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question) {
                question.expectedAnswer = answer;
            }
        }

        function updateOptionText(questionId, optionId, text) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                const option = question.options.find(o => o.id === optionId);
                if (option) {
                    option.text = text;
                }
            }
        }

        function setCorrectOption(questionId, optionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                question.options.forEach(option => {
                    option.correct = option.id === optionId;
                });
                updateQuestionsContainer();
            }
        }

        function toggleCorrectOption(questionId, optionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                const option = question.options.find(o => o.id === optionId);
                if (option) {
                    option.correct = !option.correct;
                    updateQuestionsContainer();
                }
            }
        }

        function addOption(questionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options) {
                const newOptionId = 'o' + (question.options.length + 1);
                question.options.push({
                    id: newOptionId,
                    text: `Option ${question.options.length + 1}`,
                    correct: false
                });
                updateQuestionsContainer();
            }
        }

        function removeOption(questionId, optionId) {
            const question = currentQuiz.questions.find(q => q.id === questionId);
            if (question && question.options && question.options.length > 2) {
                const index = question.options.findIndex(o => o.id === optionId);
                if (index !== -1) {
                    question.options.splice(index, 1);
                    updateQuestionsContainer();
                }
            } else {
                LMS.showToast(LMS.t('quiz.minimumOptions'), 'warning');
            }
        }

        function updateQuestionCount() {
            document.getElementById('questionCount').textContent = currentQuiz.questions.length;
        }

        // Quiz actions
        function saveDraft() {
            if (!validateQuiz()) return;
            
            currentQuiz.status = 'draft';
            saveQuiz();
        }

        function publishQuiz() {
            if (!validateQuiz(true)) return;
            
            currentQuiz.status = 'active';
            saveQuiz();
        }

        function saveQuiz() {
            // In a real app, this would save to API
            LMS.showToast(LMS.t('quiz.saving'), 'info');
            
            setTimeout(() => {
                LMS.showToast(LMS.t('quiz.saved'), 'success');
                // Redirect to quiz list
                window.location.href = 'quizzes.html';
            }, 1000);
        }

        function validateQuiz(forPublish = false) {
            if (!currentQuiz.title.trim()) {
                LMS.showToast(LMS.t('validation.titleRequired'), 'error');
                document.getElementById('quizTitle').focus();
                return false;
            }
            
            if (!currentQuiz.courseId) {
                LMS.showToast(LMS.t('validation.courseRequired'), 'error');
                document.getElementById('quizCourseDropdown').querySelector('.dropdown__trigger').focus();
                return false;
            }
            
            if (forPublish) {
                if (currentQuiz.questions.length === 0) {
                    LMS.showToast(LMS.t('validation.questionsRequired'), 'error');
                    return false;
                }
                
                // Validate each question has correct answers
                for (let question of currentQuiz.questions) {
                    if (question.type === 'multiple-choice' || question.type === 'multiple-select') {
                        const hasCorrect = question.options.some(o => o.correct);
                        if (!hasCorrect) {
                            LMS.showToast(LMS.t('validation.correctAnswerRequired'), 'error');
                            selectQuestion(question.id);
                            return false;
                        }
                    }
                }
            }
            
            return true;
        }

        function previewQuiz() {
            if (currentQuiz.questions.length === 0) {
                LMS.showToast(LMS.t('quiz.noQuestionsToPreview'), 'warning');
                return;
            }
            
            generatePreview();
            document.getElementById('quizPreview').classList.add('active');
        }

        function generatePreview() {
            const content = document.getElementById('previewContent');
            
            content.innerHTML = `
                <div class="card">
                    <div class="card__header">
                        <h3>${currentQuiz.title}</h3>
                        <p class="text-secondary">${currentQuiz.description}</p>
                        <div class="flex flex-gap-4 mt-3 text-sm">
                            <span><i class="fas fa-clock"></i> ${currentQuiz.timeLimit} minutes</span>
                            <span><i class="fas fa-question-circle"></i> ${currentQuiz.questions.length} questions</span>
                            <span><i class="fas fa-trophy"></i> ${currentQuiz.passingScore}% to pass</span>
                        </div>
                    </div>
                    <div class="card__body">
                        ${currentQuiz.questions.map((question, index) => `
                            <div class="section-divider">
                                <h4 class="flex-items-center flex-gap-2">
                                    <span class="question-counter">${index + 1}</span>
                                    ${question.question}
                                </h4>
                                ${renderQuestionPreview(question)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderQuestionPreview(question) {
            switch (question.type) {
                case 'multiple-choice':
                    return `
                        <div class="mt-3">
                            ${question.options.map(option => `
                                <label class="radio-label" class="block mb-2">
                                    <input type="radio" name="preview-${question.id}" disabled>
                                    <span class="radio-custom"></span>
                                    <span>${option.text}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'multiple-select':
                    return `
                        <div class="mt-3">
                            ${question.options.map(option => `
                                <label class="checkbox-label" class="block mb-2">
                                    <input type="checkbox" disabled>
                                    <span class="checkbox-custom"></span>
                                    <span>${option.text}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                case 'true-false':
                    return `
                        <div class="mt-3 flex flex-gap-4">
                            <label class="radio-label">
                                <input type="radio" name="preview-${question.id}" disabled>
                                <span class="radio-custom"></span>
                                <span>True</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="preview-${question.id}" disabled>
                                <span class="radio-custom"></span>
                                <span>False</span>
                            </label>
                        </div>
                    `;
                case 'text-input':
                    return `
                        <div class="mt-3">
                            <textarea class="input" rows="3" placeholder="Type your answer here..." disabled></textarea>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function closePreview() {
            document.getElementById('quizPreview').classList.remove('active');
        }

        function goBack() {
            if (confirm(LMS.t('quiz.unsavedChanges'))) {
                window.location.href = 'quizzes.html';
            }
        }

        // Template Creation Functions
        function saveAsTemplate() {
            // Validate quiz has questions
            if (questions.length === 0) {
                LMS.showToast(LMS.t('quiz.noQuestionsToSave'), 'error');
                return;
            }

            // Pre-fill template name with quiz title
            const quizTitle = document.getElementById('quizTitle').value;
            if (quizTitle) {
                document.getElementById('templateName').value = `${quizTitle} Template`;
            }

            // Update template summary
            updateTemplateSummary();

            // Show modal
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            // Reset form
            document.getElementById('templateForm').reset();
        }

        function updateTemplateSummary() {
            const questionCount = questions.length;
            const totalPoints = questions.reduce((sum, q) => sum + (parseInt(q.points) || 1), 0);
            const estimatedTime = Math.ceil(questionCount * 1.5); // 1.5 minutes per question

            document.getElementById('summaryQuestions').textContent = questionCount;
            document.getElementById('summaryPoints').textContent = totalPoints;
            document.getElementById('summaryTime').textContent = `${estimatedTime}m`;
        }

        function confirmSaveTemplate() {
            const form = document.getElementById('templateForm');
            
            // Validate required fields
            const templateName = document.getElementById('templateName').value.trim();
            const templateCategory = getDropdownValue('templateCategoryDropdown');
            const templateDifficulty = getDropdownValue('templateDifficultyDropdown');

            if (!templateName) {
                LMS.showToast(LMS.t('validation.templateNameRequired'), 'error');
                document.getElementById('templateName').focus();
                return;
            }

            if (!templateCategory) {
                LMS.showToast(LMS.t('validation.categoryRequired'), 'error');
                document.getElementById('templateCategoryDropdown').querySelector('.dropdown__trigger').focus();
                return;
            }

            if (!templateDifficulty) {
                LMS.showToast(LMS.t('validation.difficultyRequired'), 'error');
                document.getElementById('templateDifficultyDropdown').querySelector('.dropdown__trigger').focus();
                return;
            }

            // Gather template data
            const templateData = {
                id: `template_${Date.now()}`,
                name: templateName,
                description: document.getElementById('templateDescription').value.trim(),
                category: templateCategory,
                difficulty: templateDifficulty,
                tags: document.getElementById('templateTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                sharing: document.querySelector('input[name="sharing"]:checked').value,
                quiz: {
                    title: document.getElementById('quizTitle').value || templateName,
                    description: document.getElementById('quizDescription').value,
                    courseId: currentQuiz.courseId,
                    timeLimit: parseInt(document.getElementById('quizTimeLimit').value) || 30,
                    passingScore: parseInt(document.getElementById('quizPassingScore').value) || 70,
                    maxAttempts: currentQuiz.maxAttempts || 3,
                    shuffleQuestions: document.getElementById('quizShuffleQuestions').checked,
                    showResults: document.getElementById('quizShowResults').checked,
                    questions: questions
                },
                stats: {
                    questionCount: questions.length,
                    totalPoints: questions.reduce((sum, q) => sum + (parseInt(q.points) || 1), 0),
                    estimatedTime: Math.ceil(questions.length * 1.5)
                },
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                usageCount: 0
            };

            // Save template (in real implementation, this would be an API call)
            saveTemplateToStorage(templateData);

            // Close modal and show success
            closeTemplateModal();
            LMS.showToast(LMS.t('quiz.templateSaved').replace('{name}', templateName), 'success');

            // Optionally redirect to templates page
            setTimeout(() => {
                if (confirm(LMS.t('quiz.viewTemplateLibrary'))) {
                    window.location.href = 'quiz-templates.html';
                }
            }, 2000);
        }

        function saveTemplateToStorage(templateData) {
            // In real implementation, this would be an API call to save to database
            // For demo, we'll save to localStorage
            try {
                let savedTemplates = JSON.parse(localStorage.getItem('userTemplates') || '[]');
                savedTemplates.push(templateData);
                localStorage.setItem('userTemplates', JSON.stringify(savedTemplates));
                
                // Also update template usage tracking
                let templateStats = JSON.parse(localStorage.getItem('templateStats') || '{}');
                templateStats.totalCreated = (templateStats.totalCreated || 0) + 1;
                templateStats.byCategory = templateStats.byCategory || {};
                templateStats.byCategory[templateData.category] = (templateStats.byCategory[templateData.category] || 0) + 1;
                localStorage.setItem('templateStats', JSON.stringify(templateStats));
                
                console.log('Template saved:', templateData);
            } catch (error) {
                console.error('Failed to save template:', error);
                LMS.showToast(LMS.t('error.templateSaveFailed'), 'error');
            }
        }

        // Close template modal on outside click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('templateModal');
            if (e.target === modal) {
                closeTemplateModal();
            }
        });

        // Close template modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('templateModal').classList.contains('active')) {
                closeTemplateModal();
            }
        });

        // Initialize dropdown components
        function initDropdowns() {
            // Initialize course dropdown
            LMS.Dropdown.init('quizCourseDropdown', {
                onSelect: (value, text) => {
                    currentQuiz.courseId = value;
                }
            });
            
            // Initialize max attempts dropdown
            LMS.Dropdown.init('quizMaxAttemptsDropdown', {
                onSelect: (value, text) => {
                    currentQuiz.maxAttempts = parseInt(value);
                }
            });
            
            // Initialize template category dropdown
            LMS.Dropdown.init('templateCategoryDropdown');
            
            // Initialize template difficulty dropdown
            LMS.Dropdown.init('templateDifficultyDropdown');
        }
        
        // Wrapper functions for backward compatibility
        function updateDropdownValue(dropdownId, value) {
            LMS.Dropdown.setValue(dropdownId, value);
        }
        
        function getDropdownValue(dropdownId) {
            return LMS.Dropdown.getValue(dropdownId);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            init();
            initDropdowns();
        });
    </script>
</body>
</html>
