<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Management - Admin - LMS</title>
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/themes.css">
    <link rel="stylesheet" href="../assets/css/layout.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/utilities.css">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Configuration -->
    <script src="../config.js"></script>
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 class="page-title">Class Management</h1>
                    <p class="page-subtitle">Manage classes and student enrollments</p>
                </div>
                <button class="btn btn--primary" onclick="openAddClassModal()">
                    <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>
                    Create New Class
                </button>
            </div>
        </div>

        <div class="page-content">
            <!-- Class Selection and Stats -->
            <div class="card" style="margin-bottom: var(--spacing-6);">
                <div class="card__body">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--spacing-4); align-items: end;">
                        <div>
                            <label class="input-group__label">Select Class</label>
                            <div class="dropdown dropdown--block" id="classDropdown">
                                <button class="dropdown__trigger">
                                    <span id="selectedClassText">Select a class to manage</span>
                                    <span class="dropdown__arrow"></span>
                                </button>
                                <div class="dropdown__menu">
                                    <div class="dropdown__list" id="classList">
                                        <!-- Dynamic class list -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn--secondary" onclick="refreshData()">
                            <i class="fas fa-sync-alt" style="margin-right: 8px;"></i>
                            Refresh
                        </button>
                    </div>

                    <!-- Class Statistics -->
                    <div id="classStats" style="display: none; margin-top: var(--spacing-6);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-4);">
                            <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);" id="statEnrolled">0</div>
                                <p style="color: var(--text-secondary); margin: 0;">Enrolled Students</p>
                            </div>
                            <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);" id="statMax">0</div>
                                <p style="color: var(--text-secondary); margin: 0;">Max Capacity</p>
                            </div>
                            <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-warning);" id="statAvailable">0</div>
                                <p style="color: var(--text-secondary); margin: 0;">Available Seats</p>
                            </div>
                            <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-info);" id="statStatus">-</div>
                                <p style="color: var(--text-secondary); margin: 0;">Status</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Members Table -->
            <div class="card" id="membersCard" style="display: none;">
                <div class="card__header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card__title">Class Members</h3>
                        <div style="display: flex; gap: var(--spacing-2);">
                            <button class="btn btn--secondary btn--small" id="bulkActionsBtn" style="display: none;" onclick="showBulkActions()">
                                <i class="fas fa-list-check" style="margin-right: 8px;"></i>
                                <span id="selectedCount">0</span> Selected
                            </button>
                            <button class="btn btn--primary btn--small" onclick="openAddStudentModal()">
                                <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
                                Add Student
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card__body card__body--no-padding">
                    <div class="table-wrapper">
                        <table class="table" id="membersTable">
                            <thead>
                                <tr class="table__header">
                                    <th class="table__cell table__cell--header">
                                        <input type="checkbox" class="table__checkbox" id="selectAll">
                                    </th>
                                    <th class="table__cell table__cell--header">Student Name</th>
                                    <th class="table__cell table__cell--header">Username</th>
                                    <th class="table__cell table__cell--header">Email</th>
                                    <th class="table__cell table__cell--header table__cell--hide-mobile">Enrolled Date</th>
                                    <th class="table__cell table__cell--header table__cell--center">Status</th>
                                    <th class="table__cell table__cell--header table__cell--center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- All Classes Overview -->
            <div class="card" id="allClassesCard">
                <div class="card__header">
                    <h3 class="card__title">All Classes</h3>
                </div>
                <div class="card__body card__body--no-padding">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr class="table__header">
                                    <th class="table__cell table__cell--header">Class Name</th>
                                    <th class="table__cell table__cell--header">Teacher</th>
                                    <th class="table__cell table__cell--header table__cell--center">Students</th>
                                    <th class="table__cell table__cell--header">Schedule</th>
                                    <th class="table__cell table__cell--header table__cell--center">Status</th>
                                    <th class="table__cell table__cell--header table__cell--center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allClassesTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Class Modal -->
    <div class="modal-backdrop" id="classModalBackdrop">
        <div class="modal modal--medium" id="classModal">
            <div class="modal__header">
                <h2 class="modal__title" id="classModalTitle">Create New Class</h2>
                <button class="modal__close" onclick="closeClassModal()">×</button>
            </div>
            <div class="modal__body">
                <form id="classForm">
                    <input type="hidden" id="classId">
                    
                    <div class="input-group">
                        <label class="input-group__label input-group__label--required">Class Name</label>
                        <input type="text" class="input" id="className" name="className" required>
                    </div>

                    <div class="input-group">
                        <label class="input-group__label">Description</label>
                        <textarea class="input input--textarea" id="classDescription" name="classDescription" rows="3"></textarea>
                    </div>

                    <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="input-group">
                            <label class="input-group__label input-group__label--required">Teacher</label>
                            <div class="dropdown dropdown--block" id="teacherDropdown">
                                <button type="button" class="dropdown__trigger">
                                    <span id="selectedTeacher">Select teacher</span>
                                    <span class="dropdown__arrow"></span>
                                </button>
                                <div class="dropdown__menu">
                                    <div class="dropdown__list" id="teacherList">
                                        <!-- Dynamic teacher list -->
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="teacherId" name="teacherId" required>
                        </div>

                        <div class="input-group">
                            <label class="input-group__label input-group__label--required">Max Students</label>
                            <input type="number" class="input" id="maxStudents" name="maxStudents" min="1" max="100" value="30" required>
                        </div>
                    </div>

                    <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-4);">
                        <div class="input-group">
                            <label class="input-group__label input-group__label--required">Start Date</label>
                            <input type="date" class="input" id="startDate" name="startDate" required>
                        </div>

                        <div class="input-group">
                            <label class="input-group__label input-group__label--required">End Date</label>
                            <input type="date" class="input" id="endDate" name="endDate" required>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-group__label">Schedule</label>
                        <input type="text" class="input" id="schedule" name="schedule" placeholder="e.g., Monday, Wednesday, Friday - 10:00 AM">
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeClassModal()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    Cancel
                </button>
                <button class="btn btn--primary" onclick="saveClass()">
                    <i class="fas fa-save" style="margin-right: 8px;"></i>
                    Save Class
                </button>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal-backdrop" id="addStudentModalBackdrop">
        <div class="modal modal--medium" id="addStudentModal">
            <div class="modal__header">
                <h2 class="modal__title">Add Students to Class</h2>
                <button class="modal__close" onclick="closeAddStudentModal()">×</button>
            </div>
            <div class="modal__body">
                <div class="input-group">
                    <label class="input-group__label">Search Students</label>
                    <input type="text" class="input" id="studentSearch" placeholder="Search by name or username..." onkeyup="filterStudents()">
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; margin-top: var(--spacing-4);">
                    <div id="availableStudentsList">
                        <!-- Dynamic student list -->
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeAddStudentModal()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    Cancel
                </button>
                <button class="btn btn--primary" onclick="addSelectedStudents()">
                    <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
                    Add Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Class Management Modal -->
    <div class="modal-backdrop" id="classManagementModalBackdrop">
        <div class="modal modal--large" id="classManagementModal">
            <div class="modal__header">
                <h2 class="modal__title">Advanced Class Management - <span id="managementClassName"></span></h2>
                <button class="modal__close" onclick="closeClassManagementModal()">×</button>
            </div>
            <div class="modal__body">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tabs__list">
                        <button class="tabs__item tabs__item--active" data-tab="schedule">
                            <i class="fas fa-calendar-alt tabs__item-icon"></i>
                            Schedule
                        </button>
                        <button class="tabs__item" data-tab="attendance">
                            <i class="fas fa-clipboard-check tabs__item-icon"></i>
                            Attendance
                        </button>
                        <button class="tabs__item" data-tab="analytics">
                            <i class="fas fa-chart-line tabs__item-icon"></i>
                            Analytics
                        </button>
                        <button class="tabs__item" data-tab="communication">
                            <i class="fas fa-comments tabs__item-icon"></i>
                            Communication
                        </button>
                    </div>
                    
                    <!-- Schedule Tab -->
                    <div class="tabs__content">
                        <div class="tabs__panel tabs__panel--active" id="schedule-tab">
                        <div class="card">
                            <div class="card__header">
                                <h4 class="card__title">Weekly Schedule</h4>
                                <button class="btn btn--primary btn--small" onclick="addScheduleItem()">
                                    <i class="fas fa-plus"></i> Add Session
                                </button>
                            </div>
                            <div class="card__body">
                                <div id="scheduleList">
                                    <!-- Dynamic schedule items -->
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Tab -->
                    <div class="tabs__panel" id="attendance-tab">
                        <div class="card">
                            <div class="card__header">
                                <h4 class="card__title">Attendance Tracking</h4>
                                <button class="btn btn--primary btn--small" onclick="takeAttendance()">
                                    <i class="fas fa-check-circle"></i> Take Attendance
                                </button>
                            </div>
                            <div class="card__body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6);">
                                    <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);" id="attendanceRate">0%</div>
                                        <p style="color: var(--text-secondary); margin: 0;">Average Attendance</p>
                                    </div>
                                    <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);" id="totalSessions">0</div>
                                        <p style="color: var(--text-secondary); margin: 0;">Total Sessions</p>
                                    </div>
                                </div>
                                <div id="attendanceHistory">
                                    <!-- Attendance history table -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics Tab -->
                    <div class="tabs__panel" id="analytics-tab">
                        <div class="card">
                            <div class="card__header">
                                <h4 class="card__title">Class Performance Analytics</h4>
                            </div>
                            <div class="card__body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-4); margin-bottom: var(--spacing-6);">
                                    <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success);" id="avgGrade">A</div>
                                        <p style="color: var(--text-secondary); margin: 0;">Average Grade</p>
                                    </div>
                                    <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);" id="completionRate">85%</div>
                                        <p style="color: var(--text-secondary); margin: 0;">Completion Rate</p>
                                    </div>
                                    <div style="text-align: center; padding: var(--spacing-4); background: var(--bg-secondary); border-radius: var(--radius-base);">
                                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-warning);" id="participationRate">92%</div>
                                        <p style="color: var(--text-secondary); margin: 0;">Participation Rate</p>
                                    </div>
                                </div>
                                <div id="performanceChart" style="background: var(--bg-secondary); padding: var(--spacing-4); border-radius: var(--radius-base); height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                                    <div style="text-align: center;">
                                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: var(--spacing-4);"></i>
                                        <p>Performance chart will be displayed here</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Communication Tab -->
                    <div class="tabs__panel" id="communication-tab">
                        <div class="card">
                            <div class="card__header">
                                <h4 class="card__title">Class Communication</h4>
                            </div>
                            <div class="card__body">
                                <form id="classMessageForm">
                                    <div class="input-group">
                                        <label class="input-group__label">Message Type</label>
                                        <div class="dropdown dropdown--block">
                                            <button type="button" class="dropdown__trigger">
                                                <span id="messageTypeText">Announcement</span>
                                                <span class="dropdown__arrow"></span>
                                            </button>
                                            <div class="dropdown__menu">
                                                <div class="dropdown__list">
                                                    <div class="dropdown__item" data-value="announcement">
                                                        <i class="fas fa-bullhorn dropdown__item-icon"></i>
                                                        Announcement
                                                    </div>
                                                    <div class="dropdown__item" data-value="reminder">
                                                        <i class="fas fa-bell dropdown__item-icon"></i>
                                                        Reminder
                                                    </div>
                                                    <div class="dropdown__item" data-value="assignment">
                                                        <i class="fas fa-tasks dropdown__item-icon"></i>
                                                        Assignment
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="input-group__label">Subject</label>
                                        <input type="text" class="input" id="messageSubject" placeholder="Enter message subject...">
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="input-group__label">Message</label>
                                        <textarea class="input input--textarea" id="messageContent" rows="4" placeholder="Enter your message..."></textarea>
                                    </div>
                                    
                                    <div style="display: flex; gap: var(--spacing-3);">
                                        <button type="button" class="btn btn--primary" onclick="sendClassMessage()">
                                            <i class="fas fa-paper-plane" style="margin-right: 8px;"></i>
                                            Send to All Students
                                        </button>
                                        <button type="button" class="btn btn--secondary" onclick="previewMessage()">
                                            <i class="fas fa-eye" style="margin-right: 8px;"></i>
                                            Preview
                                        </button>
                                    </div>
                                </form>
                                
                                <div style="margin-top: var(--spacing-6);">
                                    <h4 style="margin-bottom: var(--spacing-4);">Recent Messages</h4>
                                    <div id="recentMessages">
                                        <!-- Recent messages list -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeClassManagementModal()">
                    <i class="fas fa-times" style="margin-right: 8px;"></i>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div class="modal-backdrop" id="bulkActionsModalBackdrop">
        <div class="modal modal--small" id="bulkActionsModal">
            <div class="modal__header">
                <h2 class="modal__title">Bulk Actions</h2>
                <button class="modal__close" onclick="closeBulkActionsModal()">×</button>
            </div>
            <div class="modal__body">
                <p style="margin-bottom: var(--spacing-4);">Choose an action to apply to <strong id="bulkSelectedCount">0</strong> selected students:</p>
                <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
                    <button class="btn btn--secondary btn--block" onclick="bulkSendMessage()">
                        <i class="fas fa-envelope" style="margin-right: 8px;"></i>
                        Send Message
                    </button>
                    <button class="btn btn--secondary btn--block" onclick="bulkExportData()">
                        <i class="fas fa-download" style="margin-right: 8px;"></i>
                        Export Data
                    </button>
                    <button class="btn btn--danger btn--block" onclick="bulkRemoveStudents()">
                        <i class="fas fa-user-minus" style="margin-right: 8px;"></i>
                        Remove from Class
                    </button>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeBulkActionsModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div class="modal-backdrop" id="attendanceModalBackdrop">
        <div class="modal modal--medium" id="attendanceModal">
            <div class="modal__header">
                <h2 class="modal__title">Take Attendance - <span id="attendanceDate"></span></h2>
                <button class="modal__close" onclick="closeAttendanceModal()">×</button>
            </div>
            <div class="modal__body">
                <div class="input-group">
                    <label class="input-group__label">Session Date & Time</label>
                    <input type="datetime-local" class="input" id="sessionDateTime" value="">
                </div>
                
                <div style="margin-top: var(--spacing-4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-3);">
                        <h4>Student List</h4>
                        <div style="display: flex; gap: var(--spacing-2);">
                            <button class="btn btn--secondary btn--small" onclick="markAllPresent()">
                                <i class="fas fa-check-double"></i> Mark All Present
                            </button>
                            <button class="btn btn--secondary btn--small" onclick="markAllAbsent()">
                                <i class="fas fa-times-circle"></i> Mark All Absent
                            </button>
                        </div>
                    </div>
                    <div id="attendanceList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Student attendance list -->
                    </div>
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn--secondary" onclick="closeAttendanceModal()">
                    Cancel
                </button>
                <button class="btn btn--primary" onclick="saveAttendance()">
                    <i class="fas fa-save" style="margin-right: 8px;"></i>
                    Save Attendance
                </button>
            </div>
        </div>
    </div>

    <script src="../assets/js/global.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
        // State management
        let allClasses = [];
        let allUsers = [];
        let selectedClass = null;
        let selectedStudents = new Set();

        // Load initial data
        async function loadData() {
            try {
                // Load classes
                const classResponse = await fetch('../data/mock-classes.json');
                const classData = await classResponse.json();
                allClasses = classData.data || [];

                // Load users
                const userResponse = await fetch('../data/mock-users.json');
                const userData = await userResponse.json();
                allUsers = userData.data || [];

                // Merge with localStorage data
                const storedClasses = JSON.parse(localStorage.getItem('lms-classes') || '[]');
                storedClasses.forEach(cls => {
                    if (!allClasses.find(c => c.id === cls.id)) {
                        allClasses.push(cls);
                    }
                });

                renderClassDropdown();
                renderAllClassesTable();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Render class dropdown
        function renderClassDropdown() {
            const classList = document.getElementById('classList');
            classList.innerHTML = allClasses.map(cls => `
                <div class="dropdown__item" data-value="${cls.id}">
                    <div style="flex: 1;">
                        <div class="dropdown__item-text">${cls.name}</div>
                        <div class="dropdown__item-meta">${cls.teacherName} • ${cls.enrolledStudents} students</div>
                    </div>
                </div>
            `).join('');
        }

        // Render all classes table
        function renderAllClassesTable() {
            const tbody = document.getElementById('allClassesTableBody');
            
            if (allClasses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="table__empty">
                            <div class="table__empty-icon">🏫</div>
                            <div class="table__empty-text">No classes found</div>
                            <div class="table__empty-subtext">Create your first class to get started</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = allClasses.map(cls => `
                    <tr class="table__row">
                        <td class="table__cell">${cls.name}</td>
                        <td class="table__cell">${cls.teacherName}</td>
                        <td class="table__cell table__cell--center">${cls.enrolledStudents}/${cls.maxStudents}</td>
                        <td class="table__cell">${cls.schedule || '-'}</td>
                        <td class="table__cell table__cell--center">
                            ${getStatusBadge(cls.status)}
                        </td>
                        <td class="table__cell table__cell--center">
                            <button class="btn btn--ghost btn--small" onclick="openClassManagementModal('${cls.id}')" title="Advanced Management">
                                <i class="fas fa-tasks"></i>
                            </button>
                            <button class="btn btn--ghost btn--small" onclick="selectClass('${cls.id}')" title="View Members">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn--ghost btn--small" onclick="editClass('${cls.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                active: '<span class="badge badge--active">Active</span>',
                upcoming: '<span class="badge badge--warning">Upcoming</span>',
                completed: '<span class="badge badge--secondary">Completed</span>'
            };
            return badges[status] || `<span class="badge badge--secondary">${capitalize(status)}</span>`;
        }

        // Select class to manage
        function selectClass(classId) {
            selectedClass = allClasses.find(c => c.id === classId);
            if (!selectedClass) return;

            // Update dropdown
            document.getElementById('selectedClassText').textContent = selectedClass.name;
            document.getElementById('classDropdown').classList.remove('active');

            // Show class stats
            document.getElementById('classStats').style.display = 'block';
            document.getElementById('statEnrolled').textContent = selectedClass.enrolledStudents;
            document.getElementById('statMax').textContent = selectedClass.maxStudents;
            document.getElementById('statAvailable').textContent = selectedClass.maxStudents - selectedClass.enrolledStudents;
            document.getElementById('statStatus').textContent = capitalize(selectedClass.status);

            // Show members card, hide all classes
            document.getElementById('membersCard').style.display = 'block';
            document.getElementById('allClassesCard').style.display = 'none';

            // Load class members
            loadClassMembers();
        }

        // Load class members
        function loadClassMembers() {
            if (!selectedClass) return;

            const members = allUsers.filter(u => selectedClass.students.includes(u.id));
            const tbody = document.getElementById('membersTableBody');

            if (members.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="table__empty">
                            <div class="table__empty-icon">👥</div>
                            <div class="table__empty-text">No students enrolled</div>
                            <div class="table__empty-subtext">Add students to this class</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = members.map(student => `
                    <tr class="table__row">
                        <td class="table__cell table__cell--center">
                            <input type="checkbox" class="table__checkbox" data-id="${student.id}">
                        </td>
                        <td class="table__cell">${student.fullName}</td>
                        <td class="table__cell">${student.username}</td>
                        <td class="table__cell">${student.email}</td>
                        <td class="table__cell table__cell--hide-mobile">${new Date(student.createdAt).toLocaleDateString()}</td>
                        <td class="table__cell table__cell--center">
                            ${student.isActive 
                                ? '<span class="badge badge--active">Active</span>' 
                                : '<span class="badge badge--inactive">Inactive</span>'}
                        </td>
                        <td class="table__cell table__cell--center">
                            <button class="btn btn--ghost btn--small" onclick="removeStudent('${student.id}')" title="Remove Student">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Create/Edit class modal
        function openAddClassModal() {
            document.getElementById('classModalTitle').textContent = 'Create New Class';
            document.getElementById('classForm').reset();
            document.getElementById('classId').value = '';
            
            // Load teachers
            loadTeachers();
            
            document.getElementById('classModalBackdrop').classList.add('active');
            document.getElementById('classModal').classList.add('active');
        }

        function editClass(classId) {
            const cls = allClasses.find(c => c.id === classId);
            if (!cls) return;

            document.getElementById('classModalTitle').textContent = 'Edit Class';
            document.getElementById('classId').value = cls.id;
            document.getElementById('className').value = cls.name;
            document.getElementById('classDescription').value = cls.description || '';
            document.getElementById('teacherId').value = cls.teacherId;
            document.getElementById('selectedTeacher').textContent = cls.teacherName;
            document.getElementById('maxStudents').value = cls.maxStudents;
            document.getElementById('startDate').value = cls.startDate.split('T')[0];
            document.getElementById('endDate').value = cls.endDate.split('T')[0];
            document.getElementById('schedule').value = cls.schedule || '';

            loadTeachers();

            document.getElementById('classModalBackdrop').classList.add('active');
            document.getElementById('classModal').classList.add('active');
        }

        function loadTeachers() {
            const teachers = allUsers.filter(u => u.role === 'teacher');
            const teacherList = document.getElementById('teacherList');
            
            teacherList.innerHTML = teachers.map(teacher => `
                <div class="dropdown__item" data-value="${teacher.id}" data-name="${teacher.fullName}">
                    <span class="dropdown__item-icon">👨‍🏫</span>
                    <div style="flex: 1;">
                        <div class="dropdown__item-text">${teacher.fullName}</div>
                        <div class="dropdown__item-meta">${teacher.email}</div>
                    </div>
                </div>
            `).join('');
        }

        function closeClassModal() {
            document.getElementById('classModalBackdrop').classList.remove('active');
            document.getElementById('classModal').classList.remove('active');
        }

        async function saveClass() {
            const form = document.getElementById('classForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const classId = document.getElementById('classId').value;
            const classData = {
                id: classId || 'class_' + Date.now(),
                name: document.getElementById('className').value,
                description: document.getElementById('classDescription').value,
                teacherId: document.getElementById('teacherId').value,
                teacherName: document.getElementById('selectedTeacher').textContent,
                maxStudents: parseInt(document.getElementById('maxStudents').value),
                enrolledStudents: classId ? allClasses.find(c => c.id === classId).enrolledStudents : 0,
                startDate: document.getElementById('startDate').value + 'T00:00:00Z',
                endDate: document.getElementById('endDate').value + 'T00:00:00Z',
                schedule: document.getElementById('schedule').value,
                status: 'active',
                students: classId ? allClasses.find(c => c.id === classId).students : [],
                createdAt: classId ? allClasses.find(c => c.id === classId).createdAt : new Date().toISOString()
            };

            if (classId) {
                // Update existing class
                const index = allClasses.findIndex(c => c.id === classId);
                if (index !== -1) {
                    allClasses[index] = { ...allClasses[index], ...classData };
                }
            } else {
                // Add new class
                allClasses.push(classData);
            }

            // Save to localStorage
            localStorage.setItem('lms-classes', JSON.stringify(allClasses));

            closeClassModal();
            loadData();

            alert(classId ? 'Class updated successfully!' : 'Class created successfully!');
        }

        // Add student modal
        function openAddStudentModal() {
            if (!selectedClass) return;

            selectedStudents.clear();
            loadAvailableStudents();

            document.getElementById('addStudentModalBackdrop').classList.add('active');
            document.getElementById('addStudentModal').classList.add('active');
        }

        function loadAvailableStudents() {
            const students = allUsers.filter(u => 
                u.role === 'student' && 
                u.isActive &&
                !selectedClass.students.includes(u.id)
            );

            const listContainer = document.getElementById('availableStudentsList');
            
            if (students.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-6); color: var(--text-muted);">
                        No available students to add
                    </div>
                `;
            } else {
                listContainer.innerHTML = students.map(student => `
                    <label class="dropdown__item" style="cursor: pointer;">
                        <input type="checkbox" class="dropdown__checkbox" value="${student.id}" onchange="toggleStudent('${student.id}')">
                        <div style="flex: 1;">
                            <div class="dropdown__item-text">${student.fullName}</div>
                            <div class="dropdown__item-meta">${student.username} • ${student.email}</div>
                        </div>
                    </label>
                `).join('');
            }
        }

        function filterStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const items = document.querySelectorAll('#availableStudentsList .dropdown__item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function toggleStudent(studentId) {
            if (selectedStudents.has(studentId)) {
                selectedStudents.delete(studentId);
            } else {
                selectedStudents.add(studentId);
            }
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModalBackdrop').classList.remove('active');
            document.getElementById('addStudentModal').classList.remove('active');
        }

        function addSelectedStudents() {
            if (selectedStudents.size === 0) {
                alert('Please select at least one student');
                return;
            }

            // Add students to class
            selectedStudents.forEach(studentId => {
                if (!selectedClass.students.includes(studentId)) {
                    selectedClass.students.push(studentId);
                    selectedClass.enrolledStudents++;
                }
            });

            // Update class in array
            const index = allClasses.findIndex(c => c.id === selectedClass.id);
            if (index !== -1) {
                allClasses[index] = selectedClass;
            }

            // Save to localStorage
            localStorage.setItem('lms-classes', JSON.stringify(allClasses));

            closeAddStudentModal();
            selectClass(selectedClass.id);

            alert(`${selectedStudents.size} student(s) added successfully!`);
        }

        function removeStudent(studentId) {
            if (!confirm('Are you sure you want to remove this student from the class?')) {
                return;
            }

            selectedClass.students = selectedClass.students.filter(id => id !== studentId);
            selectedClass.enrolledStudents--;

            // Update class in array
            const index = allClasses.findIndex(c => c.id === selectedClass.id);
            if (index !== -1) {
                allClasses[index] = selectedClass;
            }

            // Save to localStorage
            localStorage.setItem('lms-classes', JSON.stringify(allClasses));

            selectClass(selectedClass.id);
            alert('Student removed from class');
        }

        // Utility functions
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function refreshData() {
            loadData();
            if (selectedClass) {
                selectClass(selectedClass.id);
            }
        }

        // Setup dropdowns
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const trigger = dropdown.querySelector('.dropdown__trigger');
            trigger.addEventListener('click', function(e) {
                e.preventDefault();
                dropdown.classList.toggle('active');
            });

            dropdown.querySelectorAll('.dropdown__item').forEach(item => {
                item.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.querySelector('.dropdown__item-text')?.textContent || this.textContent;
                    
                    if (dropdown.id === 'classDropdown') {
                        selectClass(value);
                    } else if (dropdown.id === 'teacherDropdown') {
                        document.getElementById('teacherId').value = value;
                        document.getElementById('selectedTeacher').textContent = this.getAttribute('data-name') || text;
                    }
                    
                    dropdown.classList.remove('active');
                });
            });
        });

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown.active').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });

        // Teacher dropdown delegation
        document.getElementById('teacherList').addEventListener('click', function(e) {
            const item = e.target.closest('.dropdown__item');
            if (item) {
                const value = item.getAttribute('data-value');
                const name = item.getAttribute('data-name');
                document.getElementById('teacherId').value = value;
                document.getElementById('selectedTeacher').textContent = name;
                document.getElementById('teacherDropdown').classList.remove('active');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!LMS.Auth.hasRole('admin')) {
                alert('Access denied. Administrators only.');
                window.location.href = '../index.html';
                return;
            }

            loadData();
            initializeTabs();
            initializeCheckboxHandlers();
        });

        // Enhanced Class Management Functions
        let managedClass = null;
        let selectedMembers = new Set();

        function openClassManagementModal(classId) {
            managedClass = allClasses.find(c => c.id === classId);
            if (!managedClass) return;

            document.getElementById('managementClassName').textContent = managedClass.name;
            
            // Load data for each tab
            loadScheduleData();
            loadAttendanceData();
            loadAnalyticsData();
            loadRecentMessages();

            document.getElementById('classManagementModalBackdrop').classList.add('active');
            document.getElementById('classManagementModal').classList.add('active');
        }

        function closeClassManagementModal() {
            document.getElementById('classManagementModalBackdrop').classList.remove('active');
            document.getElementById('classManagementModal').classList.remove('active');
        }

        // Tab functionality
        function initializeTabs() {
            document.querySelectorAll('.tabs__item').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tabs__item').forEach(t => t.classList.remove('tabs__item--active'));
                    this.classList.add('tabs__item--active');
                    
                    // Update active content
                    document.querySelectorAll('.tabs__panel').forEach(panel => panel.classList.remove('tabs__panel--active'));
                    document.getElementById(tabName + '-tab').classList.add('tabs__panel--active');
                });
            });
        }

        // Schedule Management
        function loadScheduleData() {
            const scheduleList = document.getElementById('scheduleList');
            const schedule = managedClass.schedule ? managedClass.schedule.split(',') : [];
            
            if (schedule.length === 0 || (schedule.length === 1 && schedule[0] === '')) {
                scheduleList.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-6); color: var(--text-muted);">
                        <i class="fas fa-calendar-times" style="font-size: 48px; margin-bottom: var(--spacing-3);"></i>
                        <p>No schedule defined yet</p>
                    </div>
                `;
            } else {
                scheduleList.innerHTML = schedule.map((item, index) => `
                    <div class="card" style="margin-bottom: var(--spacing-3);">
                        <div class="card__body" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <i class="fas fa-clock" style="margin-right: 8px; color: var(--color-primary);"></i>
                                ${item.trim()}
                            </div>
                            <button class="btn btn--ghost btn--small" onclick="removeScheduleItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function addScheduleItem() {
            const newSchedule = prompt('Enter schedule (e.g., Monday 10:00 AM - 12:00 PM):');
            if (newSchedule) {
                const currentSchedule = managedClass.schedule ? managedClass.schedule.split(',') : [];
                currentSchedule.push(newSchedule);
                managedClass.schedule = currentSchedule.join(', ');
                
                // Update in array and save
                const index = allClasses.findIndex(c => c.id === managedClass.id);
                if (index !== -1) {
                    allClasses[index] = managedClass;
                    localStorage.setItem('lms-classes', JSON.stringify(allClasses));
                }
                
                loadScheduleData();
            }
        }

        function removeScheduleItem(index) {
            const currentSchedule = managedClass.schedule.split(',');
            currentSchedule.splice(index, 1);
            managedClass.schedule = currentSchedule.join(', ');
            
            // Update in array and save
            const classIndex = allClasses.findIndex(c => c.id === managedClass.id);
            if (classIndex !== -1) {
                allClasses[classIndex] = managedClass;
                localStorage.setItem('lms-classes', JSON.stringify(allClasses));
            }
            
            loadScheduleData();
        }

        // Attendance Management
        function loadAttendanceData() {
            // Load attendance history from localStorage
            const attendanceData = JSON.parse(localStorage.getItem('lms-attendance') || '{}');
            const classAttendance = attendanceData[managedClass.id] || [];
            
            // Calculate statistics
            const totalSessions = classAttendance.length;
            let totalAttendanceRate = 0;
            
            if (totalSessions > 0) {
                classAttendance.forEach(session => {
                    const presentCount = Object.values(session.attendance).filter(status => status === 'present').length;
                    totalAttendanceRate += (presentCount / Object.keys(session.attendance).length) * 100;
                });
                totalAttendanceRate = Math.round(totalAttendanceRate / totalSessions);
            }
            
            document.getElementById('attendanceRate').textContent = totalAttendanceRate + '%';
            document.getElementById('totalSessions').textContent = totalSessions;
            
            // Display attendance history
            const historyDiv = document.getElementById('attendanceHistory');
            if (classAttendance.length === 0) {
                historyDiv.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-6); color: var(--text-muted);">
                        <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: var(--spacing-3);"></i>
                        <p>No attendance records yet</p>
                    </div>
                `;
            } else {
                historyDiv.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr class="table__header">
                                <th class="table__cell table__cell--header">Date</th>
                                <th class="table__cell table__cell--header">Time</th>
                                <th class="table__cell table__cell--header table__cell--center">Present</th>
                                <th class="table__cell table__cell--header table__cell--center">Absent</th>
                                <th class="table__cell table__cell--header table__cell--center">Attendance Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${classAttendance.map(session => {
                                const present = Object.values(session.attendance).filter(s => s === 'present').length;
                                const absent = Object.values(session.attendance).filter(s => s === 'absent').length;
                                const rate = Math.round((present / (present + absent)) * 100);
                                return `
                                    <tr class="table__row">
                                        <td class="table__cell">${new Date(session.date).toLocaleDateString()}</td>
                                        <td class="table__cell">${new Date(session.date).toLocaleTimeString()}</td>
                                        <td class="table__cell table__cell--center">${present}</td>
                                        <td class="table__cell table__cell--center">${absent}</td>
                                        <td class="table__cell table__cell--center">
                                            <span class="badge ${rate >= 80 ? 'badge--active' : rate >= 60 ? 'badge--warning' : 'badge--danger'}">
                                                ${rate}%
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }
        }

        function takeAttendance() {
            const now = new Date();
            document.getElementById('attendanceDate').textContent = now.toLocaleDateString();
            document.getElementById('sessionDateTime').value = now.toISOString().slice(0, 16);
            
            // Load student list for attendance
            const members = allUsers.filter(u => managedClass.students.includes(u.id));
            const attendanceList = document.getElementById('attendanceList');
            
            attendanceList.innerHTML = members.map(student => `
                <div class="card" style="margin-bottom: var(--spacing-2);">
                    <div class="card__body" style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-3);">
                        <div>
                            <strong>${student.fullName}</strong>
                            <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${student.username}</div>
                        </div>
                        <div style="display: flex; gap: var(--spacing-2);">
                            <label class="radio-group">
                                <input type="radio" name="attendance_${student.id}" value="present" checked>
                                <span class="radio-group__label">Present</span>
                            </label>
                            <label class="radio-group">
                                <input type="radio" name="attendance_${student.id}" value="absent">
                                <span class="radio-group__label">Absent</span>
                            </label>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('attendanceModalBackdrop').classList.add('active');
            document.getElementById('attendanceModal').classList.add('active');
        }

        function closeAttendanceModal() {
            document.getElementById('attendanceModalBackdrop').classList.remove('active');
            document.getElementById('attendanceModal').classList.remove('active');
        }

        function markAllPresent() {
            document.querySelectorAll('input[type="radio"][value="present"]').forEach(radio => {
                radio.checked = true;
            });
        }

        function markAllAbsent() {
            document.querySelectorAll('input[type="radio"][value="absent"]').forEach(radio => {
                radio.checked = true;
            });
        }

        function saveAttendance() {
            const sessionDate = document.getElementById('sessionDateTime').value;
            const attendance = {};
            
            // Collect attendance data
            managedClass.students.forEach(studentId => {
                const radio = document.querySelector(`input[name="attendance_${studentId}"]:checked`);
                attendance[studentId] = radio ? radio.value : 'absent';
            });
            
            // Save to localStorage
            const attendanceData = JSON.parse(localStorage.getItem('lms-attendance') || '{}');
            if (!attendanceData[managedClass.id]) {
                attendanceData[managedClass.id] = [];
            }
            
            attendanceData[managedClass.id].push({
                date: sessionDate,
                attendance: attendance
            });
            
            localStorage.setItem('lms-attendance', JSON.stringify(attendanceData));
            
            closeAttendanceModal();
            loadAttendanceData();
            alert('Attendance saved successfully!');
        }

        // Analytics
        function loadAnalyticsData() {
            // This would typically calculate real analytics from student performance data
            // For now, we'll use mock data
            document.getElementById('avgGrade').textContent = 'B+';
            document.getElementById('completionRate').textContent = '87%';
            document.getElementById('participationRate').textContent = '92%';
        }

        // Communication
        function loadRecentMessages() {
            const messages = JSON.parse(localStorage.getItem('lms-class-messages') || '{}');
            const classMessages = messages[managedClass.id] || [];
            
            const recentMessagesDiv = document.getElementById('recentMessages');
            if (classMessages.length === 0) {
                recentMessagesDiv.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-4); color: var(--text-muted);">
                        No messages sent yet
                    </div>
                `;
            } else {
                recentMessagesDiv.innerHTML = classMessages.slice(-5).reverse().map(msg => `
                    <div class="card" style="margin-bottom: var(--spacing-3);">
                        <div class="card__body">
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-2);">
                                <strong>${msg.subject}</strong>
                                <span style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                    ${new Date(msg.date).toLocaleDateString()}
                                </span>
                            </div>
                            <p style="margin: 0; color: var(--text-secondary);">${msg.content}</p>
                            <div style="margin-top: var(--spacing-2);">
                                <span class="badge badge--secondary">${msg.type}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function sendClassMessage() {
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;
            const type = document.getElementById('messageTypeText').textContent.toLowerCase();
            
            if (!subject || !content) {
                alert('Please fill in all fields');
                return;
            }
            
            // Save message to localStorage
            const messages = JSON.parse(localStorage.getItem('lms-class-messages') || '{}');
            if (!messages[managedClass.id]) {
                messages[managedClass.id] = [];
            }
            
            messages[managedClass.id].push({
                id: 'msg_' + Date.now(),
                subject: subject,
                content: content,
                type: type,
                date: new Date().toISOString(),
                recipients: managedClass.students
            });
            
            localStorage.setItem('lms-class-messages', JSON.stringify(messages));
            
            // Clear form
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageContent').value = '';
            
            loadRecentMessages();
            alert('Message sent to all students!');
        }

        function previewMessage() {
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;
            
            if (!subject || !content) {
                alert('Please fill in all fields to preview');
                return;
            }
            
            alert(`Preview:\n\nSubject: ${subject}\n\nMessage:\n${content}`);
        }

        // Bulk Operations
        function initializeCheckboxHandlers() {
            // Select all checkbox
            document.getElementById('selectAll')?.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#membersTableBody .table__checkbox');
                checkboxes.forEach(cb => cb.checked = this.checked);
                updateSelectedCount();
            });
            
            // Individual checkboxes
            document.addEventListener('change', function(e) {
                if (e.target.matches('#membersTableBody .table__checkbox')) {
                    updateSelectedCount();
                }
            });
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('#membersTableBody .table__checkbox:checked');
            selectedMembers.clear();
            checked.forEach(cb => selectedMembers.add(cb.getAttribute('data-id')));
            
            const count = selectedMembers.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkActionsBtn').style.display = count > 0 ? '' : 'none';
        }

        function showBulkActions() {
            document.getElementById('bulkSelectedCount').textContent = selectedMembers.size;
            document.getElementById('bulkActionsModalBackdrop').classList.add('active');
            document.getElementById('bulkActionsModal').classList.add('active');
        }

        function closeBulkActionsModal() {
            document.getElementById('bulkActionsModalBackdrop').classList.remove('active');
            document.getElementById('bulkActionsModal').classList.remove('active');
        }

        function bulkSendMessage() {
            alert(`Send message feature for ${selectedMembers.size} students - Coming soon!`);
            closeBulkActionsModal();
        }

        function bulkExportData() {
            // Create CSV data
            const members = allUsers.filter(u => selectedMembers.has(u.id));
            const csv = [
                ['Name', 'Username', 'Email', 'Status'],
                ...members.map(m => [m.fullName, m.username, m.email, m.isActive ? 'Active' : 'Inactive'])
            ].map(row => row.join(',')).join('\n');
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `class_${selectedClass.name}_students.csv`;
            a.click();
            
            closeBulkActionsModal();
        }

        function bulkRemoveStudents() {
            if (!confirm(`Are you sure you want to remove ${selectedMembers.size} students from the class?`)) {
                return;
            }
            
            selectedClass.students = selectedClass.students.filter(id => !selectedMembers.has(id));
            selectedClass.enrolledStudents = selectedClass.students.length;
            
            // Update class in array
            const index = allClasses.findIndex(c => c.id === selectedClass.id);
            if (index !== -1) {
                allClasses[index] = selectedClass;
            }
            
            // Save to localStorage
            localStorage.setItem('lms-classes', JSON.stringify(allClasses));
            
            closeBulkActionsModal();
            selectClass(selectedClass.id);
            alert(`${selectedMembers.size} students removed from class`);
        }

        // Message type dropdown
        document.addEventListener('click', function(e) {
            const item = e.target.closest('#communication-tab .dropdown__item');
            if (item) {
                const value = item.getAttribute('data-value');
                const text = item.textContent.trim();
                document.getElementById('messageTypeText').textContent = text;
                item.closest('.dropdown').classList.remove('active');
            }
        });
    </script>
</body>
</html>
